!function(){"use strict";"0.4.3";function t(){var t=window.maptalks;e.noConflict=function(){return window.maptalks=t,this},window.maptalks=e}var e={};e.node=function(){return"undefined"!=typeof module&&module.exports}(),e.node?e.Browser={canvas:!0}:!function(){var t=navigator.userAgent.toLowerCase(),i=document.documentElement,n="ActiveXObject"in window,r=-1!==t.indexOf("webkit"),o=-1!==t.indexOf("phantom"),s=-1!==t.search("android [23]"),a=-1!==t.indexOf("chrome"),h=-1!==t.indexOf("gecko")&&!r&&!window.opera&&!n,l="undefined"!=typeof orientation||-1!==t.indexOf("mobile"),u=!window.PointerEvent&&window.MSPointerEvent,c=window.PointerEvent&&navigator.pointerEnabled||u,d=n&&"transition"in i.style,f="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!s,m="MozPerspective"in i.style,_="OTransition"in i.style,g=!window.L_DISABLE_3D&&(d||f||m)&&!_&&!o,p=!window.L_NO_TOUCH&&!o&&(c||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);e.Browser={ie:n,ielt9:n&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:r,gecko:h,android:-1!==t.indexOf("android"),android23:s,chrome:a,safari:!a&&-1!==t.indexOf("safari"),phantomjs:o,ie3d:d,webkit3d:f,gecko3d:m,opera12:_,any3d:g,mobile:l,mobileWebkit:l&&r,mobileWebkit3d:l&&f,mobileOpera:l&&window.opera,mobileGecko:l&&h,touch:!!p,msPointer:!!u,pointer:!!c,retina:(window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI)>1,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:n&&9===document.documentMode,ie10:n&&10===document.documentMode,canvas:!!document.createElement("canvas").getContext},e.Browser.translateDom=e.Browser.any3d&&!n}(),e.prefix="",e.node||!function(){for(var t=document.getElementsByTagName("head")[0],i=t.childNodes,n=null,r=0,o=i.length;o>r;r++)if("meta"===i[r].nodeName.toLowerCase()){var s=i[r].getAttribute?i[r].getAttribute("name"):null;"viewport"===s&&(n=i[r])}if(e.Browser.mobile)if(null===n)n=document.createElement("meta"),n.setAttribute("name","viewport"),n.setAttribute("content","user-scalable=no"),t.appendChild(n);else{var a=n.getAttribute("content");a.indexOf("user-scalable=no")<0&&n.setAttribute("content",a+",user-scalable=no")}if(e.Browser.ielt9){var h=document.createElement("meta");h.setAttribute("http-equiv","X-UA-Compatible"),h.setAttribute("content","IE=edge,chrome=1"),t.appendChild(h)}}(),e.Url=function(t){this.prefix=t;var e=this.prefix.split("/"),i=2;this.prefix.indexOf("http")<0&&(i=0);var n=e[i],r=n.split(":");this.host=r[0],r.length>1?this.port=r[1]:this.port=80},e.Url.prototype.getHost=function(){return this.host},e.Url.prototype.getPort=function(){return this.port},e.internalLayerPrefix="_maptalks__internal_layer_",e.Util={guid:0,now:function(){return Date.now?Date.now():(new Date).getTime()},extend:function(t){var e,i,n,r,o=Array.prototype.slice.call(arguments,1);for(i=0,n=o.length;n>i;i++){r=o[i]||{};for(e in r)r.hasOwnProperty(e)&&(t[e]=r[e])}return t},setOptions:function(t,i){t.hasOwnProperty("options")||(t.options=t.options?e.Util.create(t.options):{});for(var n in i)t.options[n]=i[n];return t.options},isSVG:function(t){var e="data:image/svg+xml";return t.length>4&&".svg"===t.substring(t.length-4)?1:t.substring(0,e.length)===e?2:0},loadImage:function(t,i){function n(e){e&&(console.error(e),console.error(e.stack));var i=t.onerror;i&&i.call(t)}function r(e,i){if(e)return void n(e);var r=t.onload;r&&(t.onload=function(){r.call(t)}),t.src=i}if(!e.node)return t.src=i[0],this;var o=i[0],s=i[1],a=i[2];try{e.Util.isSVG(o)?e.Util._convertSVG2PNG(o,s,a,r):e.Util.isURL(o)?this._loadRemoteImage(t,o,r):this._loadLocalImage(t,o,r)}catch(h){n(h)}return this},_loadRemoteImage:function(t,e,i){var n;n=0===e.indexOf("https://")?require("https"):require("http");var r=require("url").parse(e);r.headers={Accept:"image/*,*/*;q=0.8","Accept-Encoding":"gzip, deflate","Cache-Control":"no-cache",Connection:"keep-alive",Host:r.host,Pragma:"no-cache","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.94 Safari/537.36"},n.request(r,function(t){var e=[];t.on("data",function(t){e.push(t)}),t.on("end",function(){i(null,Buffer.concat(e))})}).on("error",i).end()},_loadLocalImage:function(t,e,i){require("fs").readFile(e,i)},_convertSVG2PNG:function(t,e,i,n){require("svg2img")(t,{width:e,height:i},n)},fixPNG:function(){},GUID:function(){return"___MAPTALKS_GLOBAL_"+e.Util.guid++},stamp:function(t){return t._maptalks_id=t._maptalks_id||e.Util.GUID(),t._maptalks_id},parseJSON:function(t){return t&&e.Util.isString(t)?JSON.parse(t):t},create:Object.create||function(){function t(){}return function(e){return t.prototype=e,new t}}(),bind:function(t,e){var i=Array.prototype.slice;if(t.bind)return t.bind.apply(t,i.call(arguments,1));var n=i.call(arguments,2);return function(){return t.apply(e,n.length?n.concat(i.call(arguments)):arguments)}},throttle:function(t,e,i){var n,r,o,s;return s=function(){n=!1,r&&(o.apply(i,r),r=!1)},o=function(){n?r=arguments:(t.apply(i,arguments),setTimeout(s,e),n=!0)}},removeFromArray:function(t,e){for(var i=e.length-1;i>=0;i--)if(e[i]===t)return e.splice(i,1);return null},mapArrayRecursively:function(t,i,n){if(!this.isArray(t))return null;for(var r,o,s=[],a=0,h=t.length;h>a;a++)r=t[a],e.Util.isNil(r)?s.push(null):e.Util.isArray(r)?s.push(e.Util.mapArrayRecursively(r,i,n)):(o=n?i.call(n,r):i(r),s.push(o));return s},mapArray:function(t,i,n){if(!this.isArray(t))return null;for(var r,o,s=[],a=0,h=t.length;h>a;a++)r=t[a],e.Util.isNil(r)?s.push(null):(o=n?i.call(n,r):i(r),s.push(o));return s},indexOfArray:function(t,i){if(!e.Util.isArrayHasData(i))return-1;for(var n=0,r=i.length;r>n;n++)if(i[n]===t)return n;return-1},objEqual:function(t,i){return e.Util._objEqual(t,i)},objDeepEqual:function(t,i){return e.Util._objEqual(t,i,!0)},_objEqual:function(t,i,n){function r(t){if(Object.keys)return Object.keys(t);var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return e}if(e.Util.isNil(t)||e.Util.isNil(i))return!1;if(t.prototype!==i.prototype)return!1;var o,s,a,h;try{o=r(t),s=r(i)}catch(l){return!1}if(o.length!==s.length)return!1;for(h=o.length-1;h>=0;h--)if(o[h]!==s[h])return!1;if(n)for(h=o.length-1;h>=0;h--)if(a=o[h],!e.Util.objEqual(t[a],i[a]))return!1;return!0},round:function(t){return t>0?.5+t<<0:t-.5<<0},isCoordinate:function(t){return t instanceof e.Coordinate},isNil:function(t){return"undefined"==typeof t||null===t},isNumber:function(t){return"number"==typeof t&&!isNaN(t)},isObject:function(t){return"object"==typeof t&&!!t},getValueOrDefault:function(t,i){return e.Util.isNil(t)?i:t},isArrayHasData:function(t){return this.isArray(t)&&t.length>0},isArray:function(t){return t?Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t):!1},isString:function(t){return e.Util.isNil(t)?!1:"string"==typeof t||null!==t.constructor&&t.constructor===String},isFunction:function(t){return this.isNil(t)?!1:"function"==typeof t||null!==t.constructor&&t.constructor===Function},isURL:function(t){return t?t.indexOf("http://")>=0||t.indexOf("https://")>=0||t.indexOf("blob:")>=0:!1},cssUrlReWithQuote:/^url\(([\'\"])(.+)\1\)$/i,cssUrlRe:/^url\(([^\'\"].*[^\'\"])\)$/i,isCssUrl:function(t){return e.Util.isString(t)?"http"===t.substring(0,4)?3:e.Util.cssUrlRe.test(t)?1:e.Util.cssUrlReWithQuote.test(t)?2:0:0},extractCssUrl:function(t){var i,n=e.Util.isCssUrl(t);return 3===n?t:1===n?(i=e.Util.cssUrlRe.exec(t),i[1]):2===n?(i=e.Util.cssUrlReWithQuote.exec(t),i[2]):t},b64chrs:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",btoa:function(t){if("undefined"!=typeof window&&window.btoa)return window.btoa(t);for(var i,n,r=String(t),o=0,s=e.Util.b64chrs,a="";r.charAt(0|o)||(s="=",o%1);a+=s.charAt(63&i>>8-o%1*8)){if(n=r.charCodeAt(o+=.75),n>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");i=i<<8|n}return a},globalEval:function(t){var e=document.createElement("script");e.text=t,document.head.appendChild(e).parentNode.removeChild(e)},globalScript:function(t){var e=document.createElement("script");e.type="text/javascript",e.src=t,document.head.appendChild(e)},decreaseSymbolOpacity:function(t,i){function n(t,i){var n=t.opacity;e.Util.isNil(n)?t.opacity=i:t.opacity*=i}if(e.Util.isArray(t))for(var r=0;r<t.length;r++)n(t[r],i);else n(t,i);return t},extendSymbol:function(t){var i=Array.prototype.slice.call(arguments,1);if(i&&i.length||(i=[{}]),e.Util.isArray(t)){var n,r,o,s,a,h,l=[];for(o=0,a=t.length;a>o;o++){for(n=t[o],r={},s=0,h=i.length;h>s;s++)e.Util.isArray(i[s])?e.Util.isNil(i[s][o])||e.Util.extend(r,n,i[s][o]):e.Util.extend(r,n,i[s]);l.push(r)}return l}return e.Util.extend.apply(e.Util,[{},t].concat(i))},computeDegree:function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.atan2(n,i)},isGradient:function(t){return t&&e.Util.isArrayHasData(t.colorStops)},getExternalResources:function(t){if(!t)return null;var i=t;e.Util.isArray(t)||(i=[t]);for(var n,r,o,s=[],a=e.Symbolizer.resourceProperties,h=i.length-1;h>=0;h--)if(t=i[h]){for(n=0;n<a.length;n++)r=t[a[n]],r&&(r.indexOf("url(")>=0&&(r=e.Util.extractCssUrl(r)),o=e.Symbolizer.resourceSizeProperties[n],s.push([r,t[o[0]],t[o[1]]]));"path"===t.markerType&&t.markerPath&&s.push([e.Geometry._getMarkerPathURL(t),t.markerWidth,t.markerHeight])}return s},convertResourceUrl:function(t){function i(t,e){var i=t.split("/"),n=e.split("/");if(0===e.indexOf("/"))return i.slice(0,3).join("/")+e;i.pop();for(var r=0;r<n.length;r++)"."!==n[r]&&(".."===n[r]?i.pop():i.push(n[r]));return i.join("/")}if(!t)return null;var n=e.Util.extend({},t);if(e.node)return n;for(var r,o=e.Symbolizer.resourceProperties,s=!1,a=0,h=o.length;h>a;a++)r=n[o[a]],r&&(s=!1,r.indexOf("url(")>=0&&(r=e.Util.extractCssUrl(r),s=!0),e.Util.isURL(r)||(r=i(location.href,r),n[o[a]]=s?'url("'+r+'")':r));return n}},function(){function t(t){var e=+new Date,i=Math.max(0,16-(e-o));return o=e+i,setTimeout(t,i)}function i(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}if(e.node)return e.Util.requestAnimFrame=function(t){return setTimeout(t,16)},void(e.Util.cancelAnimFrame=clearTimeout);var n,r,o=0;"undefined"!=typeof window?(n=window.requestAnimationFrame||i("RequestAnimationFrame")||t,r=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(n=t,r=function(t){clearTimeout(t)}),e.Util.requestAnimFrame=function(t){return n(t)},e.Util.cancelAnimFrame=function(t){t&&r(t)}}(),e.StringUtil={trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return e.StringUtil.trim(t).split(/\s+/)},stringLength:function(t,i){var n=e.StringUtil._getStrRuler();n.style.font=i,n.innerHTML=t;var r=new e.Size(n.clientWidth,n.clientHeight);return e.DomUtil.removeDomNode(n),r},_getStrRuler:function(){var t=document.createElement("span");return t.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(t),t},splitContent:function(t,e,i){for(var n=Math.ceil(e/i),r=e/t.length,o=Math.floor(i/r),s=[],a=0;n>a;a++)n-1>a?s.push(t.substring(a*o,(a+1)*o)):s.push(t.substring(a*o));return s},replaceVariable:function(t,i){return e.Util.isObject(i)&&e.Util.isString(t)?t.replace(e.StringUtil._contentExpRe,function(t,n){var r=i[n];return e.Util.isNil(r)?t:r}):t},_contentExpRe:/\{([\w_]+)\}/g,splitTextToRow:function(t,i){var n=e.symbolizer.TextMarkerSymbolizer.getFont(i),r=e.Util.getValueOrDefault(i.textLineSpacing,0),o=e.StringUtil.stringLength(t,n),s=o.width,a=o.height,h=e.Util.getValueOrDefault(i.textWrapCharacter,null),l=i.textWrapWidth;(!l||l>s)&&(l=s);var u=[];e.Util.isString(t)||(t+="");var c,d,f,m=0;if(h&&t.indexOf(h)>=0){var _=t.split(h);for(d=0,f=_.length;f>d;d++){var g=_[d],p=e.StringUtil.stringLength(g,n),y=p.width;if(y>l)for(var v=e.StringUtil.splitContent(g,y,l),x=0;x<v.length;x++)c=e.StringUtil.stringLength(v[x],n),c.width>m&&(m=c.width),u.push({text:v[x],size:c});else p.width>m&&(m=p.width),u.push({text:g,size:p})}}else if(s>l){var w=e.StringUtil.splitContent(t,s,l);for(d=0;d<w.length;d++)c=e.StringUtil.stringLength(w[d],n),c.width>m&&(m=c.width),u.push({text:w[d],size:c})}else o.width>m&&(m=o.width),u.push({text:t,size:o});var C=u.length,b=new e.Size(m,a*C+r*(C-1));return{total:C,size:b,rows:u,rawSize:o}},getAlignPoint:function(t,i,n){var r,o,s=t.width,a=t.height;return"left"===i?r=-s:"middle"===i?r=-s/2:"right"===i&&(r=0),"top"===n?o=-a:"middle"===n?o=-a/2:"bottom"===n&&(o=0),new e.Point(r,o)}},e.DomUtil={createEl:function(t,i){var n=document.createElement(t);return i&&e.DomUtil.setClass(n,i),n},createElOn:function(t,e,i){var n=this.createEl(t);return e&&this.setStyle(n,e),i&&i.appendChild(n),n},removeDomNode:function(t){if(t)if(e.Browser.ielt9||e.Browser.ie9){var i=e.DomUtil.createEl("div");i.appendChild(t),i.innerHTML="",i=null}else t.parentNode&&t.parentNode.removeChild(t)},addDomEvent:function(t,i,n,r){if(!t||!i||!n)return e.DomUtil;for(var o=function(e){return e||(e=window.event),n.call(r||t,e)},s=i.split(" "),a=s.length-1;a>=0;a--){var h=s[a];if(h){t["Z__"+h]||(t["Z__"+h]=[]);var l=e.DomUtil.listensDomEvent(t,h,n);l>=0&&e.DomUtil.removeDomEvent(t,h,n),t["Z__"+h].push({callback:o,src:n}),"addEventListener"in t?("mousewheel"===h&&void 0!==document.mozHidden&&(h="DOMMouseScroll"),t.addEventListener(h,o,!1)):"attachEvent"in t&&t.attachEvent("on"+h,o)}}return e.DomUtil},removeDomEvent:function(t,e,i){function n(e,i){"removeEventListener"in t?("mousewheel"===e&&void 0!==document.mozHidden&&(e="DOMMouseScroll"),t.removeEventListener(e,i,!1)):"detachEvent"in t&&t.detachEvent("on"+e,i)}if(!t||!e)return this;for(var r=e.split(" "),o=r.length-1;o>=0;o--){var s=r[o];if(s){if(!i&&t["Z__"+s]){for(var a=t["Z__"+s],h=0,l=a.length;l>h;h++)n(a[h].callback);return delete t["Z__"+s],this}var u=this.listensDomEvent(t,s,i);if(0>u)return this;var c=t["Z__"+s][u];n(s,c.callback),t["Z__"+s].splice(u,1)}}return this},listensDomEvent:function(t,e,i){if(!t||!t["Z__"+e]||!i)return-1;for(var n=t["Z__"+e],r=0,o=n.length;o>r;r++)if(n[r].src===i)return r;return-1},preventDefault:function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},stopPropagation:function(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this},offsetDom:function(t,i){return t?(e.Browser.any3d?e.DomUtil.setTransform(t,i):(t.style.left=i.x+"px",t.style.top=i.y+"px"),i):null},getPagePosition:function(t){if(t.getBoundingClientRect){var i=document.documentElement,n=t.getBoundingClientRect();return new e.Point(n.left+i.scrollLeft,n.top+i.scrollTop)}var r=0,o=0;for(t||console.error("obj is null"),o+=parseInt(t.offsetLeft,0),r+=parseInt(t.offsetTop,0),t=t.offsetParent;t;)o+=parseInt(t.offsetLeft,0),r+=parseInt(t.offsetTop,0),t=t.offsetParent;return new e.Point(o,r)},getEventPagePosition:function(t){if(t=t||window.event,t.touches&&t.touches.length>0)return new e.Point(t.touches[0].pageX,t.touches[0].pageY);if(t.changedTouches&&t.changedTouches.length>0)return new e.Point(t.changedTouches[0].pageX,t.changedTouches[0].pageY);if(t.pageX||t.pageY)return new e.Point(t.pageX,t.pageY);var i=document.body,n=document.documentElement,r=n.scrollLeft?n.scrollLeft:i.scrollLeft,o=n.clientLeft?n.clientLeft:i.clientLeft,s=n.scrollTop?n.scrollTop:i.scrollTop,a=n.clientTop?n.clientTop:i.clientTop;return new e.Point(t.clientX+r-o,t.clientY+s-a)},getEventContainerPoint:function(t,i){t||(t=window.event);var n=e.DomUtil.getPagePosition(i),r=e.DomUtil.getEventPagePosition(t);return r._substract(n)},setStyle:function(t,e){function i(t,e){var i=t.length-e.length;return i>=0&&t.indexOf(e,i)===i}var n=t.style,r=n.cssText;i(r,";")||(r+=";"),t.style.cssText=r+e},removeStyle:function(t){t.style.cssText=""},addStyle:function(t,e,i){var n=t.style.cssText;if(e&&i){var r=e+":"+i+";";t.style.cssText=n+r}},hasClass:function(t,i){if(void 0!==t.classList)return t.classList.contains(i);var n=e.DomUtil.getClass(t);return n.length>0&&new RegExp("(^|\\s)"+i+"(\\s|$)").test(n)},addClass:function(t,i){if(void 0!==t.classList)for(var n=e.StringUtil.splitWords(i),r=0,o=n.length;o>r;r++)t.classList.add(n[r]);else if(!e.DomUtil.hasClass(t,i)){var s=e.DomUtil.getClass(t);e.DomUtil.setClass(t,(s?s+" ":"")+i)}},removeClass:function(t,i){void 0!==t.classList?t.classList.remove(i):e.DomUtil.setClass(t,e.StringUtil.trim((" "+e.DomUtil.getClass(t)+" ").replace(" "+i+" "," ")))},setClass:function(t,i){e.Util.isNil(t.className.baseVal)?t.className=i:t.className.baseVal=i},getClass:function(t){return e.Util.isNil(t.className.baseVal)?t.className:t.className.baseVal},setOpacity:function(t,i){"opacity"in t.style?t.style.opacity=i:"filter"in t.style&&e.DomUtil._setOpacityIE(t,i)},_setOpacityIE:function(t,e){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(r){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"},copyCanvas:function(t){if(e.node)return null;var i=e.DomUtil.createEl("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0),i},testCanvasSize:function(){if(e.node)return function(){return!0};var t=null,i=null;return function(n){if(!t){var r=e.DomUtil.createEl("canvas");r.width=1,r.height=1,t=r.getContext("2d"),i=t.createImageData(1,1);var o=i.data;o[0]=42,o[1]=84,o[2]=126,o[3]=255}var s=t.canvas,a=n.width<=s.width&&n.height<=s.height;if(!a){s.width=n.width,s.height=n.height;var h=n.width-1,l=n.height-1;t.putImageData(i,h,l);for(var u=t.getImageData(h,l,1,1),c=!0,d=u.data.length-1;d>=0;d--)if(u.data[d]!==i.data[d]){c=!1;break}a=c}return a}}(),testProp:function(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1},setTransform:function(t,i,n){if(i instanceof e.Matrix)return t.style[e.DomUtil.TRANSFORM]=i.toCSS(),this;var r=i||new e.Point(0,0);return t.style[e.DomUtil.TRANSFORM]=(e.Browser.ie3d?"translate("+r.x+"px,"+r.y+"px)":"translate3d("+r.x+"px,"+r.y+"px,0)")+(n?" scale("+n+")":""),this}},e.DomUtil.on=e.DomUtil.addDomEvent,e.DomUtil.off=e.DomUtil.removeDomEvent,function(){e.node||(e.DomUtil.TRANSFORM=e.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]))}(),e.Eventable={on:function(t,e,i){if(!t||!e)return this;this._eventMap||(this._eventMap={});var n,r=t.split(" ");i||(i=this);for(var o,s,a,h=0,l=r.length;l>h;h++){for(n=r[h].toLowerCase(),o=this._eventMap[n],o||(o=[],this._eventMap[n]=o),s=0,a=o.length;a>s;s++)if(e===o[s].handler&&o[s].context===i)return this;o.push({handler:e,context:i})}return this},once:function(t,e,i){function n(){o||(o=!0,e.apply(this,arguments),r.off(t,n,this))}var r=this,o=!1;return this.on(t,n,i)},off:function(t,e,i){if(!t||!this._eventMap||!e)return this;var n,r,o=t.split(" ");i||(i=this);for(var s,a=0,h=o.length;h>a;a++){if(n=o[a].toLowerCase(),r=this._eventMap[n],!r)return this;for(s=r.length-1;s>=0;s--)e===r[s].handler&&r[s].context===i&&r.splice(s,1)}return this},_clearListeners:function(t){if(this._eventMap&&e.Util.isString(t)){var i=this._eventMap[t.toLowerCase()];i&&(this._eventMap[t]=null)}},_clearAllListeners:function(){this._eventMap=null},listens:function(t,i,n){if(!this._eventMap||!e.Util.isString(t))return 0;var r=this._eventMap[t.toLowerCase()];if(!r)return 0;for(var o=0,s=0,a=r.length;a>s;s++)if(i){if(i===r[s].handler&&(e.Util.isNil(n)||r[s].context===n))return 1}else o++;return o},copyEventListeners:function(t){var e=t._eventMap;if(!e)return this;var i,n,r;for(var o in e)for(i=e[o],n=0,r=i.length;r>n;n++)this.on(o,i[n].handler,i[n].context);return this},fire:function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},setEventParent:function(t){return this._eventParent=t,this},_fire:function(t,i){if(!this._eventMap)return this;var n=this._eventMap[t.toLowerCase()];if(!n)return this;i||(i={}),i.type=t,i.target=this;for(var r,o,s,a=[].concat(n),h=0,l=a.length;l>h;h++)a[h]&&(r=a[h].context,o=!0,s=e.Util.extend({},i),o=r?a[h].handler.call(r,s):a[h].handler(s),o===!1&&i.domEvent&&e.DomUtil.stopPropagation(i.domEvent));return this}},e.Eventable.addEventListener=e.Eventable.on,e.Eventable.removeEventListener=e.Eventable.off,e.Class=function(){},e.Class.extend=function(t){var i=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},n=i.__super__=this.prototype,r=e.Util.create(n);r.constructor=i,i.prototype=r;for(var o in this)"_"!==o[0]&&this.hasOwnProperty(o)&&"prototype"!==o&&(i[o]=this[o]);if(t.statics&&(e.Util.extend(i,t.statics),delete t.statics),t.includes&&(e.Util.extend.apply(null,[r].concat(t.includes)),delete t.includes),r.options&&(t.options=e.Util.extend(e.Util.create(r.options),t.options)),t.exceptionDefs){var s=e.Browser.language;"zh-CN"!==s&&(s="en-US"),e.Util.extend(r,{exceptions:t.exceptionDefs[s]}),delete t.exceptionDefs}return e.Util.extend(r,t),r._initHooks=[],r.callInitHooks=function(){if(!this._initHooksCalled){n.callInitHooks&&n.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=r._initHooks.length;e>t;t++)r._initHooks[t].call(this)}},r.config=function(t){if(!t){var i={};for(var n in this.options)this.options.hasOwnProperty(n)&&(i[n]=this.options[n]);return i}if(2===arguments.length){var r={};r[t]=arguments[1],t=r}for(var o in t)t.hasOwnProperty(o)&&(this.options[o]=t[o],this[o]&&this[o]instanceof e.Handler&&(t[o]?this[o].enable():this[o].disable()));return this.onConfig&&this.onConfig(t),this},i},e.Class.include=function(){for(var t=arguments,i=0,n=t.length;n>i;i++)e.Util.extend(this.prototype,t[i])},e.Class.mergeOptions=function(t){e.Util.extend(this.prototype.options,t)},e.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i)},e.Coordinate=function(t,i){if(e.Util.isNil(t)||e.Util.isNil(i)?e.Util.isArray(t)?(this.x=+t[0],this.y=+t[1]):e.Util.isNil(t.x)||e.Util.isNil(t.y)||(this.x=+t.x,this.y=+t.y):(this.x=+t,this.y=+i),this.isNaN())throw new Error("coordinate is NaN")},e.Util.extend(e.Coordinate.prototype,{copy:function(){return new e.Coordinate(this.x,this.y)},_add:function(t,i){return t instanceof e.Coordinate?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=i),this},add:function(t,i){var n,r;return t instanceof e.Coordinate?(n=this.x+t.x,r=this.y+t.y):(n=this.x+t,r=this.y+i),new e.Coordinate(n,r)},_substract:function(t,i){return t instanceof e.Coordinate?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=i),this},substract:function(t,i){var n,r;return t instanceof e.Coordinate?(n=this.x-t.x,r=this.y-t.y):(n=this.x-t,r=this.y-i),new e.Coordinate(n,r)},multi:function(t){return new e.Coordinate(this.x*t,this.y*t)},_multi:function(t){return this.x*=t,this.y*=t,this},equals:function(t){return e.Util.isCoordinate(t)?this.x===t.x&&this.y===t.y:!1},isNaN:function(){return isNaN(this.x)||isNaN(this.y)},toArray:function(){return[this.x,this.y]},toJSON:function(){return{x:this.x,y:this.y}}}),e.Point=function(t,i){if(e.Util.isNil(t)||e.Util.isNil(i)?e.Util.isNil(t.x)||e.Util.isNil(t.y)?e.Util.isArrayHasData(t)&&(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y):(this.x=t,this.y=i),this.isNaN())throw new Error("point is NaN")},e.Util.extend(e.Point.prototype,{_abs:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},copy:function(){return new e.Point(this.x,this.y)},_round:function(){return this.x=e.Util.round(this.x),this.y=e.Util.round(this.y),this},round:function(){return new e.Point(e.Util.round(this.x),e.Util.round(this.y))},equals:function(t){return this.x===t.x&&this.y===t.y},distanceTo:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},_add:function(t,i){return t instanceof e.Point?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=i),this},add:function(t,i){var n,r;return t instanceof e.Point?(n=this.x+t.x,r=this.y+t.y):(n=this.x+t,r=this.y+i),new e.Point(n,r)},_substract:function(t,i){return t instanceof e.Point?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=i),this},substract:function(t,i){var n,r;return t instanceof e.Point?(n=this.x-t.x,r=this.y-t.y):(n=this.x-t,r=this.y-i),new e.Point(n,r)},_multi:function(t){return this.x*=t,this.y*=t,this},multi:function(t){return new e.Point(this.x*t,this.y*t)},isNaN:function(){return isNaN(this.x)||isNaN(this.y)},toJSON:function(){return{x:this.x,y:this.y}}}),e.Size=function(t,e){this.width=t,this.height=e},e.Util.extend(e.Size.prototype,{copy:function(){return new e.Size(this.width,this.height)},add:function(t){return new e.Size(this.width+t.width,this.height+t.height)},equals:function(t){return this.width===t.width&&this.height===t.height},multi:function(t){return new e.Size(this.width*t,this.height*t)},_multi:function(t){return this.width*=t,this.height*=t,this},_round:function(){return this.width=e.Util.round(this.width),this.height=e.Util.round(this.height),this},toPoint:function(){return new e.Point(this.width,this.height)},toJSON:function(){return{width:this.width,height:this.height}}}),e.CRS=function(t,e){this.type=t,this.properties=e},e.CRS.createProj4=function(t){return new e.CRS("proj4",{proj:t})},e.CRS.WGS84=e.CRS.createProj4("+proj=longlat +datum=WGS84 +no_defs"),e.CRS.EPSG4326=e.CRS.WGS84,e.CRS.EPSG3857=e.CRS.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),e.CRS.IDENTITY=e.CRS.createProj4("+proj=identity +no_defs"),e.CRS.CGCS2000=e.CRS.createProj4("+proj=longlat +datum=CGCS2000"),e.CRS.EPSG4490=e.CRS.CGCS2000,e.CRS.BD09LL=e.CRS.createProj4("+proj=longlat +datum=BD09"),e.CRS.GCJ02=e.CRS.createProj4("+proj=longlat +datum=GCJ02"),e.Extent=function(t,i,n,r){this._clazz=e.Coordinate,this._initialize(t,i,n,r)},e.Util.extend(e.Extent.prototype,{_initialize:function(t,i,n,r){return this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,e.Util.isNil(t)?void 0:e.Util.isNumber(t)&&e.Util.isNumber(i)&&e.Util.isNumber(n)&&e.Util.isNumber(r)?(this.xmin=Math.min(t,n),this.ymin=Math.min(i,r),this.xmax=Math.max(t,n),void(this.ymax=Math.max(i,r))):void(e.Util.isNumber(t.x)&&e.Util.isNumber(i.x)&&e.Util.isNumber(t.y)&&e.Util.isNumber(i.y)?(t.x>i.x?(this.xmin=i.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=i.x),t.y>i.y?(this.ymin=i.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=i.y)):e.Util.isNumber(t.xmin)&&e.Util.isNumber(t.xmax)&&e.Util.isNumber(t.ymin)&&e.Util.isNumber(t.ymax)&&(this.xmin=t.xmin,this.ymin=t.ymin,this.xmax=t.xmax,this.ymax=t.ymax))},_add:function(t){return this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y,this},add:function(t){return new this.constructor(this.xmin+t.x,this.ymin+t.y,this.xmax+t.x,this.ymax+t.y)},round:function(){return new this.constructor(e.Util.round(this.xmin),e.Util.round(this.ymin),e.Util.round(this.xmax),e.Util.round(this.ymax))},_round:function(){return this.xmin=e.Util.round(this.xmin),this.ymin=e.Util.round(this.ymin),this.xmax=e.Util.round(this.xmax),this.ymax=e.Util.round(this.ymax),this},getMin:function(){return new this._clazz(this.xmin,this.ymin)},getMax:function(){return new this._clazz(this.xmax,this.ymax)},getCenter:function(){return new this._clazz((this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)},isValid:function(){return e.Util.isNumber(this.xmin)&&e.Util.isNumber(this.ymin)&&e.Util.isNumber(this.xmax)&&e.Util.isNumber(this.ymax)},equals:function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},intersects:function(t){var e=Math.max(this.xmin,t.xmin),i=Math.max(this.ymin,t.ymin),n=Math.min(this.xmax,t.xmax),r=Math.min(this.ymax,t.ymax),o=!(e>n||i>r);return o},contains:function(t){var e,i,n=new this._clazz(t);return e=n.x,i=n.y,e>=this.xmin&&e<=this.xmax&&i>=this.ymin&&i<=this.ymax},getWidth:function(){return this.xmax-this.xmin},getHeight:function(){return this.ymax-this.ymin},__combine:function(t){var i=this.xmin;e.Util.isNumber(i)?e.Util.isNumber(t.xmin)&&i>t.xmin&&(i=t.xmin):i=t.xmin;var n=this.xmax;e.Util.isNumber(n)?e.Util.isNumber(t.xmax)&&n<t.xmax&&(n=t.xmax):n=t.xmax;var r=this.ymin;e.Util.isNumber(r)?e.Util.isNumber(t.ymin)&&r>t.ymin&&(r=t.ymin):r=t.ymin;var o=this.ymax;return e.Util.isNumber(o)?e.Util.isNumber(t.ymax)&&o<t.ymax&&(o=t.ymax):o=t.ymax,[i,r,n,o]},_combine:function(t){if(!t)return this;var e=this.__combine(t);return this.xmin=e[0],this.ymin=e[1],this.xmax=e[2],this.ymax=e[3],this},combine:function(t){if(!t)return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3])},intersection:function(t){return this.intersects(t)?new this.constructor(Math.max(this.xmin,t.xmin),Math.max(this.ymin,t.ymin),Math.min(this.xmax,t.xmax),Math.min(this.ymax,t.ymax)):null},expand:function(t){return t instanceof e.Size?new this.constructor(this.xmin-t.width,this.ymin-t.height,this.xmax+t.width,this.ymax+t.height):new this.constructor(this.xmin-t,this.ymin-t,this.xmax+t,this.ymax+t)},_expand:function(t){return t instanceof e.Size?(this.xmin-=t.width,this.ymin-=t.height,this.xmax+=t.width,this.ymax+=t.height):(this.xmin-=t,this.ymin-=t,this.xmax+=t,this.ymax+=t),this},toJSON:function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},toArray:function(){var t=this.xmin,e=this.ymin,i=this.xmax,n=this.ymax;return[new this._clazz([t,n]),new this._clazz([i,n]),new this._clazz([i,e]),new this._clazz([t,e]),new this._clazz([t,n])]},copy:function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax)}}),e.PointExtent=function(t,i,n,r){this._clazz=e.Point,this._initialize(t,i,n,r)},e.Util.extend(e.PointExtent.prototype,e.Extent.prototype,{getSize:function(){return new e.Size(this.getWidth(),this.getHeight())}}),e.Matrix=function(t){var e=this;e._t=e.transform,e.a=e.d=1,e.b=e.c=e.e=e.f=0,e.context=t,t&&t.setTransform(1,0,0,1,0,0)};var i=e.Matrix;e.Matrix.prototype={concat:function(t){return this.clone()._t(t.a,t.b,t.c,t.d,t.e,t.f)},flipX:function(){return this._t(-1,0,0,1,0,0)},flipY:function(){return this._t(1,0,0,-1,0,0)},reflectVector:function(t,e){var i=this.applyToPoint(0,1),n=2*(i.x*t+i.y*e);return t-=n*i.x,e-=n*i.y,{x:t,y:e}},reset:function(){return this.setTransform(1,0,0,1,0,0)},rotate:function(t){var e=Math.cos(t),i=Math.sin(t);return this._t(e,i,-i,e,0,0)},rotateFromVector:function(t,e){return this.rotate(Math.atan2(e,t))},rotateDeg:function(t){return this.rotate(t*Math.PI/180)},scaleU:function(t){return 1===t?this:this._t(t,0,0,t,0,0)},scale:function(t,e){return this._t(t,0,0,e,0,0)},scaleX:function(t){return this._t(t,0,0,1,0,0)},scaleY:function(t){return this._t(1,0,0,t,0,0)},shear:function(t,e){return this._t(1,e,t,1,0,0)},shearX:function(t){return this._t(1,0,t,1,0,0)},shearY:function(t){return this._t(1,t,0,1,0,0)},skew:function(t,e){return this.shear(Math.tan(t),Math.tan(e))},skewX:function(t){return this.shearX(Math.tan(t))},skewY:function(t){return this.shearY(Math.tan(t))},setTransform:function(t,e,i,n,r,o){var s=this;return s.a=t,s.b=e,s.c=i,s.d=n,s.e=r,s.f=o,s._x()},translate:function(t,e){return this._t(1,0,0,1,t,e)},translateX:function(t){return this._t(1,0,0,1,t,0)},translateY:function(t){return this._t(1,0,0,1,0,t)},transform:function(t,e,i,n,r,o){var s=this,a=s.a,h=s.b,l=s.c,u=s.d,c=s.e,d=s.f;return s.a=a*t+l*e,s.b=h*t+u*e,s.c=a*i+l*n,s.d=h*i+u*n,s.e=a*r+l*o+c,s.f=h*r+u*o+d,s._x()},divide:function(t){if(!t.isInvertible())throw"Input matrix is not invertible";var e=t.inverse();return this._t(e.a,e.b,e.c,e.d,e.e,e.f)},divideScalar:function(t){var e=this;return e.a/=t,e.b/=t,e.c/=t,e.d/=t,e.e/=t,e.f/=t,e._x()},inverse:function(){if(this.isIdentity())return new i;if(this.isInvertible()){var t=this,e=t.a,n=t.b,r=t.c,o=t.d,s=t.e,a=t.f,h=new i,l=e*o-n*r;return h.a=o/l,h.b=-n/l,h.c=-r/l,h.d=e/l,h.e=(r*a-o*s)/l,h.f=-(e*a-n*s)/l,h}throw"Matrix is not invertible."},interpolate:function(t,e,n){var r=this,o=n?new i(n):new i;return o.a=r.a+(t.a-r.a)*e,o.b=r.b+(t.b-r.b)*e,o.c=r.c+(t.c-r.c)*e,
o.d=r.d+(t.d-r.d)*e,o.e=r.e+(t.e-r.e)*e,o.f=r.f+(t.f-r.f)*e,o._x()},interpolateAnim:function(t,e,n){var r=this,o=n?new i(n):new i,s=r.decompose(),a=t.decompose(),h=s.rotation+(a.rotation-s.rotation)*e,l=s.translate.x+(a.translate.x-s.translate.x)*e,u=s.translate.y+(a.translate.y-s.translate.y)*e,c=s.scale.x+(a.scale.x-s.scale.x)*e,d=s.scale.y+(a.scale.y-s.scale.y)*e;return o.translate(l,u),o.rotate(h),o.scale(c,d),o._x()},decompose:function(t){var e=this,i=e.a,n=e.b,r=e.c,o=e.d,s=Math.acos,a=Math.atan,h=Math.sqrt,l=Math.PI,u={x:e.e,y:e.f},c=0,d={x:1,y:1},f={x:0,y:0},m=i*o-n*r;if(t)i?(f={x:a(r/i),y:a(n/i)},d={x:i,y:m/i}):n?(c=.5*l,d={x:n,y:m/n},f.x=a(o/n)):(d={x:r,y:o},f.x=.25*l);else if(i||n){var _=h(i*i+n*n);c=n>0?s(i/_):-s(i/_),d={x:_,y:m/_},f.x=a((i*r+n*o)/(_*_))}else if(r||o){var g=h(r*r+o*o);c=.5*l-(o>0?s(-r/g):-s(r/g)),d={x:m/g,y:g},f.y=a((i*r+n*o)/(g*g))}else d={x:0,y:0};return{scale:d,translate:u,rotation:c,skew:f}},determinant:function(){return this.a*this.d-this.b*this.c},applyToPoint:function(t,e){var i=this;return{x:t*i.a+e*i.c+i.e,y:t*i.b+e*i.d+i.f}},applyToPointInstance:function(t){var i=this.applyToPoint(t.x,t.y);return new e.Point(i)},applyToArray:function(t){var i,n,r=0,o=[];if("number"==typeof t[0])for(n=t.length;n>r;)i=this.applyToPoint(t[r++],t[r++]),o.push(i.x,i.y);else for(;i=t[r];r++)o.push(new e.Point(this.applyToPoint(i.x,i.y)));return o},applyToTypedArray:function(t,e){for(var i,n=0,r=t.length,o=e?new Float64Array(r):new Float32Array(r);r>n;)i=this.applyToPoint(t[n],t[n+1]),o[n++]=i.x,o[n++]=i.y;return o},applyToContext:function(t){var e=this;return t.setTransform(e.a,e.b,e.c,e.d,e.e,e.f),e},isIdentity:function(){var t=this;return t._q(t.a,1)&&t._q(t.b,0)&&t._q(t.c,0)&&t._q(t.d,1)&&t._q(t.e,0)&&t._q(t.f,0)},isInvertible:function(){return!this._q(this.determinant(),0)},isValid:function(){return!this._q(this.a*this.d,0)},clone:function(t){var e=this,n=new i;return n.a=e.a,n.b=e.b,n.c=e.c,n.d=e.d,n.e=e.e,n.f=e.f,t||(n.context=e.context),n},isEqual:function(t){var e=this,i=e._q;return i(e.a,t.a)&&i(e.b,t.b)&&i(e.c,t.c)&&i(e.d,t.d)&&i(e.e,t.e)&&i(e.f,t.f)},toArray:function(){var t=this;return[t.a,t.b,t.c,t.d,t.e,t.f]},toCSS:function(){return"matrix("+this.toArray()+")"},toJSON:function(){var t=this;return'{"a":'+t.a+',"b":'+t.b+',"c":'+t.c+',"d":'+t.d+',"e":'+t.e+',"f":'+t.f+"}"},toString:function(){return""+this.toArray()},_q:function(t,e){return Math.abs(t-e)<1e-14},_x:function(){var t=this;return t.context&&t.context.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),t}},e.Matrix.prototype.multi=function(t){var e=this,i=e.clone();return i.a=2*e.a,i.b=2*e.b,i.c=2*e.c,i.d=2*e.d,i.e=2*e.e,i.f=2*e.f,i},e.animation={},e.Animation={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){function i(t){if(!e.Util.isArray(t))return e.Animation._resolveStyles(t);for(var i=[],n=[],r=[],o=0;o<t.length;o++){var s=e.Animation._resolveStyles(t[o]);s&&(i.push(s[0]),n.push(s[1]),r.push(s[2]))}return 0===i.length?null:[i,n,r]}function n(t){var i,n=t;if(!e.Util.isArray(t))if(e.Util.isNumber(t))n=[0,t];else{if(!(t instanceof e.Point||t instanceof e.Coordinate))throw new Error(t+" is not supported in animation styles.");i=t.constructor,n=[new i(0,0),t]}var r=n[0],o=n[1];if(e.Util.isNumber(r)&&e.Util.isNumber(o))return r===o?null:[r,o-r,o];if(e.Util.isArray(r)||r instanceof e.Coordinate||r instanceof e.Point)return e.Util.isArray(r)?(r=new e.Coordinate(r),o=new e.Coordinate(o)):(i=r.constructor,r=new i(r),o=new i(o)),r.equals(o)?null:[r,o.substract(r),o];throw new Error(n+" is not supported in animation styles.")}function r(t){return e.Util.isArray(t)||t.constructor!==Object?!(!e.Util.isArray(t)||t[0].constructor!==Object):!0}if(!t)return null;var o={},s={},a={};for(var h in t)if(t.hasOwnProperty(h)){var l,u=t[h];l=r(u)?i(u):n(u),l&&(s[h]=l[0],o[h]=l[1],a[h]=l[2])}return[s,o,a]},framing:function(t,i){i||(i={});var n=i.easing?e.animation.Easing[i.easing]:e.animation.Easing.linear;n||(n=e.animation.Easing.linear);var r,o,s;t=e.Animation._resolveStyles(t),t&&(o=t[0],r=t[1],s=t[2]);var a=function(t,i,n){if(!i||!n)return null;var r={};for(var o in n)if(n.hasOwnProperty(o)){var s=i[o],h=n[o];if(e.Util.isNumber(h))r[o]=s+t*h;else if(e.Util.isArray(h)){for(var l=[],u=0;u<h.length;u++)l.push(a(t,s[u],h[u]));r[o]=l}else{var c=h.constructor;c===Object?r[o]=a(t,s,h):(s instanceof e.Point||s instanceof e.Coordinate)&&(r[o]=s.add(h.multi(t)))}}return r};return function(t,i){var h,l;if(0>t)h={playState:"idle",delta:0},l=o;else if(i>t){var u=n(t/i);h={playState:"running",delta:u},l=a(u,o,r)}else h={playState:"finished",delta:1},l=s;return h.startStyles=o,h.destStyles=s,new e.animation.Frame(h,l)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=e.Util.requestAnimFrame(e.Util.bind(e.Animation._run,e.Animation)))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var i=0,n=t.length;n>i;i++)t[i]();this._frameQueue.length?this._animationFrameId=e.Util.requestAnimFrame(e.Util.bind(e.Animation._run,e.Animation)):delete this._animationFrameId}},animate:function(t,i,n){i||(i={});var r=e.Animation.framing(t,i);return new e.animation.Player(r,i,n)}},e.animation.Player=function(t,e,i){this._animation=t,this._options=e,this._stepFn=i,this.playState="idle",this.ready=!0,this.finished=!1},e.Util.extend(e.animation.Player.prototype,{_prepare:function(){var t=this._options,i=t.speed;e.Util.isString(i)&&(i=e.Animation.speed[i]),i||(i=e.Animation.speed.normal),this.duration=i},play:function(){if("idle"!==this.playState&&"paused"!==this.playState)return this;"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=e.Util.now();if(!this.startTime){var i=this._options;this.startTime=i.startTime?i.startTime:t}return this._playStartTime=Math.max(t,this.startTime),this._run(),this},pause:function(){return this.playState="paused",this.duration=this.duration-this.currentTime,this},cancel:function(){return this.playState="idle",this.finished=!1,this},finish:function(){return this.playState="finished",this.finished=!0,this},reverse:function(){},_run:function(){if("finished"!==this.playState&&"paused"!==this.playState){var t=this,i=e.Util.now(),n=this._animation(i-this._playStartTime,this.duration);this.playState=n.state.playState;var r=this._stepFn;"idle"===this.playState?setTimeout(e.Util.bind(this._run,this),this.startTime-i):"running"===this.playState?this._animeFrameId=e.Animation._requestAnimFrame(function(){t.currentTime=i-t._playStartTime,r&&r(n),t._run()}):"finished"===this.playState&&(this.finished=!0,r&&e.Util.requestAnimFrame(function(){r(n)}))}}}),e.animation.Easing={"in":function(t){return Math.pow(t,2)},out:function(t){return 1-e.animation.Easing["in"](1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return.5>t?e.animation.Easing.inAndOut(2*t):1-e.animation.Easing.inAndOut(2*(t-.5))}},e.animation.Frame=function(t,e){this.state=t,this.styles=e},e.Canvas={createCanvas:function(t,i,n){var r;return e.node?r=new n(t,i):(r=e.DomUtil.createEl("canvas"),r.width=t,r.height=i),r},setDefaultCanvasSetting:function(t){t.lineWidth=1,t.lineCap="butt",t.lineJoin="miter",t.strokeStyle="rgba(0,0,0,1)",t.fillStyle="rgba(255,255,255,0)",t.textAlign="start",t.textBaseline="top";var e=11;t.font=e+"px monospace",t.shadowBlur=null,t.shadowColor=null,t.setLineDash&&t.setLineDash([]),t.globalAlpha=1},prepareCanvasFont:function(t,i){t.font=e.symbolizer.TextMarkerSymbolizer.getFont(i);var n=i.textFill;n||(n=e.Symbolizer.DEFAULT_TEXT_COLOR),t.fillStyle=this.getRgba(n,i.textOpacity)},prepareCanvas:function(t,i,n){if(i){var r=i.lineWidth;e.Util.isNil(r)||t.lineWidth===r||(t.lineWidth=r);var o=i.linePatternFile||i.lineColor||e.Symbolizer.DEFAULT_STROKE_COLOR;if(e.Util.isCssUrl(o)&&n)e.Canvas._setStrokePattern(t,o,r,n),i.lineDasharray=[];else if(e.Util.isGradient(o))i.lineGradientExtent?t.strokeStyle=e.Canvas._createGradient(t,o,i.lineGradientExtent):t.strokeStyle="rgba(0,0,0,1)";else{var s=e.Canvas.getRgba(o,1);t.strokeStyle!==s&&(t.strokeStyle=s)}i.lineJoin&&t.lineJoin!==i.lineJoin&&(t.lineJoin=i.lineJoin),i.lineCap&&t.lineCap!==i.lineCap&&(t.lineCap=i.lineCap),t.setLineDash&&e.Util.isArrayHasData(i.lineDasharray)&&t.setLineDash(i.lineDasharray);var a=i.polygonPatternFile||i.polygonFill||e.Symbolizer.DEFAULT_FILL_COLOR;if(e.Util.isCssUrl(a)){var h=e.Util.extractCssUrl(a),l=n.getImage([h,null,null]);if(l||(l=n.getImage([h+"-texture",null,r])),e.Util.isSVG(h)&&l instanceof Image&&(e.Browser.edge||e.Browser.ie)){var u=l.width||20,c=l.height||20,d=e.Canvas.createCanvas(u,c);e.Canvas.image(d.getContext("2d"),l,0,0,u,c),l=d}l?t.fillStyle=t.createPattern(l,"repeat"):e.Browser.phantomjs||console.warn("img not found for",h)}else if(e.Util.isGradient(a))i.polygonGradientExtent?t.fillStyle=e.Canvas._createGradient(t,a,i.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)";else{var f=this.getRgba(a,1);t.fillStyle!==f&&(t.fillStyle=f)}}},_createGradient:function(t,e,i){var n=null,r=e.places,o=i.getMin(),s=i.getMax(),a=i.getWidth(),h=i.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(r){if(6!==r.length)throw new Error("A radial gradient's places should have 6 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,a*r[2],o.x+r[3]*a,o.y+r[4]*h,a*r[5]]}else{var l=i.getCenter()._round();r=[l.x,l.y,l.x-o.x,l.x,l.y,0]}n=t.createRadialGradient.apply(t,r)}}else{if(r){if(4!==r.length)throw new Error("A linear gradient's places should have 4 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,o.x+r[2]*a,o.y+r[3]*h]}else r=[o.x,o.y,s.x,o.y];n=t.createLinearGradient.apply(t,r)}return e.colorStops.forEach(function(t){n.addColorStop.apply(n,t)}),n},_setStrokePattern:function(t,i,n,r){var o,s=e.Util.extractCssUrl(i);if(e.node)o=r.getImage([s,null,n]);else if(o=r.getImage([s+"-texture",null,n]),!o){var a=r.getImage([s,null,n]);if(a){var h;h=a.width&&a.height?e.Util.round(a.width*n/a.height):n;var l=this.createCanvas(h,n,t.canvas.constructor);e.Canvas.image(l.getContext("2d"),a,0,0,h,n),r.addResource([s+"-texture",null,n],l),o=l}}o?t.strokeStyle=t.createPattern(o,"repeat"):e.Browser.phantomjs||console.warn("img not found for",s)},clearRect:function(t,e,i,n,r){t.clearRect(e,i,n,r)},fillCanvas:function(t,i,n,r){var o=e.Canvas._isPattern(t.fillStyle);e.Util.isNil(i)&&(i=1);var s;1>i&&(s=t.globalAlpha,t.globalAlpha*=i),o&&(n=e.Util.round(n),r=e.Util.round(r),t.translate(n,r)),t.fill(),o&&t.translate(-n,-r),1>i&&(t.globalAlpha=s)},getRgba:function(t,i){if(e.Util.isNil(i)&&(i=1),"#"!==t[0])return t;var n,r,o;return 7===t.length?(n=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),o=parseInt(t.substring(5,7),16)):(n=17*parseInt(t.substring(1,2),16),r=17*parseInt(t.substring(2,3),16),o=17*parseInt(t.substring(3,4),16)),"rgba("+n+","+r+","+o+","+i+")"},image:function(t,i,n,r,o,s){n=e.Util.round(n),r=e.Util.round(r);try{e.Util.isNumber(o)&&e.Util.isNumber(s)?t.drawImage(i,n,r,e.Util.round(o),e.Util.round(s)):t.drawImage(i,n,r)}catch(a){console.warn("error when drawing image on canvas:",a),console.warn(i)}},text:function(t,e,i,n,r){this._textOnMultiRow(t,r.rows,n,i,r.size,r.rawSize)},_textOnMultiRow:function(t,i,n,r,o,s){for(var a,h,l=e.StringUtil.getAlignPoint(o,n.textHorizontalAlignment,n.textVerticalAlignment),u=s.height+n.textLineSpacing,c=r.add(0,l.y),d=0,f=i.length;f>d;d++)a=i[d].text,h=e.StringUtil.getAlignPoint(i[d].size,n.textHorizontalAlignment,n.textVerticalAlignment),e.Canvas._textOnLine(t,a,c.add(h.x,d*u),n.textHaloRadius,n.textHaloFill)},_textOnLine:function(t,i,n,r,o){if(n=n._round(),t.textBaseline="top",r){t.miterLimit=2,t.lineJoin="round",t.lineCap="round";var s=2*r-1;t.lineWidth=e.Util.round(s),t.strokeStyle=e.Canvas.getRgba(o,1),t.strokeText(i,n.x,n.y),t.lineWidth=1,t.miterLimit=10}t.fillText(i,n.x,n.y)},fillText:function(t,e,i,n){t.fillStyle=n,t.fillText(e,i.x,i.y)},_stroke:function(t,i,n,r){var o=e.Canvas._isPattern(t.strokeStyle)&&!e.Util.isNil(n)&&!e.Util.isNil(r);e.Util.isNil(i)&&(i=1);var s;1>i&&(s=t.globalAlpha,t.globalAlpha*=i),o&&(n=e.Util.round(n),r=e.Util.round(r),t.translate(n,r)),t.stroke(),o&&t.translate(-n,-r),1>i&&(t.globalAlpha=s)},_path:function(t,i,n,r,o){function s(i,n){var o=e.Util.computeDegree(i,n);t.save(),t.translate(i.x,i.y-t.lineWidth/2/Math.cos(o)),t.rotate(o),e.Canvas._stroke(t,r),t.restore()}function a(e,i,n){var r=e.x,o=e.y,s=i.x,a=i.y,h=n,l=function(t,e){return e>=t},u=function(t,e){return t>=e},c=function(t,e){return Math.min(t,e)},d=function(t,e){return Math.max(t,e)},f={thereYet:u,cap:c},m={thereYet:u,cap:c};o-a>0&&(m.thereYet=l,m.cap=d),r-s>0&&(f.thereYet=l,f.cap=d),t.moveTo(r,o);for(var _,g,p=r,y=o,v=0,x=!0;!f.thereYet(p,s)||!m.thereYet(y,a);)_=Math.atan2(a-o,s-r),g=h[v],p=f.cap(s,p+Math.cos(_)*g),y=m.cap(a,y+Math.sin(_)*g),x?t.lineTo(p,y):t.moveTo(p,y),v=(v+1)%h.length,x=!x}if(e.Util.isArrayHasData(i))for(var h,l,u,c=e.Util.isArrayHasData(n),d=o===!0?!1:e.Canvas._isPattern(t.strokeStyle),f=0,m=i.length;m>f;f++)if(h=i[f]._round(),!c||t.setLineDash)0===f?t.moveTo(h.x,h.y):t.lineTo(h.x,h.y),d&&f>0&&(l=i[f-1]._round(),s(l,h),t.beginPath(),t.moveTo(h.x,h.y));else if(c){if(f===m-1)break;u=i[f+1]._round(),a(h,u,n,d)}},path:function(t,i,n,r,o){t.beginPath(),e.Canvas._path(t,i,o,n),e.Canvas._stroke(t,n)},polygon:function(t,i,n,r,o){function s(i,n,r){e.Canvas.fillCanvas(t,r,i[n][0].x,i[n][0].y)}var a=e.Canvas._isPattern(t.strokeStyle),h=e.Util.isArrayHasData(o)&&!t.setLineDash||a;e.Util.isArrayHasData(i[0])||(i=[i]);var l,u,c;if(h){for(t.save(),u=0,c=i.length;c>u;u++)e.Canvas._ring(t,i[u],null,0,!0),l=r,u>0&&(t.globalCompositeOperation="destination-out",l=1),s(i,u,l),u>0&&(t.globalCompositeOperation="source-over"),e.Canvas._stroke(t,0);t.restore()}for(u=0,c=i.length;c>u;u++)e.Canvas._ring(t,i[u],o,n),h||(l=r,u>0&&(t.globalCompositeOperation="destination-out",l=1),s(i,u,l),u>0&&(t.globalCompositeOperation="source-over")),e.Canvas._stroke(t,n)},_ring:function(t,i,n,r,o){var s=o===!0?!1:e.Canvas._isPattern(t.strokeStyle);s&&!i[0].equals(i[i.length-1])&&(i=i.concat([i[0]])),t.beginPath(),e.Canvas._path(t,i,n,r,o),s||t.closePath()},_arcBetween:function(t,i,n,r){var o=r*Math.PI/180,s=i.distanceTo(n),a=s/2/Math.sin(o/2),h=Math.asin((n.y-i.y)/s);i.x>n.x&&(h=Math.PI-h);var l=90*Math.PI/180-o/2,u=h-l,c=Math.cos(u)*a,d=Math.sin(u)*a,f=i.x+c,m=i.y+d,_=Math.asin((n.y-m)/a);f>n.x&&(_=Math.PI-_);var g=_+o;t.beginPath(),t.arc(e.Util.round(f),e.Util.round(m),e.Util.round(a),_,g)},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,i,n,r){t.beginPath();var o=i[0]._round();t.moveTo(o.x,o.y),e.Canvas._bezierCurveTo.apply(e.Canvas,[t].concat(i.splice(1))),e.Canvas.fillCanvas(t,r),e.Canvas._stroke(t,n)},_bezierCurveTo:function(t,e,i,n){e=e._round(),i=i._round(),n=n._round(),t.bezierCurveTo(e.x,e.y,i.x,i.y,n.x,n.y)},_quadraticCurveTo:function(t,e,i){e=e._round(),i=i._round(),t.quadraticCurveTo(e.x,e.y,i.x,i.y)},ellipse:function(t,i,n,r,o,s){function a(a,h,l,u){var c=.5522848,d=l*c,f=u*c;t.beginPath(),t.moveTo(a-l,h),e.Canvas._bezierCurveTo(t,new e.Point(a-l,h-f),new e.Point(a-d,h-u),new e.Point(a,h-u)),e.Canvas._bezierCurveTo(t,new e.Point(a+d,h-u),new e.Point(a+l,h-f),new e.Point(a+l,h)),e.Canvas._bezierCurveTo(t,new e.Point(a+l,h+f),new e.Point(a+d,h+u),new e.Point(a,h+u)),e.Canvas._bezierCurveTo(t,new e.Point(a-d,h+u),new e.Point(a-l,h+f),new e.Point(a-l,h)),t.closePath(),e.Canvas.fillCanvas(t,s,i.x-n,i.y-r),e.Canvas._stroke(t,o,i.x-n,i.y-r)}i=i._round(),n===r?(t.beginPath(),t.arc(i.x,i.y,e.Util.round(n),0,2*Math.PI),e.Canvas.fillCanvas(t,s,i.x-n,i.y-r),e.Canvas._stroke(t,o,i.x-n,i.y-r)):a(i.x,i.y,n,r)},rectangle:function(t,i,n,r,o){i=i._round(),t.beginPath(),t.rect(i.x,i.y,e.Util.round(n.width),e.Util.round(n.height)),e.Canvas.fillCanvas(t,o,i.x,i.y),e.Canvas._stroke(t,r,i.x,i.y)},sector:function(t,i,n,r,o,s){function a(t,i,n,r,a,h){var l=Math.PI/180,u=l*-h,c=l*-a;t.beginPath(),t.moveTo(i,n),t.arc(i,n,r,u,c),t.lineTo(i,n),e.Canvas.fillCanvas(t,s,i-r,n-r),e.Canvas._stroke(t,o,i-r,n-r)}var h=r[0],l=r[1];i=i._round(),a(t,i.x,i.y,n,h,l)},_isPattern:function(t){return!(e.Util.isString(t)||"addColorStop"in t)}},function(){var t;if(e.node){var i=require("url"),n=require("http"),r=require("https");t={get:function(t,e){var n=i.parse(t);return this._getClient(n.protocol).get(t,this._wrapCallback(e)).on("error",e),this},post:function(t,n,r){var o=i.parse(t.url);o.method="POST",t.headers&&(o.headers=t.headers);var s=this._getClient(o.protocol).request(o,this._wrapCallback(r));return s.on("error",r),e.Util.isString(n)||(n=JSON.stringify(n)),s.write(n),s.end(),this},_wrapCallback:function(t){return function(e){var i=[],n=!1;e.setEncoding("utf8"),e.on("data",function(t){t instanceof Buffer&&(n=!0),i.push(t)}),e.on("end",function(){t(null,n?Buffer.concat(i).toString("utf8"):i.join(""))})}},_getClient:function(t){return this._client||(this._client=t&&"https:"===t?r:n),this._client}}}else t={get:function(t,e){var i=this._getClient(e);return i.open("GET",t,!0),i.send(null),this},post:function(t,i,n){var r=this._getClient(n);if(r.open("POST",t.url,!0),t.headers&&"setRequestHeader"in r)for(var o in t.headers)t.headers.hasOwnProperty(o)&&r.setRequestHeader(o,t.headers[o]);return e.Util.isString(i)||(i=JSON.stringify(i)),r.send(i),this},_wrapCallback:function(t,e){var i=this;return function(){if(void 0!==t.withCredentials||i._isIE8())e(null,t.responseText);else if(4===t.readyState)if(200===t.status)e(null,t.responseText);else{if(0===t.status)return;e(null,'{"success":false,"error":"Status:'+t.status+","+t.statusText+'"}')}}},_isIE8:function(){return e.Browser.ie&&8===document.documentMode},_getClient:function(t){var e;if(this._isIE8())try{e=new XDomainRequest}catch(i){}try{e=new XMLHttpRequest}catch(i){}try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(i){}try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){}return this._isIE8()||void 0!==e.withCredentials?e.onload=this._wrapCallback(e,t):e.onreadystatechange=this._wrapCallback(e,t),e}};t.getResource=function(t,e){return this.get(t,e)},t.getJSON=function(i,n){var r=function(t,i){var r=i?e.Util.parseJSON(i):null;n(t,r)};return t.getResource(i,r)},e.Util.getJSON=t.getJSON}(),function(){function t(t){return new Function("f","var p = (f && f.properties || {}); return "+i(t))}function i(t){if(!t)return"true";var e=t[0];if(t.length<=1)return"any"===e?"false":"true";var i="=="===e?r(t[1],t[2],"===",!1):"!="===e?r(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?r(t[1],t[2],e,!0):"any"===e?o(t.slice(1),"||"):"all"===e?o(t.slice(1),"&&"):"none"===e?h(o(t.slice(1),"||")):"in"===e?s(t[1],t.slice(2)):"!in"===e?h(s(t[1],t.slice(2))):"has"===e?a(t[1]):"!has"===e?h(a([t[1]])):"true";return"("+i+")"}function n(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function r(t,i,r,o){var s=n(t),a="$type"===t?e.Util.indexOfArray(i,u):JSON.stringify(i);return(o?"typeof "+s+"=== typeof "+a+"&&":"")+s+r+a}function o(t,n){return e.Util.mapArray(t,i).join(n)}function s(t,i){"$type"===t&&(i=e.Util.mapArray(i,function(t){return e.Util.indexOfArray(t,u)}));var r=JSON.stringify(i.sort(l)),o=n(t);return i.length<=200?"maptalks.Util.indexOfArray("+o+", "+r+") !== -1":"function(v, a, i, j) {while (i <= j) { var m = (i + j) >> 1;    if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;}return false; }("+o+", "+r+",0,"+(i.length-1)+")"}function a(t){return JSON.stringify(t)+" in p"}function h(t){return"!("+t+")"}function l(t,e){return e>t?-1:t>e?1:0}var u=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];e.Util.createFilter=t,e.Util.getFilterFeature=function(t){var i=t._toJSON(),n=i.feature;return n.type=e.Util.indexOfArray(n.geometry.type,u),n.subType=i.subType,n}}(),function(){function t(e,o){var s;if(h(e)){var a,l="object"==typeof e.stops[0][0],u=l||void 0!==e.property,c=l||!u,d=e.type||o||"exponential";if("exponential"===d)a=r;else if("interval"===d)a=n;else{if("categorical"!==d)throw new Error('Unknown function type "'+d+'"');a=i}if(l){for(var f={},m=[],_=0;_<e.stops.length;_++){var g=e.stops[_];void 0===f[g[0].zoom]&&(f[g[0].zoom]={zoom:g[0].zoom,type:e.type,property:e.property,stops:[]}),f[g[0].zoom].stops.push([g[0].value,g[1]])}for(var p in f)m.push([f[p].zoom,t(f[p])]);s=function(t,i){return r({stops:m,base:e.base},t)(t,i)},s.isFeatureConstant=!1,s.isZoomConstant=!1}else c?(s=function(t){return a(e,t)},s.isFeatureConstant=!0,s.isZoomConstant=!1):(s=function(t,i){return a(e,i[e.property])},s.isFeatureConstant=!1,s.isZoomConstant=!0)}else s=function(){return e},s.isFeatureConstant=!0,s.isZoomConstant=!0;return s}function i(t,e){for(var i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.stops[0][1]}function n(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function r(t,e){for(var i=void 0!==t.base?t.base:1,n=0;;){if(n>=t.stops.length)break;if(e<=t.stops[n][0])break;n++}return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:o(e,i,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}function o(t,e,i,n,r,h){return"function"==typeof r?function(){var s=r.apply(void 0,arguments),a=h.apply(void 0,arguments);return o(t,e,i,n,s,a)}:r.length?a(t,e,i,n,r,h):s(t,e,i,n,r,h)}function s(t,e,i,n,r,o){var s,a=n-i,h=t-i;return s=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1),r*(1-s)+o*s}function a(t,e,i,n,r,o){for(var a=[],h=0;h<r.length;h++)a[h]=s(t,e,i,n,r[h],o[h]);return a}function h(t){return t&&"object"==typeof t&&t.stops}e.Util.isFunctionDefinition=h,e.Util.interpolated=function(e){return t(e,"exponential")},e.Util["piecewise-constant"]=function(e){return t(e,"interval")},e.Util.loadFunctionTypes=function(t,i){if(!t)return null;var n,r={},o=[];for(n in t)t.hasOwnProperty(n)&&o.push(n);for(var s=0,a=o.length;a>s;s++)n=o[s],e.Util.isFunctionDefinition(t[n])?(r["_"+n]=t[n],function(t){Object.defineProperty(r,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=e.Util.interpolated(this["_"+t])),this["__fn_"+t].apply(this,i())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})}(n)):r[n]=t[n];return r}}(),e.Transformation=function(t){this.matrix=t},e.Util.extend(e.Transformation.prototype,{transform:function(t,i){return new e.Point(this.matrix[0]*(t.x-this.matrix[2])/i,this.matrix[1]*(t.y-this.matrix[3])/i)},untransform:function(t,i){return new e.Coordinate(t.x*i/this.matrix[0]+this.matrix[2],t.y*i/this.matrix[1]+this.matrix[3])}}),e.measurer={},e.MeasurerUtil={getInstance:function(t){if(!t)return e.MeasurerUtil.DEFAULT;for(var i in e.measurer)if(e.measurer.hasOwnProperty(i)){var n=e.measurer[i].measure;if(!n)continue;if(t.toLowerCase()===n.toLowerCase())return e.measurer[i]}return null},DEFAULT:e.measurer.WGS84Sphere},e.measurer.Sphere=function(t){this.radius=t},e.Util.extend(e.measurer.Sphere.prototype,{rad:function(t){return t*Math.PI/180},measureLength:function(t,e){if(!t||!e)return 0;var i=this.rad(t.y),n=this.rad(e.y),r=i-n,o=this.rad(t.x)-this.rad(e.x);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),i*=this.radius,Math.round(1e4*i)/1e4},measureArea:function(t){var e=this.radius*Math.PI/180,i=0,n=t,r=n.length;if(3>r)return 0;for(var o=0;r-1>o;o++){var s=n[o],a=n[o+1];i+=s.x*e*Math.cos(s.y*Math.PI/180)*a.y*e-a.x*e*Math.cos(a.y*Math.PI/180)*s.y*e}return r=n[o],n=n[0],i+=r.x*e*Math.cos(r.y*Math.PI/180)*n.y*e-n.x*e*Math.cos(n.y*Math.PI/180)*r.y*e,.5*Math.abs(i)},locate:function(t,i,n){if(!t)return null;if(i||(i=0),n||(n=0),!i&&!n)return t;var r=Math.abs(i),o=Math.abs(n),s=this.rad(t.y),a=this.rad(t.x),h=2*Math.sin(o/(2*this.radius));s+=h*(n>0?1:-1);var l=2*Math.sqrt(Math.pow(Math.sin(r/(2*this.radius)),2)/Math.pow(Math.cos(s),2));return a+=l*(i>0?1:-1),new e.Coordinate(180*a/Math.PI,180*s/Math.PI)}}),e.measurer.WGS84Sphere={measure:"EPSG:4326",sphere:new e.measurer.Sphere(6378137),measureLength:function(){return this.sphere.measureLength.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)}},e.measurer.BaiduSphere={measure:"BAIDU",sphere:new e.measurer.Sphere(6370996.81),measureLength:function(){return this.sphere.measureLength.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)}},e.measurer.Identity={measure:"IDENTITY",measureLength:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(i){return 0}},measureArea:function(t){if(!e.Util.isArrayHasData(t))return 0;for(var i=0,n=0,r=t.length;r>n;n++){var o=t[n],s=null;s=n===r-1?t[0]:t[n+1],i+=o.x*s.y-o.y*s.x}return Math.abs(i/2)},locate:function(t,i,n){return t?(i||(i=0),n||(n=0),i||n?new e.Coordinate(t.x+i,t.y+n):t):null}},e.projection={},e.projection.Common={project:function(){},unproject:function(){},projectCoords:function(t){return e.Util.mapArrayRecursively(t,this.project,this)},unprojectCoords:function(t){return e.Util.mapArrayRecursively(t,this.unproject,this)}},e.projection.EPSG3857=e.Util.extend({},e.projection.Common,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:20037508.34/180,maxLatitude:85.0511287798,project:function(t){var i,n=this.rad,r=this.metersPerDegree,o=this.maxLatitude,s=t.x,a=Math.max(Math.min(o,t.y),-o);return i=0===a?0:Math.log(Math.tan((90+a)*n/2))/n,new e.Coordinate(s*r,i*r)},unproject:function(t){var i,n=t.x,r=t.y,o=this.rad,s=this.metersPerDegree;return 0===r?i=0:(i=r/s,i=(2*Math.atan(Math.exp(i*o))-Math.PI/2)/o),new e.Coordinate(n/s,i)}},e.measurer.WGS84Sphere),e.projection.DEFAULT=e.projection.EPSG3857,e.projection.EPSG4326=e.Util.extend({},e.projection.Common,{code:"EPSG:4326",project:function(t){return new e.Coordinate(t.x,t.y)},unproject:function(t){return new e.Coordinate(t.x,t.y)}},e.measurer.WGS84Sphere),e.projection.BAIDU=e.Util.extend({},e.projection.Common,{code:"BAIDU",project:function(t){return this.convertLL2MC(t)},unproject:function(t){return this.convertMC2LL(t)}},e.measurer.BaiduSphere,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t){var i,n;i={x:Math.abs(t.x),y:Math.abs(t.y)};for(var r=0,o=this.MCBAND.length;o>r;r++)if(i.y>=this.MCBAND[r]){n=this.MC2LL[r];break}var s=this.convertor(t,n),a=new e.Coordinate(s.x.toFixed(6),s.y.toFixed(6));return a},convertLL2MC:function(t){var i,n,r,o;for(t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74),i=new e.Coordinate(t.x,t.y),r=0,o=this.LLBAND.length;o>r;r++)if(i.y>=this.LLBAND[r]){n=this.LL2MC[r];break}if(!n)for(r=this.LLBAND.length-1;r>=0;r--)if(i.y<=-this.LLBAND[r]){n=this.LL2MC[r];break}var s=this.convertor(t,n),a=new e.Coordinate(s.x.toFixed(2),s.y.toFixed(2));return a},convertor:function(t,i){if(!t||!i)return null;var n=i[0]+i[1]*Math.abs(t.x),r=Math.abs(t.y)/i[9],o=i[2]+i[3]*r+i[4]*r*r+i[5]*r*r*r+i[6]*r*r*r*r+i[7]*r*r*r*r*r+i[8]*r*r*r*r*r*r;return n*=t.x<0?-1:1,o*=t.y<0?-1:1,new e.Coordinate(n,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,i){return null!=e&&(t=Math.max(t,e)),null!=i&&(t=Math.min(t,i)),t},getLoop:function(t,e,i){for(;t>i;)t-=i-e;for(;e>t;)t+=i-e;return t}}),e.projection.IDENTITY=e.Util.extend({},e.projection.Common,{code:"IDENTITY",project:function(t){return t.copy()},unproject:function(t){return t.copy()}},e.measurer.Identity),e.Handler=e.Class.extend({includes:e.Eventable,initialize:function(t){this.target=t},enable:function(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)},disable:function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},enabled:function(){return!!this._enabled}}),e.Handlerable={addHandler:function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},removeHandler:function(t){if(!t)return this;var i=this[t];if(i){var n=e.Util.indexOfArray(i,this._handlers);n>=0&&this._handlers.splice(n,1),this[t].disable(),delete this[t]}return this},_clearHandlers:function(){for(var t=0,e=this._handlers.length;e>t;t++)this._handlers[t].disable()}},e.Handler.Drag=e.Handler.extend({START:e.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},initialize:function(t){this.dom=t},enable:function(){this.dom&&e.DomUtil.on(this.dom,this.START.join(" "),this.onMouseDown,this)},disable:function(){this.dom&&e.DomUtil.off(this.dom,this.START.join(" "),this.onMouseDown)},onMouseDown:function(t){if(!e.Util.isNumber(t.button)||2!==t.button){var i=this.dom;i.setCapture?i.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),i.ondragstart=function(){return!1},this.moved=!1;var n=t.touches?t.touches[0]:t;this.startPos=new e.Point(n.clientX,n.clientY),e.DomUtil.on(document,this.MOVE[t.type],this.onMouseMove,this),e.DomUtil.on(document,this.END[t.type],this.onMouseUp,this)}},onMouseMove:function(t){if(!(t.touches&&t.touches.length>1)){var i=t.touches?t.touches[0]:t,n=new e.Point(i.clientX,i.clientY),r=n.substract(this.startPos);(r.x||r.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new e.Point(i.clientX,i.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},onMouseUp:function(t){var i=this.dom,n=t.changedTouches?t.changedTouches[0]:t;for(var r in this.MOVE)e.DomUtil.off(document,this.MOVE[r],this.onMouseMove,this).off(document,this.END[r],this.onMouseUp,this);i.releaseCapture?i.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),
this.moved&&this.fire("dragend",{domEvent:t,mousePos:new e.Point(parseInt(n.clientX,0),parseInt(n.clientY,0))}),this.fire("mouseup",{domEvent:t,mousePos:new e.Point(parseInt(n.clientX,0),parseInt(n.clientY,0))})}}),e.MapTool=e.Class.extend({includes:[e.Eventable],addTo:function(t){if(!t)return this;this._map=t;var e="_tool"+this.name;return t[e]&&t[e].disable(),this._onAdd&&this._onAdd(),this.enable(),t[e]=this,this._fireEvent("add"),this},getMap:function(){return this._map},enable:function(){var t=this._map;return!t||this._enabled?this:(this._enabled=!0,this._switchEvents("off"),this._loadResources?this._loadResources(this._registerEvents):this._registerEvents(),this._onEnable&&this._onEnable(),this._fireEvent("enable"),this)},disable:function(){return this._enabled&&this._map?(this._enabled=!1,this._map?(this._switchEvents("off"),this._onDisable&&this._onDisable(),this._fireEvent("disable"),this):this):this},_registerEvents:function(){this._switchEvents("on")},_switchEvents:function(t){var e=this._getEvents();if(e)for(var i in e)e.hasOwnProperty(i)&&this._map[t](i,e[i],this)}}),e.DrawTool=e.MapTool.extend({options:{symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:0},mode:null,once:!1},initialize:function(t){e.Util.setOptions(this,t),this._checkMode()},setMode:function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this._switchEvents("on"),this},getSymbol:function(){var t=this.options.symbol;return t?e.Util.extendSymbol(t):e.Util.extendSymbol(this.options.symbol)},setSymbol:function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},_onAdd:function(){this._checkMode()},_onEnable:function(){var t=this.getMap();return this._mapDraggable=t.options.draggable,this._mapDoubleClickZoom=t.options.doubleClickZoom,this._autoBorderPanning=t.options.autoBorderPanning,t.config({autoBorderPanning:!0,draggable:!1,doubleClickZoom:!1}),this._drawToolLayer=this._getDrawLayer(),this},_checkMode:function(){if(!this.options.mode)throw new Error("drawtool's mode is null.");var t=["circle","ellipse","rectangle","point","linestring","polygon"];this.options.mode=this.options.mode.toLowerCase();for(var e=0;e<t.length;e++)if(this.options.mode===t[e])return!0;throw new Error("invalid mode for drawtool : "+this.options.mode)},_onDisable:function(){var t=this.getMap();return t.config({autoBorderPanning:this._autoBorderPanning,draggable:this._mapDraggable,doubleClickZoom:this._mapDoubleClickZoom}),delete this._autoBorderPanning,delete this._mapDraggable,delete this._mapDoubleClickZoom,this._endDraw(),t.removeLayer(this._getDrawLayer()),this},_loadResources:function(t){var i=this.getSymbol(),n=e.Util.getExternalResources(i);e.Util.isArrayHasData(n)?this._drawToolLayer._getRenderer()._loadResources(n,t,this):t.call(this)},_getProjection:function(){return this._map.getProjection()},_getEvents:function(){var t=this.options.mode;return"polygon"===t||"linestring"===t?{click:this._clickForPath,mousemove:this._mousemoveForPath,dblclick:this._dblclickForPath}:"point"===t?{click:this._clickForPoint}:{mousedown:this._mousedownToDraw}},_addGeometryToStage:function(t){var e=this._getDrawLayer();e.addGeometry(t)},_clickForPoint:function(t){var i=new e.Marker(t.coordinate);this.options.symbol&&this.options.hasOwnProperty("symbol")&&i.setSymbol(this.options.symbol),this._geometry=i,this._endDraw()},_clickForPath:function(t){var i=this._getMouseContainerPoint(t),n=this._containerPointToLonlat(i),r=this.getSymbol();if(this._geometry){var o=this._getLonlats();if(o.push(n),"polygon"===this.options.mode&&3===o.length){var s=new e.Polygon([o]);if(r){var a=e.Util.extendSymbol(r,{lineOpacity:0});s.setSymbol(a)}this._polygon=s,this._addGeometryToStage(s)}this._setLonlats(o),this._fireEvent("drawvertex",t)}else this._geometry=new e.Polyline([n]),r&&this._geometry.setSymbol(r),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t)},_mousemoveForPath:function(t){if(this._geometry){var i=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(i)){var n=this._containerPointToLonlat(i),r=this._getLonlats(),o=[r[r.length-1],n];if(this._movingTail)this._movingTail.setCoordinates(o);else{var s=e.Util.decreaseSymbolOpacity(this.getSymbol(),.5);this._movingTail=new e.LineString(o,{symbol:s}),this._addGeometryToStage(this._movingTail)}t.geometry=this._geometry,this._fireEvent("mousemove",t)}}},_dblclickForPath:function(t){if(this._geometry){var i=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(i)){var n=this._containerPointToLonlat(i),r=this._getLonlats();if(r.push(n),!(r.length<2)){var o,s,a=[];for(o=1,s=r.length;s>o;o++)r[o].x===r[o-1].x&&r[o].y===r[o-1].y&&a.push(o);for(o=a.length-1;o>=0;o--)r.splice(a[o],1);if(!(r.length<2||"polygon"===this.options.mode&&r.length<3)){if(this._geometry.remove(),this._movingTail&&this._movingTail.remove(),delete this._movingTail,this._polygon&&this._polygon.remove(),"polygon"===this.options.mode){this._geometry=new e.Polygon([r]);var h=this.getSymbol();h&&this._geometry.setSymbol(h),this._addGeometryToStage(this._geometry)}else this._geometry.setCoordinates(r);this._endDraw(t)}}}}},_mousedownToDraw:function(t){function i(t){var i,n=r.getSymbol(),o=r._geometry,s=r._map;switch(r.options.mode){case"circle":if(!o){o=new e.Circle(t,0),o.setSymbol(n),r._addGeometryToStage(o);break}i=o.getCenter();var a=s.computeLength(i,t);o.setRadius(a);break;case"ellipse":if(!o){o=new e.Ellipse(t,0,0),o.setSymbol(n),r._addGeometryToStage(o);break}i=o.getCenter();var h=s.computeLength(i,new e.Coordinate({x:t.x,y:i.y})),l=s.computeLength(i,new e.Coordinate({x:i.x,y:t.y}));o.setWidth(2*h),o.setHeight(2*l);break;case"rectangle":if(!o){o=new e.Rectangle(t,0,0),o.setSymbol(n),r._addGeometryToStage(o);break}var u=o.getCoordinates(),c=s.computeLength(u,new e.Coordinate({x:t.x,y:u.y})),d=s.computeLength(u,new e.Coordinate({x:u.x,y:t.y}));o.setWidth(c),o.setHeight(d)}r._geometry=o}function n(t){if(!this._geometry)return!1;var e=this._getMouseContainerPoint(t);if(!this._isValidContainerPoint(e))return!1;var n=this._containerPointToLonlat(e);return i(n),!1}var r=this,o=function(e){if(!this._geometry)return!1;var r=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(r)){var s=this._containerPointToLonlat(r);i(s)}return this._map.off("mousemove",n,this),this._map.off("mouseup",o,this),this._endDraw(t),!1},s=this._getMouseContainerPoint(t);if(!this._isValidContainerPoint(s))return!1;var a=this._containerPointToLonlat(s);return this._fireEvent("drawstart",t),i(a),this._map.on("mousemove",n,this),this._map.on("mouseup",o,this),!1},_endDraw:function(t){if(this._geometry){var e=this._geometry.copy();this._geometry.remove(),delete this._geometry,t||(t={}),t.geometry=e,this._fireEvent("drawend",t),this.options.once&&this.disable()}},_getLonlats:function(){return this._geometry.getShell?this._geometry.getShell():this._geometry.getCoordinates()},_setLonlats:function(t){this._geometry instanceof e.Polygon?this._geometry.setCoordinates([t]):this._geometry instanceof e.Polyline&&this._geometry.setCoordinates(t),this._polygon&&this._polygon.setCoordinates([t])},_getMouseContainerPoint:function(t){e.DomUtil.stopPropagation(t.domEvent);var i=t.containerPoint;return i},_containerPointToLonlat:function(t){var e=this._getProjection(),i=this._map,n=i._containerPointToPrj(t);return e.unproject(n)},_isValidContainerPoint:function(t){var e=this._map.getSize(),i=e.width,n=e.height;return t.x<0||t.y<0?!1:!(t.x>i||t.y>n)},_getDrawLayer:function(){var t=e.internalLayerPrefix+"drawtool",i=this._map.getLayer(t);return i||(i=new e.VectorLayer(t,{drawImmediate:!0}),this._map.addLayer(i)),i},_fireEvent:function(t,e){e||(e={}),!e.geometry&&this._geometry&&(e.geometry=this._geometry),this.fire(t,e)}}),e.DistanceTool=e.DrawTool.extend({options:{mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:10,markerHeight:10},labelOptions:{symbol:{textWrapCharacter:"\n",textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",markerLineColor:"#b4b3b3",textDx:15},boxPadding:new e.Size(6,4)}},initialize:function(t){e.Util.setOptions(this,t),this.on("enable",this._afterEnable,this).on("disable",this._afterDisable,this),this._measureLayers=[]},clear:function(){if(e.Util.isArrayHasData(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},getMeasureLayers:function(){return this._measureLayers},getLastMeasure:function(){return this._lastMeasure?this._lastMeasure:0},_measure:function(t){var i,n=this.getMap();t instanceof e.Geometry?i=n.computeGeometryLength(t):e.Util.isArray(t)&&(i=e.GeoUtils.computeLength(t,n.getProjection())),this._lastMeasure=i;var r;r="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];var o="";return this.options.metric&&(o+=1e3>i?i.toFixed(0)+r[0]:(i/1e3).toFixed(2)+r[1]),this.options.imperial&&(i*=3.2808399,o.length>0&&(o+="\n"),o+=5280>i?i.toFixed(0)+r[2]:(i/5280).toFixed(2)+r[3]),o},_registerMeasureEvents:function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},_afterEnable:function(){this._registerMeasureEvents()},_afterDisable:function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},_msOnDrawStart:function(t){var i=this.getMap(),n=e.Util.GUID(),r="distancetool_"+n,o="distancetool_markers_"+n;i.getLayer(r)?(this._measureLineLayer=i.getLayer(r),this._measureMarkerLayer=i.getLayer(o)):(this._measureLineLayer=new maptalks.VectorLayer(r,{drawImmediate:!0}).addTo(i),this._measureMarkerLayer=new maptalks.VectorLayer(o,{drawImmediate:!0}).addTo(i)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),new maptalks.Marker(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var s="zh-CN"===this.options.language?"":"start",a=new maptalks.Label(s,t.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(a)},_msOnMouseMove:function(t){var i=this._measure(t.geometry.getCoordinates().concat([t.coordinate]));if(!this._tailMarker){var n=e.Util.extendSymbol(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new maptalks.Marker(t.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new maptalks.Label(i,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}this._tailMarker.setCoordinates(t.coordinate),this._tailLabel.setContent(i),this._tailLabel.setCoordinates(t.coordinate)},_msOnDrawVertex:function(t){var e=t.geometry;new maptalks.Marker(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var i=this._measure(e),n=new maptalks.Label(i,t.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(n),this._lastVertex=n},_msOnDrawEnd:function(t){this._clearTailMarker();var i=this._lastVertex.getSize();i||(i=new e.Size(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),i.width);var n=t.geometry.copy();n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},_addClearMarker:function(t,e){var i=new maptalks.Marker(t,{symbol:[{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20+e},{markerType:"square",markerFill:"#ffffff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20+e}]}),n=this._measureLineLayer,r=this._measureMarkerLayer;i.on("click",function(){return n.remove(),r.remove(),!1},this),i.addTo(this._measureMarkerLayer)},_clearTailMarker:function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)}}),e.AreaTool=e.DistanceTool.extend({options:{mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}},initialize:function(t){e.Util.setOptions(this,t),this.on("enable",this._afterEnable,this).on("disable",this._afterDisable,this),this._measureLayers=[]},_measure:function(t){var i,n=this.getMap();t instanceof e.Geometry?i=n.computeGeometryArea(t):e.Util.isArray(t)&&(i=e.GeoUtils.computeArea(t,n.getProjection())),this._lastMeasure=i;var r;r="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var o="";if(this.options.metric&&(o+=1e6>i?i.toFixed(0)+r[0]:(i/1e6).toFixed(2)+r[1]),this.options.imperial){i*=3.2808399,o.length>0&&(o+="\n");var s=27878400;o+=s>i?i.toFixed(0)+r[2]:(i/s).toFixed(2)+r[3]}return o},_msOnDrawVertex:function(t){var e=new maptalks.Marker(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);this._lastVertex=e},_msOnDrawEnd:function(t){this._clearTailMarker();var i=this._measure(t.geometry),n=new maptalks.Label(i,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer),r=n.getSize();r||(r=new e.Size(10,10)),this._addClearMarker(t.coordinate,r.width);var o=t.geometry.copy();o.addTo(this._measureLineLayer),this._lastMeasure=o.getArea()}}),e.TileSystem=function(t,i,n,r){e.Util.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:i},this.origin={x:n,y:r})},e.Util.extend(e.TileSystem,{"web-mercator":new e.TileSystem([1,-1,-20037508.34,20037508.34]),"tms-global-mercator":new e.TileSystem([1,1,-20037508.34,-20037508.34]),"tms-global-geodetic":new e.TileSystem([1,1,-180,-90]),baidu:new e.TileSystem([1,1,0,0])}),e.TileSystem.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"web-mercator"},e.TileConfig=e.Class.extend({statics:{},exceptionDefs:{"en-US":{INVALID_TILESYSTEM:"Invalid TileSystem"},"zh-CN":{INVALID_TILESYSTEM:"TileSystem"}},initialize:function(t,e,i){this.tileSize=i,this.fullExtent=e,this.prepareTileInfo(t,e)},prepareTileInfo:function(t,i){if(e.Util.isString(t)?t=e.TileSystem[t.toLowerCase()]:e.Util.isArray(t)&&(t=new e.TileSystem(t)),!t)throw new Error(this.exceptions.INVALID_TILESYSTEM);this.tileSystem=t;var n=i.right>i.left?1:-1,r=i.top>i.bottom?-1:1,o=t.origin.x,s=t.origin.y;this.transformation=new e.Transformation([n,r,o,s]),t.transOrigin=this.transformation.transform(t.origin,1)},getTileIndex:function(t,e){var i=this.tileSystem,n=this.tileSize,r=i.transOrigin,o=1e-7,s=Math.floor(o+(t.x-r.x)/(n.width*e)),a=-Math.floor(o+(t.y-r.y)/(n.height*e));return{x:i.scale.x*s,y:i.scale.y*a}},getCenterTile:function(t,e){var i=this.tileSystem,n=this.tileSize,r=this.transformation.transform(t,1),o=this.getTileIndex(r,e),s=o.x*n.width,a=o.y*n.height,h=Math.round(r.x/e-i.scale.x*s),l=Math.round(r.y/e+i.scale.y*a);return i.scale.x<0&&(o.x-=1),i.scale.y>0&&(o.y-=1),o=this.getNeighorTileIndex(o.y,o.x,0,0,!0),{x:o.x,y:o.y,offsetLeft:h,offsetTop:l}},getNeighorTileIndex:function(t,e,i,n,r,o){var s=this.tileSystem,a=e+s.scale.x*n,h=t-s.scale.y*i;if(o){var l=this._getTileFullIndex(r);a<l.xmin?(a=l.xmax-(l.xmin-a)%(l.xmax-l.xmin),a===l.xmax&&(a=l.xmin)):a>=l.xmax&&(a=l.xmin+(a-l.xmin)%(l.xmax-l.xmin)),h>=l.ymax?h=l.ymin+(h-l.ymin)%(l.ymax-l.ymin):h<l.ymin&&(h=l.ymax-(l.ymin-h)%(l.ymax-l.ymin),h===l.ymax&&(h=l.ymin))}return{x:a,y:h}},_getTileFullIndex:function(t){var i=this.fullExtent,n=this.transformation,r=this.getTileIndex(n.transform(new e.Coordinate(i.left,i.right),1),t),o=this.getTileIndex(n.transform(new e.Coordinate(i.right,i.bottom),1),t);return new e.Extent(r,o)},getTileProjectedSw:function(t,e,i){var n=this.tileSystem,r=this.tileSize,o=n.origin.y+n.scale.y*(t+(1===n.scale.y?0:1))*(i*r.height),s=n.scale.x*(e+(1===n.scale.x?0:1))*i*r.width+n.origin.x;return[s,o]}}),"undefined"!=typeof Promise?e.Promise=Promise:!function(t){function e(t){if(t){var e=this;t(function(t){e.resolve(t)},function(t){e.reject(t)})}}function i(t,e){if("function"==typeof t.y)try{var i=t.y.call(o,e);t.p.resolve(i)}catch(n){t.p.reject(n)}else t.p.resolve(e)}function n(t,e){if("function"==typeof t.n)try{var i=t.n.call(o,e);t.p.resolve(i)}catch(n){t.p.reject(n)}else t.p.reject(e)}var r,o,s="fulfilled",a="rejected",h="undefined",l=function(){function t(){for(;e.length-i;)e[i](),e[i++]=o,i==n&&(e.splice(0,n),i=0)}var e=[],i=0,n=1024,r=function(){if(typeof MutationObserver!==h){var e=document.createElement("div"),i=new MutationObserver(t);return i.observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return typeof setImmediate!==h?function(){setImmediate(t)}:function(){setTimeout(t,0)}}();return function(t){e.push(t),e.length-i==1&&r()}}();e.prototype={resolve:function(t){if(this.state===r){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==typeof t))try{var n=!0,o=t.then;if("function"==typeof o)return void o.call(t,function(t){n&&(n=!1,e.resolve(t))},function(t){n&&(n=!1,e.reject(t))})}catch(a){return void(n&&this.reject(a))}this.state=s,this.v=t,e.c&&l(function(){for(var n=0,r=e.c.length;r>n;n++)i(e.c[n],t)})}},reject:function(t){if(this.state===r){this.state=a,this.v=t;var i=this.c;i?l(function(){for(var e=0,r=i.length;r>e;e++)n(i[e],t)}):e.suppressUncaughtRejectionError||console.log("You upset Zousan. Please catch rejections: ",t,t.stack)}},then:function(t,o){var a=new e,h={y:t,n:o,p:a};if(this.state===r)this.c?this.c.push(h):this.c=[h];else{var u=this.state,c=this.v;l(function(){u===s?i(h,c):n(h,c)})}return a},"catch":function(t){return this.then(null,t)},"finally":function(t){return this.then(t,t)},timeout:function(t,i){i=i||"Timeout";var n=this;return new e(function(e,r){setTimeout(function(){r(Error(i))},t),n.then(function(t){e(t)},function(t){r(t)})})}},e.resolve=function(t){var i=new e;return i.resolve(t),i},e.reject=function(t){var i=new e;return i.reject(t),i},e.all=function(t){function i(i,s){"function"!=typeof i.then&&(i=e.resolve(i)),i.then(function(e){n[s]=e,r++,r==t.length&&o.resolve(n)},function(t){o.reject(t)})}for(var n=[],r=0,o=new e,s=0;s<t.length;s++)i(t[s],s);return t.length||o.resolve(n),o},t.Promise=e}(e),e.Renderable={registerRenderer:function(t,e){return this._regRenderers||(this._regRenderers={}),this._regRenderers[t.toLowerCase()]=e,this},getRendererClass:function(t){return this._regRenderers?this._regRenderers[t.toLowerCase()]:null}},e.Layer=e.Class.extend({includes:e.Eventable,options:{minZoom:null,maxZoom:null,visible:!0,opacity:1,renderer:"canvas"},initialize:function(t,i){this.setId(t),e.Util.setOptions(this,i)},load:function(){if(!this.getMap())return this;this._initRenderer();var t=this.getZIndex();return this._prepareLoad()&&this._renderer&&(e.Util.isNil(t)||this._renderer.setZIndex(t),this._renderer.render()),this},getId:function(){return this._id},setId:function(t){var e=this._id;return this._id=t,this.fire("idchange",{old:e,"new":t}),this},addTo:function(t){return t.addLayer(this),this},setZIndex:function(t){if(this._zIndex=t,this.map){var e=this._getLayerList();this.map._sortLayersByZIndex(e)}return this._renderer&&this._renderer.setZIndex(t),this},getZIndex:function(){return this._zIndex},isCanvasRender:function(){var t=this._getRenderer();return t?t.isCanvasRender():!1},getMap:function(){return this.map?this.map:null},bringToFront:function(){var t=this._getLayerList();if(!t)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i+1),this},bringToBack:function(){var t=this._getLayerList();if(!t)return this;var e=t[0];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i-1),this},show:function(){return this.options.visible||(this.options.visible=!0,this._getRenderer()&&this._getRenderer().show()),this.fire("show"),this},hide:function(){return this.options.visible&&(this.options.visible=!1,this._getRenderer()&&this._getRenderer().hide()),this.fire("hide"),this},isLoaded:function(){return this._renderer?this._renderer.isLoaded():!1},isVisible:function(){if(e.Util.isNumber(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var i=t.getZoom();if(!e.Util.isNil(this.options.maxZoom)&&this.options.maxZoom<i||!e.Util.isNil(this.options.minZoom)&&this.options.minZoom>i)return!1}return e.Util.isNil(this.options.visible)&&(this.options.visible=!0),this.options.visible},remove:function(){return this.map&&this.map.removeLayer(this),this},getMask:function(){return this._mask},setMask:function(t){if(!(t instanceof e.Marker&&e.symbolizer.VectorMarkerSymbolizer.test(t.getSymbol())||t instanceof e.Polygon||t instanceof e.MultiPolygon))throw new Error("mask has to be a Marker with vector symbol, a Polygon or a MultiPolygon");return t instanceof e.Marker?t.setSymbol(e.Util.extendSymbol(t.getSymbol(),{markerLineWidth:0,markerFillOpacity:1})):t.setSymbol({lineWidth:0,polygonOpacity:1}),t._bindLayer(this),this._mask=t,!this.getMap()||this.getMap()._isBusy()?this:(this._getRenderer()&&this._getRenderer().render(),this)},removeMask:function(){return delete this._mask,!this.getMap()||this.getMap()._isBusy()?this:(this._getRenderer()&&this._getRenderer().render(),this)},_refreshMask:function(){this._mask&&this._mask._onZoomEnd()},_prepareLoad:function(){return!0},_onRemove:function(){this._switchEvents("off",this),this._removeEvents(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map},_bindMap:function(t,e){t&&(this.map=t,this.setZIndex(e),this._registerEvents(),this._getEvents&&this._getEvents()&&this._switchEvents("on",this),this.fire("add"))},_initRenderer:function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);e&&(this._renderer=new e(this),this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer))}},_switchEvents:function(t,e){if(e&&e._getEvents){var i=e._getEvents();if(i){var n=this.getMap();for(var r in i)i.hasOwnProperty(r)&&n[t](r,i[r],e)}}},_registerEvents:function(){this.getMap().on("_zoomend",this._refreshMask,this)},_removeEvents:function(){this.getMap().off("_zoomend",this._refreshMask,this)},_getRenderer:function(){return this._renderer},_getLayerList:function(){return this.map?this.map._layers:null}}),e.Util.extend(e.Layer,e.Renderable),e.TileLayer=e.Layer.extend({options:{errorTileUrl:null,urlTemplate:null,subdomains:null,gradualLoading:!0,repeatWorld:!0,renderWhenPanning:!1,renderSpanWhenPanning:function(){return e.Browser.mobile?-1:100}(),crossOrigin:null,tileSize:{width:256,height:256},tileSystem:null,debug:!1,baseLayerRenderer:function(){return e.node?"canvas":"dom"}(),renderer:"canvas"},getTileSize:function(){var t=this.options.tileSize;return new e.Size(t.width,t.height)},clear:function(){return this._renderer&&this._renderer.clear(),this.fire("clear"),this},_initRenderer:function(){var t=this.options.renderer;if(this.getMap().getBaseLayer()===this&&(t=this.options.baseLayerRenderer,this.getMap()._getRenderer()._isCanvasContainer&&(t="canvas")),this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);e&&(this._renderer=new e(this),this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer))}},_initTileConfig:function(){var t=this.getMap();this._defaultTileConfig=new e.TileConfig(e.TileSystem.getDefault(t.getProjection()),t.getFullExtent(),this.getTileSize()),this.options.tileSystem&&(this._tileConfig=new e.TileConfig(this.options.tileSystem,t.getFullExtent(),this.getTileSize()))},_getTileConfig:function(){this._defaultTileConfig||this._initTileConfig();var t=this._tileConfig;if(t)return t;var e=this.getMap();return e&&e.getBaseLayer()&&e.getBaseLayer()._getTileConfig?e.getBaseLayer()._getTileConfig():this._defaultTileConfig},_getTiles:function(t){var i=this.getMap();if(!i)return null;if(!this.isVisible())return null;var n=this._getTileConfig();if(!n)return null;var r=this.getTileSize(),o=i.getZoom(),s=i._getResolution(),a=i.offsetPlatform(),h=i.width,l=i.height,u=n.getCenterTile(i._getPrjCenter(),s),c=new e.Point(+(h/2-u.offsetLeft),+(l/2-u.offsetTop))._round();t&&t instanceof e.Size||(t=new e.Size(h,l));for(var d=Math.ceil(Math.abs((t.height-l)/2+c.y)/r.height),f=Math.ceil(Math.abs((t.width-h)/2+c.x)/r.width),m=Math.ceil(Math.abs((t.height-l)/2+l-c.y)/r.height),_=Math.ceil(Math.abs((t.width-h)/2+h-c.x)/r.width),g=[],p=new e.PointExtent,y=-f;_>y;y++)for(var v=-d;m>=v;v++){var x=n.getNeighorTileIndex(u.y,u.x,v,y,s,this.options.repeatWorld),w=c.x+r.width*y-a.x,C=c.y+r.height*v-a.y,b=this._getTileUrl(x.x,x.y,o),P=[x.y,x.x,o,w,C].join("__"),M={url:b,viewPoint:new e.Point(w,C),id:P,zoom:o};g.push(M),p=p.combine(new e.PointExtent(M.viewPoint,M.viewPoint.add(r.width,r.height)))}return g.sort(function(t,e){return e.viewPoint.distanceTo(c)-t.viewPoint.distanceTo(c)}),{tiles:g,fullExtent:p}},_getTileUrl:function(t,i,n){if(!this.options.urlTemplate)return this.options.errorTileUrl;var r=this.options.urlTemplate;if(e.Util.isFunction(r))return r(t,i,n);var o="";if(this.options.subdomains){var s=this.options.subdomains;if(e.Util.isArrayHasData(s)){var a=s.length,h=(t+i)%a;0>h&&(h=0),o=s[h]}}var l={x:t,y:i,z:n,s:o};return r.replace(/\{ *([\w_]+) *\}/g,function(t,e){var i=l[e];if(void 0===i)throw new Error("No value provided for variable "+t);return"function"==typeof i&&(i=i(l)),i})}}),e.TileLayer.prototype.toJSON=function(){var t={type:"TileLayer",id:this.getId(),options:this.config()};return t},e.TileLayer._fromJSON=function(t){return t&&"TileLayer"===t.type?new e.TileLayer(t.id,t.options):null},e.CanvasTileLayer=e.TileLayer.extend({}),e.CanvasTileLayer.prototype.toJSON=function(){var t={type:"CanvasTileLayer",id:this.getId(),options:this.config()};return t},e.CanvasTileLayer._fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e.CanvasTileLayer(t.id,t.options):null},e.OverlayLayer=e.Layer.extend({exceptionDefs:{"en-US":{DUPLICATE_GEOMETRY_ID:"Duplicate ID for the geometry",INVALID_GEOMETRY:"invalid geometry to add to layer."},"zh-CN":{DUPLICATE_GEOMETRY_ID:"Geometry ID",INVALID_GEOMETRY:"Geometry, ."}},getGeometryById:function(t){return this._getGeometryById(t)},getGeometries:function(t,e){return this._getGeometries(t,e)},getCount:function(){return this._counter?this._counter:0},forEach:function(t,e){var i=this._geoCache,n=0;for(var r in i)i.hasOwnProperty(r)&&(e?t.call(e,i[r],n++):t(i[r],n++));return this},filter:function(t,i){var n=[];if(e.Util.isFunction(t))t&&this.forEach(function(e){(i?t.call(i,e):t(e))&&n.push(e)});else{var r=e.Util.createFilter(t);this.forEach(function(t){var i=e.Util.getFilterFeature(t);r(i)&&n.push(t)},this)}return n.length>0?new e.GeometryCollection(n):null},isEmpty:function(){return 0===this._counter},addGeometry:function(t,e){return this._addGeometry(t,e)},removeGeometry:function(t){return this._removeGeometry(t)},clear:function(){return this._clear()},_initCache:function(){this._geoCache||(this._geoCache={},this._geoMap={},this._counter=0)},_getGeometryById:function(t){return e.Util.isNil(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},_getGeometries:function(t,e){var i,n=this._geoCache,r=[];for(var o in n)if(n.hasOwnProperty(o)){if(i=n[o],t){var s;if(s=e?t.call(e,i):t(i),!s)continue}r.push(i)}return r},_addGeometry:function(t,i){if(!t)return this;if(!e.Util.isArray(t))return this._addGeometry([t],i);if(!e.Util.isArrayHasData(t))return this;this._initCache();for(var n,r,o,s,a,h=0,l=new e.Coordinate(0,0),u=null,c=this.getStyle?this.getStyle():null,d=0,f=t.length;f>d;d++){if(n=t[d],n instanceof e.Geometry||(n=e.Geometry.fromJSON(n)),!n)throw new Error(this.exceptions.INVALID_GEOMETRY);if(r=n.getId(),!e.Util.isNil(r)){if(!e.Util.isNil(this._geoMap[r]))throw new Error(this.exceptions.DUPLICATE_GEOMETRY_ID+":"+r);this._geoMap[r]=n}o=e.Util.GUID(),n._setInternalId(o),this._geoCache[o]=n,this._counter++,n._bindLayer(this),i&&(s=n.getCenter(),a=n.getExtent(),s&&a&&(l._add(s),u=null==u?a:u._combine(a),h++)),c&&this._styleGeometry(n),n._fireEvent("addend",{geometry:n})}var m=this.getMap();if(m&&(this._getRenderer().render(t),i&&u)){var _=m.getFitZoom(u),g=l._multi(1/h);m.setCenterAndZoom(g,_)}return this.fire("addgeo",{geometries:t}),this},_removeGeometry:function(t){if(!e.Util.isArray(t))return this._removeGeometry([t]);for(var i=t.length-1;i>=0;i--)t[i]instanceof e.Geometry||(t[i]=this.getGeometryById(t[i])),t[i]&&this===t[i].getLayer()&&t[i].remove();return this.fire("removegeo",{geometries:t}),this},_clear:function(){return this.forEach(function(t){t.remove()}),this._geoMap={},this._geoCache={},this.fire("clear"),this},_onGeometryRemove:function(t){if(t&&this===t.getLayer()){var i=t._getInternalId();if(!e.Util.isNil(i)){var n=t.getId();e.Util.isNil(n)||delete this._geoMap[n],delete this._geoCache[i],this._counter--,this._getRenderer()&&this._getRenderer().render()}}}}),e.OverlayLayer.addInitHook(function(){this._initCache()}),e.VectorLayer=e.OverlayLayer.extend({options:{debug:!1,enableSimplify:!0,cursor:"pointer",geometryEvents:!0,thresholdOfTransforming:150,drawImmediate:!1,drawOnce:!1,defaultIconSize:[20,20],cacheSvgOnCanvas:!0},getStyle:function(){return this._style?this._style:null},setStyle:function(t){return this._style=t,this._cookedStyles=this._compileStyle(t),this.forEach(function(t){this._styleGeometry(t)},this),this},removeStyle:function(){return this._style?(delete this._style,delete this._cookedStyles,this.forEach(function(t){t._setExternSymbol(null)},this),this):this},_styleGeometry:function(t){for(var i=e.Util.getFilterFeature(t),n=0,r=this._cookedStyles.length;r>n;n++)if(this._cookedStyles[n].filter(i)===!0)return t._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},_compileStyle:function(t){if(!e.Util.isArray(t))return this._compileStyle([t]);for(var i=[],n=0;n<t.length;n++)i.push({filter:e.Util.createFilter(t[n].filter),symbol:t[n].symbol});return i}}),e.VectorLayer.prototype.toJSON=function(t){t||(t={});var i={type:"VectorLayer",id:this.getId(),options:this.config()};if((e.Util.isNil(t.style)||t.style)&&this.getStyle()&&(i.style=this.getStyle()),e.Util.isNil(t.geometries)||t.geometries){var n;t.clipExtent&&(n=new e.Extent(t.clipExtent));for(var r,o,s=[],a=this.getGeometries(),h=0,l=a.length;l>h;h++)r=a[h].getExtent(),!r||n&&!n.intersects(r)||(o=a[h].toJSON(t.geometries),o.symbol&&this.getStyle()&&(o.symbol=a[h]._symbolBeforeStyle?e.Util.extend({},a[h]._symbolBeforeStyle):null),s.push(o));i.geometries=s}return i},e.VectorLayer._fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var i,n=new e.VectorLayer(t.id,t.options),r=t.geometries,o=[],s=0;s<r.length;s++)i=e.Geometry.fromJSON(r[s]),i&&o.push(i);return n.addGeometry(o),t.style&&n.setStyle(t.style),n},e.GeoJSONLayer=e.VectorLayer.extend({initialize:function(t,i,n){this.setId(t),e.Util.setOptions(this,n);var r=this._parse(i);this.addGeometry(r)},_parse:function(t){return t=e.Util.parseJSON(t),e.Geometry.fromJSON(t)},toJSON:function(t){var i=e.VectorLayer.prototype.toJSON.call(this,t);i.type="GeoJSONLayer";var n=[];if(i.geometries){for(var r,o=0,s=i.geometries.length;s>o;o++)r=i.geometries[o].feature,r.id||r.properties||(r=r.geometry),n.push(r);delete i.geometries}return i.geojson=n,i}}),e.GeoJSONLayer._fromJSON=function(t){if(!t||"GeoJSONLayer"!==t.type)return null;var i=new e.GeoJSONLayer(t.id,t.geojson,t.options);return t.style&&i.setStyle(t.style),i},e.Geometry=e.Class.extend({includes:[e.Eventable,e.Handlerable],exceptionDefs:{"en-US":{DUPLICATE_LAYER:"Geometry cannot be added to two or more layers at the same time.",INVALID_GEOMETRY_IN_COLLECTION:"Geometry is not valid for collection,index:",NOT_ADD_TO_LAYER:"This operation needs geometry to be on a layer."
},"zh-CN":{DUPLICATE_LAYER:"Geometry.",INVALID_GEOMETRY_IN_COLLECTION:"Geometry, index:",NOT_ADD_TO_LAYER:"Geometry."}},statics:{TYPE_POINT:"Point",TYPE_LINESTRING:"LineString",TYPE_POLYGON:"Polygon",TYPE_MULTIPOINT:"MultiPoint",TYPE_MULTILINESTRING:"MultiLineString",TYPE_MULTIPOLYGON:"MultiPolygon",TYPE_GEOMETRYCOLLECTION:"GeometryCollection"},options:{id:null,visible:!0,editable:!0,cursor:null,shadowBlur:0,shadowColor:"black",measure:"EPSG:4326"},addTo:function(t,e){return t.addGeometry(this,e),this},getLayer:function(){return this._layer?this._layer:null},getMap:function(){return this._layer?this._layer.getMap():null},getId:function(){return this._id},setId:function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,"new":t}),this},getProperties:function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},setProperties:function(t){var i=this.properties;return this.properties=e.Util.isObject(t)?e.Util.extend({},t):t,this._fireEvent("propertieschange",{old:i,"new":t}),this},getType:function(){return this.type},getSymbol:function(){var t=this._symbol;return t?e.Util.isArray(t)?e.Util.extendSymbol(t):e.Util.extend({},t):null},setSymbol:function(t){return this._symbol=this._prepareSymbol(t),this._onSymbolChanged(),this},getFirstCoordinate:function(){if(this instanceof e.GeometryCollection){var t=this.getGeometries();return t&&e.Util.isArrayHasData(t)?t[0].getFirstCoordinate():null}var i=this.getCoordinates();if(!e.Util.isArray(i))return i;var n=i;do n=n[0];while(e.Util.isArray(n));return n},getLastCoordinate:function(){if(this instanceof e.GeometryCollection){var t=this.getGeometries();return t&&e.Util.isArrayHasData(t)?t[t.length-1].getLastCoordinate():null}var i=this.getCoordinates();if(!e.Util.isArray(i))return i;var n=i;do n=n[n.length-1];while(e.Util.isArray(n));return n},getExtent:function(){var t=this._getPrjExtent();if(t){var i=this._getProjection();return new e.Extent(i.unproject(new e.Coordinate(t.xmin,t.ymin)),i.unproject(new e.Coordinate(t.xmax,t.ymax)))}return this._computeExtent(this._getMeasurer())},containsPoint:function(t,e){if(!this.getMap())throw new Error('The geometry is required to be on a map to perform "containsPoint".');return this._containsPoint(this.getMap().containerPointToViewPoint(t),e)},getSize:function(){var t=this.getMap();if(!t)return null;var i=this._getPainter().getViewExtent();return new e.Size(Math.round(Math.abs(i.xmax-i.xmin)),Math.round(Math.abs(i.ymax-i.ymin)))},getCenter:function(){return this._computeCenter(this._getMeasurer()).copy()},show:function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},hide:function(){if(this.options.visible=!1,this.getMap()){var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},isVisible:function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(e.Util.isArray(t)){if(0===t.length)return!0;for(var i=0,n=t.length;n>i;i++)if(e.Util.isNil(t[i].opacity)||t[i].opacity>0)return!0;return!1}return e.Util.isNil(t.opacity)||e.Util.isNumber(t.opacity)&&t.opacity>0},translate:function(t){if(!t)return this;if(t=new e.Coordinate(t),0===t.x&&0===t.y)return this;var i=this.getCoordinates();if(i)if(e.Util.isArray(i)){var n=e.Util.mapArrayRecursively(i,function(e){return e.add(t)});this.setCoordinates(n)}else this.setCoordinates(i.add(t));return this},flash:function(t,e,i,n){function r(){return 0===e?(o.show(),void(i&&(n?i.call(n):i()))):(e%2===0?o.hide():o.show(),e--,void(o._flashTimeout=setTimeout(r,t)))}t||(t=100),e||(e=4);var o=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout(r,t),this},copy:function(){var t=this.toJSON(),i=e.Geometry.fromJSON(t);return i.options.visible=!0,i},remove:function(){var t=this.getLayer();return t?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("remove"),this):this},toGeoJSONGeometry:function(){var t=this._exportGeoJSONGeometry();return t},toGeoJSON:function(t){t||(t={});var i={type:"Feature",geometry:null};if(e.Util.isNil(t.geometry)||t.geometry){var n=this._exportGeoJSONGeometry();i.geometry=n}var r=this.getId();e.Util.isNil(r)||(i.id=r);var o;return(e.Util.isNil(t.properties)||t.properties)&&(o=this._exportProperties()),i.properties=o,i},toJSON:function(t){t||(t={});var i=this._toJSON(t),n=this._exportGraphicOptions(t);return e.Util.extend(i,n),i},getLength:function(){return this._computeGeodesicLength(this._getMeasurer())},getArea:function(){return this._computeGeodesicArea(this._getMeasurer())},_getConnectPoints:function(){return[this.getCenter()]},_initOptions:function(t){t||(t={});var i=t.symbol,n=t.properties,r=t.id;e.Util.setOptions(this,t),delete this.options.symbol,delete this.options.id,delete this.options.properties,i&&this.setSymbol(i),n&&this.setProperties(n),e.Util.isNil(r)||this.setId(r)},_bindLayer:function(t){if(this.getLayer())throw new Error(this.exceptions.DUPLICATE_LAYER);this._layer=t,this._clearProjection(),this.callInitHooks()},_prepareSymbol:function(t){if(e.Util.isArray(t)){for(var i=[],n=0;n<t.length;n++)i.push(e.Util.convertResourceUrl(t[n]));return i}return e.Util.convertResourceUrl(t)},_setExternSymbol:function(t){return this._externSymbol=this._prepareSymbol(t),this._onSymbolChanged(),this},_getInternalSymbol:function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},_getPrjExtent:function(){var t=this._getProjection();if(!this._extent&&t){var i=this._computeExtent(t);if(i){var n=this.options.antiMeridian;if(n&&"default"!==n){var r=this.getFirstCoordinate();if("continuous"===n&&i.xmax-i.xmin>180&&(r.x>0?i.xmin+=360:i.xmax-=360),i.xmax<i.xmin){var o=i.xmax;i.xmax=i.xmin,i.xmin=o}}this._extent=new e.Extent(t.project(new e.Coordinate(i.xmin,i.ymin)),t.project(new e.Coordinate(i.xmax,i.ymax)))}}return this._extent},_unbind:function(){var t=this.getLayer();t&&(this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this._onRemove&&this._onRemove(),t._onGeometryRemove(this),delete this._layer,delete this._internalId,delete this._extent)},_getInternalId:function(){return this._internalId},_setInternalId:function(t){this._internalId=t},_getMeasurer:function(){return this._getProjection()?this._getProjection():e.MeasurerUtil.getInstance(this.options.measure)},_getProjection:function(){var t=this.getMap();return t&&t.getProjection()?t.getProjection():null},_getExternalResources:function(){var t=this,i=t._getInternalSymbol(),n=e.Util.getExternalResources(this._interpolateSymbol(i));return n},_interpolateSymbol:function(t){var i;if(e.Util.isArray(t)){i=[];for(var n=0;n<t.length;n++)i.push(this._interpolateSymbol(t[n]));return i}i={};for(var r in t)t.hasOwnProperty(r)&&(e.Util.isFunctionDefinition(t[r])?this.getMap()?i[r]=e.Util.interpolated(t[r])(this.getMap().getZoom(),this.getProperties()):i[r]=null:i[r]=t[r]);return i},_getPainter:function(){return this.getMap()&&!this._painter&&(this instanceof e.GeometryCollection?this._painter=new e.CollectionPainter(this):this._painter=new e.Painter(this)),this._painter},_removePainter:function(){this._painter&&this._painter.remove(),delete this._painter},_onZoomEnd:function(){this._painter&&this._painter.onZoomEnd()},_isEditingOrDragging:function(){return this.isEditing&&this.isEditing()||this.isDragging&&this.isDragging()},_onShapeChanged:function(){this._extent=null;var t=this._getPainter();t&&t.repaint(),this._fireEvent("shapechange")},_onPositionChanged:function(){this._extent=null;var t=this._getPainter();t&&t.repaint(),this._fireEvent("positionchange")},_onSymbolChanged:function(){var t=this._getPainter();t&&t.refreshSymbol(),this._fireEvent("symbolchange")},_setParent:function(t){t&&(this._parent=t)},_getParent:function(){return this._parent},_fireEvent:function(t,e){this.fire(t,e)},_toJSON:function(t){return{feature:this.toGeoJSON(t)}},_exportGraphicOptions:function(t){var i={};return(e.Util.isNil(t.options)||t.options)&&(i.options=this.config()),(e.Util.isNil(t.symbol)||t.symbol)&&(i.symbol=this.getSymbol()),(e.Util.isNil(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(i.infoWindow=this._infoWinOptions),i},_exportGeoJSONGeometry:function(){var t=this.getCoordinates(),i=e.GeoJSON.toNumberArrays(t);return{type:this.getType(),coordinates:i}},_exportProperties:function(){var t=null,i=this.getProperties();return i&&(e.Util.isObject(i)?t=e.Util.extend({},i):i=t),t}}),e.Geometry.fromJSON=function(t){if(e.Util.isArray(t)){for(var i,n=[],r=0,o=t.length;o>r;r++)i=e.Geometry.fromJSON(t[r]),e.Util.isArray(t)?n=n.concat(i):n.push(i);return n}if(t&&!t.feature)return e.GeoJSON.toGeometry(t);var s;if(t.subType)s=e[t.subType]._fromJSON(t),e.Util.isNil(t.feature.id)||s.setId(t.feature.id);else{var a=t.feature;s=e.GeoJSON.toGeometry(a),t.options&&s.config(t.options)}return t.symbol&&s.setSymbol(t.symbol),t.infoWindow&&s.setInfoWindow(t.infoWindow),s},e.Geometry._getMarkerPathURL=function(t){if(!t.markerPath)return null;var i,n=e.symbolizer.VectorMarkerSymbolizer.translateToSVGStyles(t);e.Util.isNumber(t.markerOpacity)&&(i=t.markerOpacity),e.Util.isNumber(t.opacity)&&(i*=t.opacity);var r,o={};if(n){for(r in n.stroke)n.stroke.hasOwnProperty(r)&&(e.Util.isNil(n.stroke[r])||(o[r]=n.stroke[r]));for(r in n.fill)n.fill.hasOwnProperty(r)&&(e.Util.isNil(n.fill[r])||(o[r]=n.fill[r]))}var s,a,h=e.Util.isArray(t.markerPath)?t.markerPath:[t.markerPath],l=[];for(s=0;s<h.length;s++)a=e.Util.isString(h[s])?{path:h[s]}:h[s],a=e.Util.extend({},a,o),a.d=a.path,delete a.path,l.push(a);var u=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];for(1>i&&u.push('opacity="'+i+'"'),t.markerWidth&&t.markerHeight&&u.push('height="'+t.markerHeight+'" width="'+t.markerWidth+'"'),t.markerPathWidth&&t.markerPathHeight&&u.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),u.push('preserveAspectRatio="none"'),u.push("><defs></defs>"),s=0;s<l.length;s++){var c="<path ";for(r in l[s])l[s].hasOwnProperty(r)&&(c+=" "+r+'="'+l[s][r]+'"');c+="></path>",u.push(c)}u.push("</svg>");var d="data:image/svg+xml;base64,"+e.Util.btoa(u.join(" "));return d},e.Geometry.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new e.GeometryEditor(this,t),this._editor.start(),this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this.fire("editend")),this},isEditing:function(){return this._editor?this._editor.isEditing():!1}}),e.Geometry.mergeOptions({draggable:!1,dragShadow:!0,draggableAxis:null}),e.Geometry.Drag=e.Handler.extend({dragStageLayerId:e.internalLayerPrefix+"_drag_stage",START:e.Browser.touch?["touchstart","mousedown"]:["mousedown"],addHooks:function(){this.target.on(this.START.join(" "),this._startDrag,this)},removeHooks:function(){this.target.off(this.START.join(" "),this._startDrag,this)},_startDrag:function(t){var e=this.target.getMap();if(e){var i=this.target._getParent();if(!i&&!this.isDragging()){var n=t.domEvent;n.touches&&n.touches.length>1||(this.target.on("click",this._endDrag,this),this._preCoordDragged=t.coordinate,this._prepareMap(),this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this._moved=!1,this.target._fireEvent("dragstart",t))}}},_prepareMap:function(){var t=this.target.getMap();this._mapDraggable=t.options.draggable,this._mapHitDetect=t.options.hitDetect,t._trySetCursor("move"),t.config({hitDetect:!1,draggable:!1})},_prepareDragHandler:function(){var t=this.target.getMap();this._dragHandler=new e.Handler.Drag(t._panels.mapWrapper||t._containerDOM),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},_prepareShadow:function(){var t=this.target;this._prepareDragStageLayer(),this._shadow&&this._shadow.remove(),this._shadow=t.copy();var i=this._shadow;if(t.options.dragShadow){var n=e.Util.decreaseSymbolOpacity(i._getInternalSymbol(),.5);i.setSymbol(n)}i.setId(null);var r=[];if(e.ConnectorLine._hasConnectors(t))for(var o=e.ConnectorLine._getConnectors(t),s=0;s<o.length;s++){var a=o[s],h=a.config(),l=a._getInternalSymbol();h.symbol=l;var u;u=a.getConnectSource()===t?new maptalks.ConnectorLine(i,a.getConnectTarget(),h):new maptalks.ConnectorLine(a.getConnectSource(),i,h),r.push(u)}this._shadowConnectors=r,this._dragStageLayer.bringToFront().addGeometry(r.concat(i))},_onTargetUpdated:function(){this._shadow&&this._shadow.setSymbol(this.target.getSymbol())},_prepareDragStageLayer:function(){var t=this.target.getMap(),i=this.target.getLayer();this._dragStageLayer=t.getLayer(this.dragStageLayerId),this._dragStageLayer||(this._dragStageLayer=new e.VectorLayer(this.dragStageLayerId,{drawImmediate:!0}),t.addLayer(this._dragStageLayer)),this._dragStageLayer._getRenderer()._resources=i._getRenderer()._resources},_dragging:function(t){var e=this.target,i=e.getMap(),n=i._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),e.options.dragShadow||e.hide(),void this._shadow._fireEvent("dragstart",n);if(this._shadow){var o=this._shadow.options.draggableAxis,s=n.coordinate;this._preCoordDragged||(this._preCoordDragged=s);var a=s.substract(this._preCoordDragged);"x"===o?a.y=0:"y"===o&&(a.x=0),this._preCoordDragged=s,this._shadow.translate(a),e.options.dragShadow||e.translate(a),n.dragOffset=a,this._shadow._fireEvent("dragging",n),e._fireEvent("dragging",n)}}},_endDrag:function(t){var i=this.target,n=i.getMap();if(this._dragHandler&&(i.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),n){var r;n&&(r=n._parseEvent(t.domEvent)),i.off("symbolchange",this._onTargetUpdated,this),i.options.dragShadow||i.show();var o=this._shadow;o&&(i.options.dragShadow&&i.setCoordinates(o.getCoordinates()),o._fireEvent("dragend",r),o.remove(),delete this._shadow),this._shadowConnectors&&(n.getLayer(this.dragStageLayerId).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),delete this._preCoordDragged,n._trySetCursor("default"),e.Util.isNil(this._mapDraggable)&&(this._mapDraggable=!0),n.config({hitDetect:this._mapHitDetect,draggable:this._mapDraggable}),delete this._autoBorderPanning,delete this._mapDraggable,this._isDragging=!1,i._fireEvent("dragend",r)}},isDragging:function(){return!!this._isDragging}}),e.Geometry.addInitHook("addHandler","draggable",e.Geometry.Drag),e.Geometry.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():this.draggable?this.draggable.isDragging():!1}}),e.Geometry.include({_onEvent:function(t){if(this.getMap()){var i=this._getEventTypeToFire(t);"contextmenu"===i&&this.listens("contextmenu")&&(e.DomUtil.stopPropagation(t),e.DomUtil.preventDefault(t));var n=this._getEventParams(t);this._fireEvent(i,n)}},_getEventTypeToFire:function(t){var e=t.type;return"click"!==e&&"mousedown"!==e||2===t.button&&(e="contextmenu"),e},_getEventParams:function(t){var i=this.getMap(),n={domEvent:t},r=t.touches?t.touches[0]:t;if(r){var o=e.DomUtil.getEventContainerPoint(r,i._containerDOM);n.coordinate=i.containerPointToCoordinate(o),n.containerPoint=o,n.viewPoint=i.containerPointToViewPoint(o)}return n},_onMouseOver:function(t){if(this.getMap()){var e=t,i=this._getEventParams(e);this._fireEvent("mouseover",i)}},_onMouseOut:function(t){if(this.getMap()){var e=t,i=this._getEventParams(e);this._fireEvent("mouseout",i)}}}),e.Geometry.include({animate:function(t,i,n){e.Util.isFunction(i)&&(n=i,i=null);var r,o,s=this.getMap(),a=this._getProjection(),h=this._getInternalSymbol(),l=this._prepareAnimationStyles(t);i&&(o=i.focus),delete this._animationStarted;var u=e.Animation.animate(l,i,e.Util.bind(function(t){!this._animationStarted&&o&&s._onMoveStart();var i=t.styles;for(var l in i)if("symbol"!==l&&"translate"!==l&&i.hasOwnProperty(l)){var c="set"+l[0].toUpperCase()+l.substring(1);this[c](i[l])}var d=i.translate;if(d){var f=d;r&&(f=d.substract(r)),r=d,this.translate(f)}var m=i.symbol;if(m&&this.setSymbol(e.Util.extendSymbol(h,m)),o){var _=a.project(this.getCenter());s._setPrjCenterAndMove(_),"running"!==u.playState?s._onMoveEnd():s._onMoving()}this._fireAnimateEvent(u.playState),n&&n(t)},this));return u.play()},_prepareAnimationStyles:function(t){var i=this._getInternalSymbol(),n={};for(var r in t)if(t.hasOwnProperty(r)){var o,s=t[r];if("translate"!==r&&"symbol"!==r){var a="get"+r[0].toUpperCase()+r.substring(1),h=this[a]();n[r]=[h,s]}else if("symbol"===r){var l;if(e.Util.isArray(t.symbol)){if(!e.Util.isArray(i))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");l=[];for(var u=t.symbol,c=0;c<u.length;c++)if(u[c]){var d={};for(o in u[c])u[c].hasOwnProperty(o)&&(d[o]=[i[c][o],u[c][o]]);l.push(d)}else l.push(null)}else{if(e.Util.isArray(i))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");l={};for(o in s)s.hasOwnProperty(o)&&(l[o]=[i[o],s[o]])}n.symbol=l}else"translate"===r&&(n.translate=new e.Coordinate(s))}return n},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}}),e.Vector=e.Geometry.extend({options:{symbol:{lineColor:"#000000",lineWidth:1,lineOpacity:1,polygonFill:"#ffffff",polygonOpacity:0,opacity:1}},_hitTestTolerance:function(){var t,i=this._getInternalSymbol();if(e.Util.isArray(i)){t=0;for(var n=0;n<i.length;n++)e.Util.isNumber(i[n].lineWidth)&&i[n].lineWidth>t&&(t=i[n].lineWidth)}else t=i.lineWidth;return t?t/2:1.5}}),e.Geometry.Center={getCoordinates:function(){return this._coordinates},setCoordinates:function(t){var i=new e.Coordinate(t);if(i.equals(this._coordinates))return this;if(this._coordinates=i,!this.getMap())return this._onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},_getCenterViewPoint:function(){var t=this._getPrjCoordinates();if(!t)return null;var e=this.getMap();return e?e._prjToViewPoint(t):null},_getPrjCoordinates:function(){var t=this._getProjection();return t?(this._pcenter||this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter):null},_setPrjCoordinates:function(t){this._pcenter=t,this._onPositionChanged()},_updateCache:function(){delete this._extent;var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},_clearProjection:function(){this._pcenter=null},_computeCenter:function(){return this._coordinates}},e.Geometry.Poly={_prjToViewPoint:function(t){var i=[];if(!e.Util.isArrayHasData(t))return i;var n,r=this.getMap(),o=r.getFullExtent(),s=this._getProjection(),a=this.options.antiMeridian,h=r.options.clipFullExtent,l=this.getLayer()&&this.getLayer().options.enableSimplify,u=e.Util.isArray(t[0]);if(l){var c=2;n=r._getResolution()*c}!u&&l&&(t=e.Simplify.simplify(t,n,!1));for(var d,f,m,_=0,g=t.length;g>_;_++)if(d=t[_],!(e.Util.isNil(d)||h&&!o.contains(d)))if(u){if(!e.Util.isArrayHasData(d)){i.push([]);continue}l&&(d=e.Simplify.simplify(d,n,!1)),f=[];for(var p=0,y=d.length;y>p;p++)m=d[p],e.Util.isNil(d[p])||(p>0&&a&&"default"!==a&&(m=this._antiMeridian(m,d[p-1],s,a)),f.push(r._prjToViewPoint(m)));delete this._preAntiMeridianCoord,i.push(f)}else _>0&&a&&"default"!==a&&(d=this._antiMeridian(d,t[_-1],s,a)),m=r._prjToViewPoint(d),i.push(m);return delete this._preAntiMeridianCoord,i},_antiMeridian:function(t,e,i,n){var r;r=this._preAntiMeridianCoord?this._preAntiMeridianCoord:i?i.unproject(e):e;var o=i?i.unproject(t):t,s=o.x-r.x;return"continuous"===n&&Math.abs(s)>180&&(s>0?o._substract(360,0):o._add(360,0),t=i?i.unproject(o):o),this._preAntiMeridianCoord=o,t},_setPrjCoordinates:function(t){this._prjCoords=t,this._onShapeChanged()},_getPrjCoordinates:function(){if(!this._prjCoords){var t=this._coordinates;this._prjCoords=this._projectCoords(t)}return this._prjCoords},_updateCache:function(){delete this._extent;var t=this._getProjection();t&&(this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates())),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles())))},_clearProjection:function(){this._prjCoords=null,this._prjHoles&&(this._prjHoles=null)},_projectCoords:function(t){var e=this._getProjection();return e?e.projectCoords(t):null},_unprojectCoords:function(t){var e=this._getProjection();return e?e.unprojectCoords(t):null},_computeCenter:function(){var t=this._coordinates;if(!e.Util.isArrayHasData(t))return null;for(var i=0,n=0,r=0,o=t.length,s=0;o>s;s++)t[s]&&e.Util.isNumber(t[s].x)&&e.Util.isNumber(t[s].y)&&(i+=t[s].x,n+=t[s].y,r++);return new e.Coordinate(i/r,n/r)},_computeExtent:function(){var t=this._coordinates;if(!e.Util.isArrayHasData(t))return null;var i=t;return this.hasHoles&&this.hasHoles()&&(i=i.concat(this.getHoles())),this._computeCoordsExtent(i)},_computeCoordsExtent:function(t){for(var i,n=null,r=this.options.antiMeridian,o=0,s=t.length;s>o;o++){var a;if(e.Util.isArray(t[o]))for(var h=0,l=t[o].length;l>h;h++)a=t[o][h],h>0&&r&&"default"!==r&&(a=this._antiMeridian(a,t[o][h-1],null,r)),i=new e.Extent(a,a),n=i.combine(n);else a=t[o],o>0&&r&&"default"!==r&&(a=this._antiMeridian(a,t[o-1],null,r)),i=new e.Extent(a,a),n=i.combine(n)}return n}},e.Marker=e.Geometry.extend({includes:[e.Geometry.Center],type:e.Geometry.TYPE_POINT,options:{symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M5,9 a3,3 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34}},initialize:function(t,i){this._coordinates=new e.Coordinate(t),this._initOptions(i)},_canEdit:function(){var t=this._getInternalSymbol();return e.Util.isArray(t)?!1:e.symbolizer.VectorMarkerSymbolizer.test(t)||e.symbolizer.VectorPathMarkerSymbolizer.test(t)||e.symbolizer.ImageMarkerSymbolizer.test(t)},_containsPoint:function(t){var e=this._getPainter().getViewExtent();return e.contains(t)},_computeExtent:function(){var t=this.getCenter();return t?new e.Extent(t,t):null},_computeGeodesicLength:function(){return 0},_computeGeodesicArea:function(){return 0}}),e.Label=e.Marker.extend({defaultSymbol:{textFaceName:"monospace",textSize:12,textWrapBefore:!1,textWrapCharacter:"\n",textLineSpacing:8,textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},defaultBoxSymbol:{markerType:"square",markerLineColor:"#ff0000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#ffffff"},options:{box:!0,boxAutoSize:!0,boxMinWidth:0,boxMinHeight:0,boxPadding:new e.Size(12,8),boxTextAlign:"middle"},initialize:function(t,i,n){this._content=t,this._coordinates=new e.Coordinate(i),this._initOptions(n),this._registerEvents(),this._refresh()},getContent:function(){return this._content},setContent:function(t){var e=this._content;return this._content=t,this._refresh(),this._fireEvent("contentchange",{old:e,"new":t}),this},getSymbol:function(){return this._labelSymbolChanged?e.Geometry.prototype.getSymbol.call(this):null},setSymbol:function(t){t&&t!==this.options.symbol?this._labelSymbolChanged=!0:(this._labelSymbolChanged=!1,t={});var i=this._prepareSymbol(t),n=this._getDefaultLabelSymbol();return e.Util.extend(n,i),this._symbol=n,this._refresh(),this},onConfig:function(t){var e=!1;for(var i in t)if(t.hasOwnProperty(i)&&i.indexOf("box")>=0){e=!0;break}e&&this._refresh()},_getInternalSymbol:function(){return this._symbol},_getDefaultLabelSymbol:function(){var t={};return e.Util.extend(t,this.defaultSymbol),this.options.box&&e.Util.extend(t,this.defaultBoxSymbol),t},_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},_refresh:function(){var t=this.getSymbol()||this._getDefaultLabelSymbol();if(t.textName=this._content,this.options.box){t.markerType||(t.markerType="square");var i,n=this.options.boxPadding;(this.options.boxAutoSize||this.options.boxTextAlign)&&(i=e.StringUtil.splitTextToRow(this._content,t).size),this.options.boxAutoSize&&(t.markerWidth=i.width+2*n.width,t.markerHeight=i.height+2*n.height),this.options.boxMinWidth&&(!t.markerWidth||t.markerWidth<this.options.boxMinWidth)&&(t.markerWidth=this.options.boxMinWidth),this.options.boxMinHeight&&(!t.markerHeight||t.markerHeight<this.options.boxMinHeight)&&(t.markerHeight=this.options.boxMinHeight);var r=this.options.boxTextAlign;if(r){var o=e.StringUtil.getAlignPoint(i,t.textHorizontalAlignment,t.textVerticalAlignment);o=o._add(e.Util.getValueOrDefault(t.textDx,0),e.Util.getValueOrDefault(t.textDy,0)),t.markerDx=o.x,t.markerDy=o.y+i.height/2,"left"===r?t.markerDx+=t.markerWidth/2-n.width:"right"===r?t.markerDx-=t.markerWidth/2-i.width-n.width:t.markerDx+=i.width/2}}this._symbol=t,this._onSymbolChanged()},_registerEvents:function(){return this.on("shapechange",this._refresh,this),this.on("remove",this._onLabelRemove,this),this},_onLabelRemove:function(){this.off("shapechange",this._refresh,this),this.off("remove",this._onLabelRemove,this)}}),e.Label._fromJSON=function(t){var i=t.feature,n=new e.Label(t.content,i.geometry.coordinates,t.options);return n.setProperties(i.properties),n},e.Polygon=e.Vector.extend({includes:[e.Geometry.Poly],type:e.Geometry.TYPE_POLYGON,exceptionDefs:{"en-US":{INVALID_COORDINATES:"invalid coordinates for polygon."},"zh-CN":{INVALID_COORDINATES:"."}},options:{antiMeridian:"default"},initialize:function(t,e){this.setCoordinates(t),this._initOptions(e)},setCoordinates:function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var i=e.GeoJSON.toCoordinates(t),n=i.length;if(e.Util.isArray(i[0])){if(this._coordinates=this._trimRing(i[0]),n>1){for(var r=[],o=1;n>o;o++)i[o]&&r.push(this._trimRing(i[o]));this._holes=r}}else this._coordinates=this._trimRing(i);return this._projectRings(),this},getCoordinates:function(){if(!this._coordinates)return[];if(e.Util.isArrayHasData(this._holes)){for(var t=[],i=0;i<this._holes.length;i++)t.push(this._closeRing(this._holes[i]));return[this._closeRing(this._coordinates)].concat(t)}return[this._closeRing(this._coordinates)]},getShell:function(){return this._coordinates},getHoles:function(){return this.hasHoles()?this._holes:null},hasHoles:function(){return!(!e.Util.isArrayHasData(this._holes)||!e.Util.isArrayHasData(this._holes[0]))},_projectRings:function(){return this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),void this._onShapeChanged()):void this._onShapeChanged()},_cleanRing:function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},_checkRing:function(t){if(this._cleanRing(t),!t||!e.Util.isArrayHasData(t))return!1;var i=t[t.length-1],n=!0;return t[0].x===i.x&&t[0].y===i.y||(n=!1),n},_trimRing:function(t){var i=this._checkRing(t);return e.Util.isArrayHasData(t)&&i?t.slice(0,t.length-1):t},_closeRing:function(t){var i=this._checkRing(t);return e.Util.isArrayHasData(t)&&!i?t.concat([new e.Coordinate(t[0].x,t[0].y)]):t},_getPrjHoles:function(){return this._prjHoles||(this._prjHoles=this._projectCoords(this._holes)),this._prjHoles},_computeGeodesicLength:function(t){var i=this.getCoordinates();if(!e.Util.isArrayHasData(i))return 0;for(var n=0,r=0,o=i.length;o>r;r++)n+=e.GeoUtils.computeLength(i[r],t);return n},_computeGeodesicArea:function(t){var i=this.getCoordinates();if(!e.Util.isArrayHasData(i))return 0;for(var n=t.measureArea(i[0]),r=1,o=i.length;o>r;r++)n-=t.measureArea(i[r]);return n},_containsPoint:function(t,i){var n=e.Util.isNil(i)?this._hitTestTolerance():i,r=this._getPainter().getViewExtent().expand(n);if(t=new e.Point(t.x,t.y),!r.contains(t))return!1;var o=this._prjToViewPoint(this._getPrjCoordinates()),s=e.GeoUtils.pointInsidePolygon(t,o);if(s)return s;var a,h,l,u,c=o.length;for(a=0,h=c-1;c>a;h=a++)if(l=o[a],u=o[h],e.GeoUtils.distanceToSegment(t,l,u)<=n)return!0;return!1}}),e.LineString=e.Polyline=e.Vector.extend({includes:[e.Geometry.Poly],type:e.Geometry.TYPE_LINESTRING,options:{antiMeridian:"default",arrowStyle:null,arrowPlacement:"vertex-last"},initialize:function(t,e){this.setCoordinates(t),this._initOptions(e)},setCoordinates:function(t){return t?(this._coordinates=e.GeoJSON.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this._onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},getCoordinates:function(){return this._coordinates?this._coordinates:[]},_computeGeodesicLength:function(t){return e.GeoUtils.computeLength(this.getCoordinates(),t)},_computeGeodesicArea:function(){return 0},_containsPoint:function(t,i){var n=this.getMap(),r=e.Util.isNil(i)?this._hitTestTolerance():i,o=this._getPrjExtent(),s=new e.Coordinate(o.xmin,o.ymax),a=new e.Coordinate(o.xmax,o.ymin),h=n._prjToViewPoint(s),l=n._prjToViewPoint(a),u=new e.PointExtent(h.x-r,h.y-r,l.x+r,l.y+r);if(2>r&&(r=2),t=new e.Point(t.x,t.y),!u.contains(t))return!1;var c,d,f,m=this._prjToViewPoint(this._getPrjCoordinates()),_=m.length;for(c=0,_=m.length;_-1>c;c++)if(d=m[c],f=m[c+1],e.GeoUtils.distanceToSegment(t,d,f)<=r)return!0;return!1}}),e.CurveLine=e.LineString.extend({options:{curveType:1,arcDegree:90},_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"CurveLine"}},_getRenderCanvasResources:function(){var t=this._getPrjCoordinates(),i=this._prjToViewPoint(t),n=this.options.arcDegree,r=this.options.curveType,o=this,s=function(t,i,s){var a,h;switch(r){case 0:a=e.Canvas._lineTo,h=1;break;case 1:a=e.Canvas._arcBetween,h=1;break;case 2:a=e.Canvas._quadraticCurveTo,h=2;break;case 3:a=e.Canvas._bezierCurveTo,h=3}var l,u=i.length;for(t.beginPath(),l=0;u>l;l+=h){var c=i[l].round();0===l&&t.moveTo(c.x,c.y);var d=u-l;if(h>=d)2===d?(c=i[u-1],t.lineTo(c.x,c.y)):3===d&&e.Canvas._quadraticCurveTo(t,i[u-2],i[u-1]);else{for(var f=[],m=0;h>m;m++)f.push(i[l+m+1]);var _=[t].concat(f);a===e.Canvas._arcBetween&&(_.splice(1,0,c),_=_.concat([n])),a.apply(e.Canvas,_),e.Canvas._stroke(t,this.style.lineOpacity)}}if(e.Canvas._stroke(t,this.style.lineOpacity),t.setLineDash&&t.setLineDash([]),o.options.arrowStyle&&i.length>=2){var g=o.options.arrowPlacement;if("vertex-first"!==g&&"vertex-firstlast"!==g||o._arrow(t,i[1],i[0],s,o.options.arrowStyle),"vertex-last"!==g&&"vertex-firstlast"!==g||o._arrow(t,i[i.length-2],i[i.length-1],s,o.options.arrowStyle),(0===r||1===r)&&"point"===g)for(l=0,u=i.length-1;u>l;l++)o._arrow(t,i[l],i[l+1],s,o.options.arrowStyle)}};return{fn:s,context:[i]}}}),e.CurveLine._fromJSON=function(t){var i=t.feature,n=new e.CurveLine(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n},e.ConnectorLine=e.CurveLine.extend({options:{curveType:0,showOn:"always"},initialize:function(t,e,i){this._connSource=t,this._connTarget=e,this._registEvents(),this._initOptions(i)},getConnectSource:function(){return this._connSource},setConnectSource:function(t){return this._onRemove(),this._connSource=t,this._updateCoordinates(),this._registEvents(),this},getConnectTarget:function(){return this._connTarget},setConnectTarget:function(t){return this._onRemove(),this._connTarget=t,this._updateCoordinates(),this._registEvents(),this},_updateCoordinates:function(){var t=this.getMap();if(t||(t=this._connSource.getMap()),t||(t=this._connTarget.getMap()),t){for(var i,n,r=this._connSource._getConnectPoints(),o=this._connTarget._getConnectPoints(),s=0,a=this.getCoordinates(),h=0,l=r.length;l>h;h++)for(var u=r[h],c=0,d=o.length;d>c;c++){var f=o[c],m=t.computeLength(u,f);0===h&&0===c?(i=u,n=f,s=m):s>m&&(i=u,n=f)}e.Util.isArrayHasData(a)&&a[0].equals(i)&&a[1].equals(n)||this.setCoordinates([i,n])}},_onRemove:function(){e.Util.removeFromArray(this,this._connSource.__connectors),e.Util.removeFromArray(this,this._connTarget.__connectors),
this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this._onRemove,this),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this._onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this)},_showConnect:function(){this._connSource&&this._connTarget&&(this._connSource instanceof e.Control||this._connSource.isVisible())&&(this._connTarget instanceof e.Control||this._connTarget.isVisible())&&(this._updateCoordinates(),this.show())},_registEvents:function(){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect()},_isEditingOrDragging:function(){return!(this._connSource instanceof e.Control)&&this._connSource._isEditingOrDragging()||!(this._connTarget instanceof e.Control)&&this._connTarget._isEditingOrDragging()}}),e.Util.extend(e.ConnectorLine,{_hasConnectors:function(t){return!e.Util.isNil(t.__connectors)&&t.__connectors.length>0},_getConnectors:function(t){return t.__connectors}}),e.Ellipse=e.Polygon.extend({includes:[e.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(t,i,n,r){this._coordinates=new e.Coordinate(t),this.width=i,this.height=n,this._initOptions(r)},getWidth:function(){return this.width},setWidth:function(t){return this.width=t,this._onShapeChanged(),this},getHeight:function(){return this.height},setHeight:function(t){return this.height=t,this._onShapeChanged(),this},getShell:function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),i=this.options.numberOfShellPoints,n=this.getWidth(),r=this.getHeight(),o=[],s=Math.pow(n,2)*Math.pow(r,2),a=Math.pow(n,2),h=Math.pow(r,2),l=0;i>l;l++){var u=360*l/i*Math.PI/180,c=Math.sqrt(s/(a*Math.pow(Math.tan(u),2)+h)),d=Math.sqrt(s/(h*Math.pow(1/Math.tan(u),2)+a)),f=t.locate(e,c,d);o.push(f)}return o},getHoles:function(){return null},_containsPoint:function(t,i){var n,r,o,s=this.getMap(),a=e.Util.isNil(i)?this._hitTestTolerance():i,h=s.distanceToPixel(this.width/2,0),l=s.distanceToPixel(0,this.height/2),u=h.width,c=l.height,d=Math.sqrt(Math.abs(u*u-c*c)),f=u>=c,m=this._getCenterViewPoint();return f?(n=new e.Point(m.x-d,m.y),r=new e.Point(m.x+d,m.y),o=2*u):(n=new e.Point(m.x,m.y-d),r=new e.Point(m.x,m.y+d),o=2*c),t=new e.Point(t.x,t.y),t.distanceTo(n)+t.distanceTo(r)<=o+2*a},_computeExtent:function(t){if(!t||!this._coordinates||e.Util.isNil(this.width)||e.Util.isNil(this.height))return null;var i=this.getWidth(),n=this.getHeight(),r=t.locate(this._coordinates,i/2,n/2),o=t.locate(this._coordinates,-i/2,-n/2);return new e.Extent(r,o)},_computeGeodesicLength:function(){if(e.Util.isNil(this.width)||e.Util.isNil(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},_computeGeodesicArea:function(){return e.Util.isNil(this.width)||e.Util.isNil(this.height)?0:Math.PI*this.width*this.height/4},_exportGeoJSONGeometry:function(){var t=e.GeoJSON.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:t}},_toJSON:function(t){var i=e.Util.extend({},t),n=this.getCenter();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Ellipse",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}}}),e.Ellipse._fromJSON=function(t){var i=t.feature,n=new e.Ellipse(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n},e.Circle=e.Polygon.extend({includes:[e.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(t,i,n){this._coordinates=new e.Coordinate(t),this._radius=i,this._initOptions(n)},getRadius:function(){return this._radius},setRadius:function(t){return this._radius=t,this._onShapeChanged(),this},getShell:function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),i=this.options.numberOfShellPoints,n=this.getRadius(),r=[],o=0;i>o;o++){var s=360*o/i*Math.PI/180,a=n*Math.cos(s),h=n*Math.sin(s),l=t.locate(e,a,h);r.push(l)}return r},getHoles:function(){return null},_containsPoint:function(t,i){var n=this._getCenterViewPoint(),r=this.getSize(),o=e.Util.isNil(i)?this._hitTestTolerance():i,s=new e.Point(n.x,n.y),a=new e.Point(t.x,t.y);return a.distanceTo(s)<=r.width/2+o},_computeExtent:function(t){if(!t||!this._coordinates||e.Util.isNil(this._radius))return null;var i=this._radius,n=t.locate(this._coordinates,i,i),r=t.locate(this._coordinates,-i,-i);return new e.Extent(n,r)},_computeGeodesicLength:function(){return e.Util.isNil(this._radius)?0:2*Math.PI*this._radius},_computeGeodesicArea:function(){return e.Util.isNil(this._radius)?0:Math.PI*Math.pow(this._radius,2)},_exportGeoJSONGeometry:function(){var t=e.GeoJSON.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:t}},_toJSON:function(t){var i=this.getCenter(),n=e.Util.extend({},t);n.geometry=!1;var r=this.toGeoJSON(n);return r.geometry={type:"Polygon"},{feature:r,subType:"Circle",coordinates:[i.x,i.y],radius:this.getRadius()}}}),e.Circle._fromJSON=function(t){var i=t.feature,n=new e.Circle(t.coordinates,t.radius,t.options);return n.setProperties(i.properties),n},e.Sector=e.Polygon.extend({includes:[e.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(t,i,n,r,o){this._coordinates=new e.Coordinate(t),this._radius=i,this.startAngle=n,this.endAngle=r,this._initOptions(o)},getRadius:function(){return this._radius},setRadius:function(t){return this._radius=t,this._onShapeChanged(),this},getStartAngle:function(){return this.startAngle},setStartAngle:function(t){return this.startAngle=t,this._onShapeChanged(),this},getEndAngle:function(){return this.endAngle},setEndAngle:function(t){return this.endAngle=t,this._onShapeChanged(),this},getShell:function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),i=this.options.numberOfShellPoints,n=this.getRadius(),r=[],o=this.getEndAngle()-this.getStartAngle(),s=0;i>s;s++){var a=(o*s/i+this.getStartAngle())*Math.PI/180,h=n*Math.cos(a),l=n*Math.sin(a),u=t.locate(e,h,l);r.push(u)}return r},getHoles:function(){return null},_containsPoint:function(t,i){var n=this._getCenterViewPoint(),r=e.Util.isNil(i)?this._hitTestTolerance():i,o=this.getSize(),s=n,a=t,h=a.x-s.x,l=s.y-a.y,u=Math.atan2(l,h),c=0>u?360*(u+2*Math.PI)/(2*Math.PI):360*u/(2*Math.PI),d=this.startAngle%360,f=this.endAngle%360,m=!1;return m=d>f?!(c>f&&d>c):c>=d&&f>=c,a.distanceTo(s)<=o.width/2+r&&m},_computeExtent:function(t){if(!t||!this._coordinates||e.Util.isNil(this._radius))return null;var i=this._radius,n=t.locate(this._coordinates,i,i),r=t.locate(this._coordinates,-i,-i);return new e.Extent(n,r)},_computeGeodesicLength:function(){return e.Util.isNil(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},_computeGeodesicArea:function(){return e.Util.isNil(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},_exportGeoJSONGeometry:function(){var t=e.GeoJSON.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:t}},_toJSON:function(t){var i=e.Util.extend({},t),n=this.getCenter();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Sector",coordinates:[n.x,n.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}}}),e.Sector._fromJSON=function(t){var i=t.feature,n=new e.Sector(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return n.setProperties(i.properties),n},e.Rectangle=e.Polygon.extend({initialize:function(t,i,n,r){this._coordinates=new e.Coordinate(t),this._width=i,this._height=n,this._initOptions(r)},getCoordinates:function(){return this._coordinates},setCoordinates:function(t){if(this._coordinates=new e.Coordinate(t),!this._coordinates||!this.getMap())return this._onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},getWidth:function(){return this._width},setWidth:function(t){return this._width=t,this._onShapeChanged(),this},getHeight:function(){return this._height},setHeight:function(t){return this._height=t,this._onShapeChanged(),this},getShell:function(){var t=this._getMeasurer(),e=this._coordinates,i=this.getMap(),n=-1;if(i){var r=i.getFullExtent();r.bottom>r.top&&(n=1)}var o=[];return o.push(e),o.push(t.locate(e,this._width,0)),o.push(t.locate(e,this._width,n*this._height)),o.push(t.locate(e,0,n*this._height)),o.push(e),o},getHoles:function(){return null},_getPrjCoordinates:function(){var t=this._getProjection();return t?(this._pnw||this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw):null},_setPrjCoordinates:function(t){this._pnw=t,this._onPositionChanged()},_updateCache:function(){delete this._extent;var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},_clearProjection:function(){this._pnw=null},_computeCenter:function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},_containsPoint:function(t,i){var n=this.getMap(),r=e.Util.isNil(i)?this._hitTestTolerance():i,o=n.coordinateToViewPoint(this._coordinates),s=n.distanceToPixel(this._width,this._height),a=new e.Point(o.x,o.y),h=new e.Point(o.x+s.width,o.y+s.height),l=new e.PointExtent(a.x-r,a.y-r,h.x+r,h.y+r);return t=new e.Point(t.x,t.y),l.contains(t)},_computeExtent:function(t){if(!t||!this._coordinates||e.Util.isNil(this._width)||e.Util.isNil(this._height))return null;var i=this.getWidth(),n=this.getHeight(),r=t.locate(this._coordinates,i,-n);return new e.Extent(r,this._coordinates)},_computeGeodesicLength:function(){return e.Util.isNil(this._width)||e.Util.isNil(this._height)?0:2*(this._width+this._height)},_computeGeodesicArea:function(){return e.Util.isNil(this._width)||e.Util.isNil(this._height)?0:this._width*this._height},_exportGeoJSONGeometry:function(){var t=e.GeoJSON.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:t}},_toJSON:function(t){var i=e.Util.extend({},t),n=this.getCoordinates();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Rectangle",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}}}),e.Rectangle._fromJSON=function(t){var i=t.feature,n=new e.Rectangle(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n},e.GeometryCollection=e.Geometry.extend({type:e.Geometry.TYPE_GEOMETRYCOLLECTION,exceptionDefs:{"en-US":{INVALID_GEOMETRY:"invalid geometry for collection."},"zh-CN":{INVALID_GEOMETRY:"Geometrycollection."}},initialize:function(t,e){this._initOptions(e),this.setGeometries(t)},setGeometries:function(t){var i=this._checkGeometries(t);if(e.Util.isArray(i))for(var n=i.length-1;n>=0;n--)i[n]._initOptions(this.config()),i[n]._setParent(this),i[n].setEventParent(this),i[n].setSymbol(this.getSymbol());return this._geometries=i,this.getLayer()&&(this._bindGeometriesToLayer(),this._onShapeChanged()),this},getGeometries:function(){return this._geometries?this._geometries:[]},forEach:function(t,e){for(var i=this.getGeometries(),n=0,r=i.length;r>n;n++)i[n]&&(e?t.call(e,i[n],n):t(i[n],n));return this},filter:function(){return e.VectorLayer.prototype.filter.apply(this,arguments)},translate:function(t){return t?this.isEmpty()?this:(this.forEach(function(e){e&&e.translate&&e.translate(t)}),this):this},isEmpty:function(){return!e.Util.isArrayHasData(this.getGeometries())},remove:function(){return this.forEach(function(t){t._unbind()}),e.Geometry.prototype.remove.apply(this,arguments)},show:function(){return this.options.visible=!0,this.forEach(function(t){t.show()}),this},hide:function(){return this.options.visible=!1,this.forEach(function(t){t.hide()}),this},setSymbol:function(t){return t=this._prepareSymbol(t),this._symbol=t,this.forEach(function(e){e.setSymbol(t)}),this._onSymbolChanged(),this},onConfig:function(t){this.forEach(function(e){e.config(t)})},_setExternSymbol:function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach(function(e){e._setExternSymbol(t)}),this._onSymbolChanged(),this},_bindLayer:function(){e.Geometry.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},_bindGeometriesToLayer:function(){var t=this.getLayer();this.forEach(function(e){e._bindLayer(t)})},_checkGeometries:function(t){if(t&&!e.Util.isArray(t)){if(t instanceof e.Geometry)return[t];throw new Error(this.exceptions.INVALID_GEOMETRY)}if(e.Util.isArray(t)){for(var i=0,n=t.length;n>i;i++)if(!(t[i]instanceof e.Geometry))throw new Error(this.exceptions.INVALID_GEOMETRY);return t}return null},_updateCache:function(){delete this._extent,this.isEmpty()||this.forEach(function(t){t&&t._updateCache&&t._updateCache()})},_removePainter:function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach(function(t){t._removePainter()})},_computeCenter:function(t){if(!t||this.isEmpty())return null;for(var i=0,n=0,r=0,o=this.getGeometries(),s=0,a=o.length;a>s;s++)if(o[s]){var h=o[s]._computeCenter(t);h&&(i+=h.x,n+=h.y,r++)}return 0===r?null:new e.Coordinate(i/r,n/r)},_containsPoint:function(t,e){if(this.isEmpty())return!1;var i,n,r=this.getGeometries();for(i=0,n=r.length;n>i;i++)if(r[i]._containsPoint(t,e))return!0;return!1},_computeExtent:function(t){if(this.isEmpty())return null;for(var e=this.getGeometries(),i=null,n=0,r=e.length;r>n;n++)if(e[n]){var o=e[n]._computeExtent(t);o&&(i=o.combine(i))}return i},_computeGeodesicLength:function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;r>n;n++)e[n]&&(i+=e[n]._computeGeodesicLength(t));return i},_computeGeodesicArea:function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;r>n;n++)e[n]&&(i+=e[n]._computeGeodesicArea(t));return i},_exportGeoJSONGeometry:function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),i=0,n=e.length;n>i;i++)e[i]&&t.push(e[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},_clearProjection:function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,i=t.length;i>e;e++)t[e]&&t[e]._clearProjection()},_getConnectPoints:function(){var t=this.getExtent(),i=[new e.Coordinate(t.xmin,t.ymax),new e.Coordinate(t.xmax,t.ymin),new e.Coordinate(t.xmin,t.ymin),new e.Coordinate(t.xmax,t.ymax)];return i},startEdit:function(t){if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var e=this.getGeometries(),i=0,n=e.length;n>i;i++)e[i].startEdit(t);this._editing=!0,this.hide();var r=this;return setTimeout(function(){r.fire("editstart")},1),this},endEdit:function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,i=t.length;i>e;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},isEditing:function(){return!!this._editing}}),e.Geometry.MultiPoly={getCoordinates:function(){var t=[],i=this.getGeometries();if(!e.Util.isArray(i))return null;for(var n=0,r=i.length;r>n;n++)t.push(i[n].getCoordinates());return t},setCoordinates:function(t){if(e.Util.isArrayHasData(t)){for(var i=[],n=0,r=t.length;r>n;n++){var o=new this.GeometryType(t[n],this.config());i.push(o)}this.setGeometries(i)}else this.setGeometries([]);return this},_initData:function(t){e.Util.isArrayHasData(t)&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},_checkGeometries:function(t){if(e.Util.isArray(t))for(var i=0,n=t.length;n>i;i++)if(t[i]&&!(t[i]instanceof this.GeometryType))throw new Error(this.exceptions.INVALID_GEOMETRY_IN_COLLECTION+i);return t},_exportGeoJSONGeometry:function(){var t=this.getCoordinates(),i=e.GeoJSON.toNumberArrays(t);return{type:this.getType(),coordinates:i}}},e.MultiPoint=e.GeometryCollection.extend({includes:[e.Geometry.MultiPoly],GeometryType:e.Marker,type:e.Geometry.TYPE_MULTIPOINT,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),e.MultiLineString=e.MultiPolyline=e.GeometryCollection.extend({includes:[e.Geometry.MultiPoly],GeometryType:e.Polyline,type:e.Geometry.TYPE_MULTILINESTRING,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),e.MultiPolygon=e.GeometryCollection.extend({includes:[e.Geometry.MultiPoly],GeometryType:e.Polygon,type:e.Geometry.TYPE_MULTIPOLYGON,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),e.GeoJSON={toGeometry:function(t){if(e.Util.isString(t)&&(t=e.Util.parseJSON(t)),e.Util.isArray(t)){for(var i=[],n=0,r=t.length;r>n;n++){var o=this._convert(t[n]);e.Util.isArray(o)?i=i.concat(o):i.push(o)}return i}var s=this._convert(t);return s},toNumberArrays:function(t){return e.Util.isArray(t)?e.Util.mapArrayRecursively(t,function(t){return[t.x,t.y]}):[t.x,t.y]},toCoordinates:function(t){if(e.Util.isNumber(t[0])&&e.Util.isNumber(t[1]))return new e.Coordinate(t);for(var i=[],n=0,r=t.length;r>n;n++){var o=t[n];e.Util.isArray(o)?e.Util.isNumber(o[0])?i.push(new e.Coordinate(o)):i.push(this.toCoordinates(o)):i.push(new e.Coordinate(o))}return i},_convert:function(t){if(!t||e.Util.isNil(t.type))return null;var i={},n=t.type;if("Feature"===n){var r=t.geometry,o=this._convert(r);return o?(o.setId(t.id),o.setProperties(t.properties),o):null}if("FeatureCollection"===n){var s=t.features;if(!s)return null;var a=e.GeoJSON.toGeometry(s);return a}if(e.Util.indexOfArray(n,["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"])>=0){var h="Point"===n?"Marker":n;return new e[h](t.coordinates,i)}if("GeometryCollection"===n){var l=t.geometries;if(!e.Util.isArrayHasData(l))return new e.GeometryCollection;for(var u=[],c=l.length,d=0;c>d;d++)u.push(this._convert(l[d]));return new e.GeometryCollection(u,i)}return"Circle"===n?new e.Circle(t.coordinates,t.radius,i):"Ellipse"===n||"Rectangle"===n?new e[n](t.coordinates,t.width,t.height,i):"Sector"===n?new e.Sector(t.coordinates,t.radius,t.startAngle,t.endAngle,i):null}},e.GeometryEditor=e.Class.extend({includes:[e.Eventable],editStageLayerIdPrefix:e.internalLayerPrefix+"_edit_stage_",initialize:function(t,i){this._geometry=t,this._geometry&&e.Util.setOptions(this,i)},getMap:function(){return this._geometry.getMap()},prepare:function(){var t=this.getMap();t&&(this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},_prepareEditStageLayer:function(){var t=this.getMap(),i=e.Util.GUID();this._editStageLayer=t.getLayer(this.editStageLayerIdPrefix+i),this._editStageLayer||(this._editStageLayer=new e.VectorLayer(this.editStageLayerIdPrefix+i,{drawImmediate:!0}),t.addLayer(this._editStageLayer))},start:function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0;var t=this._geometry;this._geometryDraggble=t.options.draggable,t.config("draggable",!1),this.prepare();var i=t.copy();i.copyEventListeners(t),t._getParent()&&i.copyEventListeners(t._getParent()),i.setId(null).config({draggable:!1}),this._shadow=i,t.hide(),(t instanceof e.Marker||t instanceof e.Circle||t instanceof e.Rectangle||t instanceof e.Ellipse)&&this._createOrRefreshOutline(),this._editStageLayer.bringToFront().addGeometry(i),t instanceof e.Marker?(i.config("draggable",!0),i.on("dragend",this._onShadowDragEnd,this)):this._createCenterHandle(),t instanceof e.Marker?this.createMarkerEditor():t instanceof e.Circle?this.createCircleEditor():t instanceof e.Rectangle?this.createEllipseOrRectEditor():t instanceof e.Ellipse?this.createEllipseOrRectEditor():t instanceof e.Sector||(t instanceof e.Polygon||t instanceof e.Polyline)&&this.createPolygonEditor()}},stop:function(){var t=this.getMap();if(t){if(this._shadow&&(this._update(),this._shadow._clearAllListeners(),this._shadow.remove(),delete this._shadow),this._geometry.config("draggable",this._geometryDraggble),delete this._geometryDraggble,this._geometry.show(),this._editStageLayer.remove(),e.Util.isArrayHasData(this._eventListeners)){for(var i=this._eventListeners.length-1;i>=0;i--){var n=this._eventListeners[i];n[0].off(n[1],n[2],this)}this._eventListeners=[]}this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1}},isEditing:function(){return e.Util.isNil(this.editing)?!1:this.editing},_onShadowDragEnd:function(){this._update(),this._refresh()},_update:function(){this._geometry.setCoordinates(this._shadow.getCoordinates()),this._geometry.getRadius&&this._geometry.setRadius(this._shadow.getRadius()),this._geometry.getWidth&&this._geometry.setWidth(this._shadow.getWidth()),this._geometry.getHeight&&this._geometry.setHeight(this._shadow.getHeight()),this._geometry.getStartAngle&&this._geometry.setStartAngle(this._shadow.getStartAngle()),this._geometry.getEndAngle&&this._geometry.setEndAngle(this._shadow.getEndAngle())},_updateAndFireEvent:function(t){this._shadow&&(this._update(),this._geometry.fire(t))},_createOrRefreshOutline:function(){var t=this._geometry,i=this.getMap(),n=this._editOutline,r=t._getPainter().getViewExtent(),o=r.getSize(),s=i.viewPointToCoordinate(r.getMin()),a=i.pixelToDistance(o.width,0),h=i.pixelToDistance(0,o.height);return n?(n.setCoordinates(s),n.setWidth(a),n.setHeight(h)):(n=new e.Rectangle(s,a,h,{symbol:{lineWidth:1,lineColor:"6b707b"}}),this._editStageLayer.addGeometry(n),this._editOutline=n,this._addRefreshHook(this._createOrRefreshOutline)),n},_createCenterHandle:function(){var t,i=this,n=this._shadow.getCenter(),r=i.createHandle(n,{markerType:"ellipse",dxdy:new e.Point(0,0),cursor:"move",onDown:function(){t=this._shadow.copy();var i=e.Util.decreaseSymbolOpacity(t._getInternalSymbol(),.5);t.setSymbol(i).addTo(this._editStageLayer)},onMove:function(e,i){var n=i.dragOffset;t&&(t.translate(n),this._geometry.translate(n))},onUp:function(){t&&(this._shadow.setCoordinates(this._geometry.getCoordinates()),t.remove(),i._refresh())}});this._addRefreshHook(function(){var t=this._shadow.getCenter();r.setCoordinates(t)})},_createHandleInstance:function(t,i){var n={markerType:i.markerType,markerFill:"#ffffff",markerLineColor:"#000000",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDx:i.dxdy.x,markerDy:i.dxdy.y};i.symbol&&e.Util.extend(n,i.symbol);var r=new e.Marker(t,{draggable:!0,dragShadow:!1,draggableAxis:i.axis,cursor:i.cursor,symbol:n});return r},createHandle:function(t,e){function i(t){e.onDown&&e.onDown.call(a,t.viewPoint,t)}function n(t){a._hideContext();var i=o._prjToViewPoint(s._getPrjCoordinates());e.onMove&&e.onMove.call(a,i,t)}function r(t){e.onUp&&e.onUp.call(a,t)}e||(e={});var o=this.getMap(),s=this._createHandleInstance(t,e),a=this;return s.on("dragstart",i,this),s.on("dragging",n,this),s.on("dragend",r,this),e.onRefresh&&(s["maptalks--editor-refresh-fn"]=e.onRefresh),this._editStageLayer.addGeometry(s),s},_createResizeHandles:function(t,i){function n(t){return[t.getMin(),new e.Point((t.xmax+t.xmin)/2,t.ymin),new e.Point(t.xmax,t.ymin),new e.Point(t.xmin,(t.ymax+t.ymin)/2),new e.Point(t.xmax,(t.ymax+t.ymin)/2),new e.Point(t.xmin,t.ymax),new e.Point((t.xmax+t.xmin)/2,t.ymax),t.getMax()]}var r=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],s=this._geometry;t||(t=[]);var a=[],h={},l=this,u=this.getMap(),c=function(){for(var c=s._getPainter().getViewExtent(),d=n(c),f=0;f<d.length;f++){if(e.Util.isArrayHasData(t)){for(var m=!1,_=t.length-1;_>=0;_--)if(t[_]===f){m=!0;break}if(m)continue}var g=d[f],p=u.viewPointToCoordinate(g);if(a.length<d.length-t.length){var y=l.createHandle(p,{markerType:"square",dxdy:new e.Point(0,0),cursor:r[f],axis:o[f],onMove:function(t){return function(e){i(e,t)}}(f),onUp:function(){l._refresh()}});y.setId(f),h[f]=a.length,a.push(y)}else a[h[f]].setCoordinates(p)}};return c(),this._addRefreshHook(c),a},createMarkerEditor:function(){function t(){if(e.Util.isArrayHasData(n))for(var t=n.length-1;t>=0;t--)n[t].hide();this._editOutline&&this._editOutline.hide()}function i(){if(this._refresh(),e.Util.isArrayHasData(n))for(var t=n.length-1;t>=0;t--)n[t].show();this._editOutline&&this._editOutline.show()}var n,r=this._shadow,o=this._geometry,s=this.getMap();if(!r._canEdit())return void console.warn("A marker can't be resized with symbol:",r.getSymbol());var a=r._getInternalSymbol(),h=new e.Point(0,0);e.Util.isNumber(a.markerDx)&&(h.x=a.markerDx),e.Util.isNumber(a.markerDy)&&(h.y=a.markerDy);var l=null;e.symbolizer.VectorMarkerSymbolizer.test(a)?"pin"!==a.markerType&&"pie"!==a.markerType&&"bar"!==a.markerType||(l=[5,6,7]):(e.symbolizer.ImageMarkerSymbolizer.test(a)||e.symbolizer.VectorPathMarkerSymbolizer.test(a))&&(l=[5,6,7]);var u=[2,1,2,0,0,2,1,2];n=this._createResizeHandles(null,function(t,i){if(l&&e.Util.indexOfArray(i,l)>=0){var a=s.viewPointToCoordinate(t),c=r.getCoordinates();a.x=c.x,r.setCoordinates(a),o.setCoordinates(a);var d=n[n.length-1-i],f=s.coordinateToViewPoint(d.getCoordinates());t=f}var m=r._getCenterViewPoint().add(h),_=r._getInternalSymbol(),g=t.substract(m),p=l?1:2,y=2*Math.abs(g.x),v=Math.abs(g.y)*p,x=u[i];0!==x&&2!==x||(_.markerWidth=y),1!==x&&2!==x||(_.markerHeight=v),r.setSymbol(_),o.setSymbol(_)}),this._addListener([s,"zoomstart",t]),this._addListener([s,"zoomend",i])},createCircleEditor:function(){var t=this._shadow,e=this._geometry,i=this.getMap();this._createResizeHandles(null,function(n){var r,o=t._getCenterViewPoint(),s=n.substract(o),a=Math.abs(s.x),h=Math.abs(s.y);r=a>h?i.pixelToDistance(a,0):i.pixelToDistance(0,h),t.setRadius(r),e.setRadius(r)})},createEllipseOrRectEditor:function(){var t=[2,1,2,0,0,2,1,2],i=this._shadow,n=this._geometry,r=this.getMap(),o=null,s=this._geometry instanceof e.Rectangle;s&&(o=[0,1,2,3,5]);var a=this._createResizeHandles(null,function(h,l){var u,c;if(s){if(o&&e.Util.indexOfArray(l,o)>=0){var d,f=i.getCoordinates(),m=r.viewPointToCoordinate(h),_=a[7],g=r.coordinateToViewPoint(_.getCoordinates());switch(l){case 0:d=m;break;case 1:d=new e.Coordinate(f.x,m.y);break;case 2:d=new e.Coordinate(f.x,m.y),g=new e.Point(h.x,g.y);break;case 3:d=new e.Coordinate(m.x,f.y);break;case 5:d=new e.Coordinate(m.x,f.y),g=new e.Point(g.x,h.y);break;default:d=null}i.setCoordinates(d),n.setCoordinates(d),h=g}c=1,u=r._prjToViewPoint(i._getPrjCoordinates())}else c=2,u=i._getCenterViewPoint();var p=h.substract(u),y=t[l],v=r.pixelToDistance(Math.abs(p.x),0),x=r.pixelToDistance(0,Math.abs(p.y));0!==y&&2!==y||(i.setWidth(v*c),n.setWidth(v*c)),1!==y&&2!==y||(i.setHeight(x*c),n.setHeight(x*c))})},createPolygonEditor:function(){function t(){if(l instanceof e.Polygon){var t=l.getCoordinates()[0];return t.slice(0,t.length-1)}return l.getCoordinates()}function i(){return l._getPrjCoordinates()}function n(){var t;for(t=_.length-1;t>=0;t--)_[t][m]=t;for(t=g.length-1;t>=0;t--)g[t][m]=t}function r(t){var e=t.target,r=e[m],o=i();if(!(o.length<=d)){o.splice(r,1),l._setPrjCoordinates(o),l._updateCache(),_.splice(r,1)[0].remove(),r<g.length&&g.splice(r,1)[0].remove();var s;s=0===r?g.length-1:r-1,g.splice(s,1)[0].remove(),g.splice(s,0,a.call(u,s)),n()}}function o(t,e){var n=i(),r=h._viewPointToPrj(t),o=n[e];o.x=r.x,o.y=r.y,l._updateCache(),l._onShapeChanged();var s;s=0===e?g.length-1:e-1,g[e]&&g[e][f](),g[s]&&g[s][f](),u._updateAndFireEvent("shapechange")}function s(i){var n=t()[i],s=u.createHandle(n,{markerType:"square",dxdy:new e.Point(0,0),cursor:"pointer",axis:null,onMove:function(t){o(t,s[m])},onRefresh:function(){n=t()[s[m]],s.setCoordinates(n)},onUp:function(){u._refresh()}});return s[m]=i,s.on("contextmenu",r),s}function a(r){var h,d=t();h=r+1>=d.length?d[0]:d[r+1];var f=d[r].add(h).multi(.5),p=u.createHandle(f,{markerType:"square",symbol:{opacity:.4},dxdy:new e.Point(0,0),cursor:"pointer",axis:null,onDown:function(){var t=i(),e=p[m],n=c.project(p.getCoordinates());t.splice(e+1,0,n),l._setPrjCoordinates(t),l._updateCache();var r=p.getSymbol();delete r.opacity,p.setSymbol(r),g.splice(e,0,a.call(u,e),a.call(u,e+1)),u._updateAndFireEvent("shapechange")},onMove:function(t){o(t,p[m]+1)},onUp:function(){var t=p[m];e.Util.removeFromArray(p,g),p.remove(),_.splice(t+1,0,s.call(u,t+1)),n()},onRefresh:function(){d=t();var e,i=p[m];e=i===d.length-1?0:i+1;var n=d[i].add(d[e]).multi(.5);p.setCoordinates(n)}});return p[m]=r,p}for(var h=this.getMap(),l=this._shadow,u=this,c=h.getProjection(),d=l instanceof e.Polygon?3:2,f="maptalks--editor-refresh-fn",m="maptalks--editor-vertex-index",_=[],g=[],p=t(),y=0,v=p.length;v>y;y++)_.push(s.call(this,y)),v-1>y&&g.push(a.call(this,y));l instanceof e.Polygon&&g.push(a.call(this,p.length-1)),this._addRefreshHook(function(){var t;for(t=g.length-1;t>=0;t--)g[t][f]();for(t=_.length-1;t>=0;t--)_[t][f]()})},_refresh:function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},_hideContext:function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},_addListener:function(t){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push(t),t[0].on(t[1],t[2],this)},_addRefreshHook:function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))}}),e.Label.include({startEditText:function(){return this.hide(),this._prepareEditor(),this},endEditText:function(){var t=this._textEditor.value;return this.setContent(t),this.show(),e.DomUtil.removeDomNode(this._container),delete this._container,delete this._textEditor,this},isEditingText:function(){return!!this._container},_prepareEditor:function(){var t=this.getMap(),i=t._panels.control.style.zIndex+1,n=this._computeViewPoint();this._container=e.DomUtil.createEl("div"),this._container.style.cssText="position:absolute;top:"+n.y+"px;left:"+n.x+"px;z-index:"+i+";",t._panels.ui.appendChild(this._container),this._textEditor=this._createInputDom(),this._container.appendChild(this._textEditor)},_computeViewPoint:function(){var t=this.getMap(),i=this._getInternalSymbol(),n=this.getSize(),r=e.Util.getValueOrDefault(i.textDx,0),o=e.Util.getValueOrDefault(i.textDy,0),s=e.StringUtil.getAlignPoint(n,i.textHorizontalAlignment,i.textVerticalAlignment).add(new e.Point(r,o)),a=t.coordinateToViewPoint(this.getCenter()).add(s);return a},_createInputDom:function(){var t=this.getSize(),i=this._getInternalSymbol(),n=t.width,r=t.height,o=i.textFill,s=i.textSize,a=i.markerFill,h=i.markerLineColor,l=e.Util.getValueOrDefault(i.textLineSpacing,0),u=e.DomUtil.createEl("textarea");u.style.cssText="background:"+a+";border:1px solid "+h+";color:"+o+";font-size:"+s+"px;width:"+(n-l)+"px;height:"+(r-l)+"px;";var c=this.getContent();u.value=c;var d=this;return e.DomUtil.on(u,"blur",function(t){
d.endEditText()}),u}}),e.View=function(t){t||(t={}),this.options=t,this._initView()},e.Util.extend(e.View.prototype,{defaultView:{"EPSG:3857":{resolutions:function(){for(var t=[],e=12756274*Math.PI,i=0;21>i;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;21>e;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{resolutions:function(){for(var t=Math.pow(2,18),e=[],i=0;20>i;i++)e[i]=t,t*=.5;return e[0]=null,e[1]=null,e[2]=null,e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}}},_initView:function(){var t=this.options.projection;if(t){if(e.Util.isString(t))for(var i in e.projection)if(e.projection.hasOwnProperty(i)){var n=e.projection[i].code;if(n&&n.toLowerCase()===t.toLowerCase()){t=e.projection[i];break}}}else t=e.projection.DEFAULT;if(!t||e.Util.isString(t))throw new Error("must provide a valid projection in map's view.");this._projection=t;var r=this.options.resolutions;if(!r){var o=this.defaultView[t.code];if(o&&(r=o.resolutions),!r)throw new Error("must provide valid resolutions in map's view.")}this._resolutions=r;var s=this.options.fullExtent;if(!s&&(s=this.defaultView[t.code].fullExtent,!r))throw new Error("must provide a valid fullExtent in map's view.");this._fullExtent=new e.Extent(new e.Coordinate(s.left,s.top),new e.Coordinate(s.right,s.bottom)),e.Util.extend(this._fullExtent,s);var a=s.right>s.left?1:-1,h=s.top>s.bottom?-1:1;this._transformation=new e.Transformation([a,h,0,0])},getResolutions:function(){return this._resolutions},getResolution:function(t){return this._resolutions[t]},getProjection:function(){return this._projection},getFullExtent:function(){return this._fullExtent},getTransformation:function(){return this._transformation},getMinZoom:function(){for(var t=0;t<this._resolutions.length;t++)if(!e.Util.isNil(this._resolutions[t]))return t;return 0},getMaxZoom:function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!e.Util.isNil(this._resolutions[t]))return t;return this._resolutions.length-1}}),e.Map=e.Class.extend({includes:[e.Eventable,e.Handlerable],options:{clipFullExtent:!1,zoomAnimation:!0,zoomAnimationDuration:330,zoomBackground:!0,layerZoomAnimation:!0,layerTransforming:!0,panAnimation:!0,panAnimationDuration:600,enableZoom:!0,enableInfoWindow:!0,hitDetect:function(){return!e.Browser.mobile}(),maxZoom:null,minZoom:null,maxExtent:null,renderer:"canvas"},exceptionDefs:{"en-US":{INVALID_OPTION:"Invalid options provided.",INVALID_CENTER:"Invalid Center",INVALID_LAYER_ID:"Invalid id for the layer",DUPLICATE_LAYER_ID:"the id of the layer is duplicate with another layer"},"zh-CN":{INVALID_OPTION:"option.",INVALID_CENTER:"",INVALID_LAYER_ID:"id",DUPLICATE_LAYER_ID:"id"}},initialize:function(t,i){if(!i)throw new Error(this.exceptions.INVALID_OPTION);if(!i.center)throw new Error(this.exceptions.INVALID_CENTER);if(this._loaded=!1,this._container=t,e.Util.isString(this._container)){if(this._containerDOM=document.getElementById(this._container),!this._containerDOM)throw new Error("invalid container: '"+t+"'")}else this._containerDOM=t,e.node&&(this.CanvasClass=this._containerDOM.constructor);this._panels={},this._baseLayer=null,this._layers=[];var n=e.Util.extend({},i);this._zoomLevel=n.zoom,delete n.zoom,this._center=new e.Coordinate(n.center),delete n.center;var r=n.baseLayer;delete n.baseLayer;var o=n.layers;delete n.layers,e.Util.setOptions(this,n),this.setView(n.view),r&&this.setBaseLayer(r),o&&this.addLayer(o),this._mapViewPoint=new e.Point(0,0),this._initRenderer(),this._getRenderer().initContainer(),this._updateMapSize(this._getContainerDomSize()),this._Load()},isLoaded:function(){return this._loaded},isCanvasRender:function(){var t=this._getRenderer();return t?t.isCanvasRender():!1},getView:function(){return this._view?this._view:null},setView:function(t){var i=this._view;if(i&&!t)return this;if(this._center=this.getCenter(),this.options.view=t,this._view=new e.View(t),this.options.view&&e.Util.isFunction(this.options.view.projection)){var n=this._view.getProjection();this.options.view.projection=n.code}return this._resetMapStatus(),this._fireEvent("viewchange"),this},onConfig:function(t){return e.Util.isNil(t.view)||this.setView(t.view),this},getProjection:function(){return this._view.getProjection()},getFullExtent:function(){return this._view.getFullExtent()},setCursor:function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},getCenter:function(){if(!this._loaded||!this._prjCenter)return this._center;var t=this.getProjection();return t.unproject(this._prjCenter)},setCenter:function(t){if(!t)return this;if(!this._verifyExtent(t))return this;if(t=new e.Coordinate(t),!this._loaded)return this._center=t,this;this._onMoveStart();var i=this.getProjection(),n=i.project(t);return this._setPrjCenterAndMove(n),this._onMoveEnd(),this},getSize:function(){return e.Util.isNil(this.width)||e.Util.isNil(this.height)?this._getContainerDomSize():new e.Size(this.width,this.height)},getExtent:function(){return this.viewToExtent(this._getViewExtent())},getMaxExtent:function(){return this.options.maxExtent?new e.Extent(this.options.maxExtent):null},setMaxExtent:function(t){if(t){var i=new e.Extent(t);this.options.maxExtent=i;var n=this.getCenter();this._verifyExtent(n)||this.panTo(i.getCenter())}else delete this.options.maxExtent;return this},getZoom:function(){return this._zoomLevel},getZoomForScale:function(t,i){e.Util.isNil(i)&&(i=this.getZoom());for(var n=this._getResolution(i),r=this._getResolutions(),o=Number.MAX_VALUE,s=-1,a=r.length-1;a>=0;a--){var h=Math.abs(n/r[a]-t);o>h&&(o=h,s=a)}return s},setZoom:function(t){return this.options.zoomAnimation?this._zoomAnimation(t):this._zoom(t),this},getMaxZoom:function(){if(!e.Util.isNil(this.options.maxZoom))return this.options.maxZoom;var t=this.getView();return t?t.getResolutions().length-1:null},setMaxZoom:function(t){var e=this._view.getMaxZoom();return t>e&&(t=e),t<this._zoomLevel&&this.setZoom(t),this.options.maxZoom=t,this},getMinZoom:function(){return e.Util.isNil(this.options.minZoom)?0:this.options.minZoom},setMinZoom:function(t){var e=this._view.getMinZoom();return e>t&&(t=e),this.options.minZoom=t,this},zoomIn:function(){return this.setZoom(this.getZoom()+1),this},zoomOut:function(){return this.setZoom(this.getZoom()-1),this},setCenterAndZoom:function(t,i){return this._zoomLevel!==i?(this.setCenter(t),e.Util.isNil(i)||this.setZoom(i)):this.setCenter(t),this},getFitZoom:function(t){if(!(t&&t instanceof e.Extent))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();for(var i=this.getProjection(),n=Math.abs(t.xmin-t.xmax),r=Math.abs(t.ymin-t.ymax),o=i.project({x:n,y:r}),s=this._getResolutions(),a=-1,h=-1,l=this.getMinZoom(),u=this.getMaxZoom();u>l&&(e.Util.round(o.x/s[l])>=this.width&&-1===a&&(a=l),e.Util.round(o.y/s[l])>=this.height&&-1===h&&(h=l),!(a>-1&&h>-1));l++);var c=h>a?a:h;return-1===c&&(c=h>a?h:a),-1===c?this.getMaxZoom():c},getBaseLayer:function(){return this._baseLayer},setBaseLayer:function(t){function i(){this._fireEvent("baselayerload"),n&&(n=!1,this._fireEvent("baselayerchangeend"))}var n=!1;return this._baseLayer&&(n=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),t instanceof e.TileLayer&&(t.config({renderWhenPanning:!0}),t.options.tileSystem||t.config("tileSystem",e.TileSystem.getDefault(this.getProjection()))),t._bindMap(this,-1),this._baseLayer=t,this._baseLayer.on("layerload",i,this),this._loaded&&this._baseLayer.load(),this},removeBaseLayer:function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},getLayers:function(t){return this._getLayers(function(i){return i===this._baseLayer||i.getId().indexOf(e.internalLayerPrefix)>=0?!1:t?t(i):!0})},getLayer:function(t){return t&&this._layerCache&&this._layerCache[t]?this._layerCache[t]:null},addLayer:function(t){if(!t)return this;if(!e.Util.isArray(t))return this.addLayer([t]);this._layerCache||(this._layerCache={});for(var i=0,n=t.length;n>i;i++){var r=t[i],o=r.getId();if(e.Util.isNil(o))throw new Error(this.exceptions.INVALID_LAYER_ID+":"+o);if(this._layerCache[o])throw new Error(this.exceptions.DUPLICATE_LAYER_ID+":"+o);this._layerCache[o]=r,r._bindMap(this,this._layers.length),this._layers.push(r),this._loaded&&r.load()}return this},removeLayer:function(t){if(!t)return this;if(!e.Util.isArray(t))return this.removeLayer([t]);for(var i=0,n=t.length;n>i;i++){var r=t[i];if(r instanceof e.Layer||(r=this.getLayer(r)),r){var o=r.getMap();if(o&&o===this){this._removeLayer(r,this._layers),this._loaded&&r._onRemove();var s=r.getId();this._layerCache&&delete this._layerCache[s],r.fire("remove")}}}return this},sortLayers:function(t){if(!t||!e.Util.isArray(t))return this;for(var i=[],n=Number.MAX_VALUE,r=0;r<t.length;r++){var o=t[r];if(e.Util.isString(t[r])&&(o=this.getLayer(o)),!(o instanceof e.Layer&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<n&&(n=o.getZIndex()),i.push(o)}for(var s=0;s<i.length;s++)i[s].setZIndex(n+s);return this},toDataURL:function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var i=t.save,n=this._getRenderer();if(n){var r=t.filename;r||(r="export");var o=n.toDataURL(e);if(i&&o){var s=o,a=document.createElement("a");a.download=r,a.href=s,a.dataset.downloadurl=[e,a.download,a.href].join(":"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}return o}return null},coordinateToPoint:function(t,e){var i=this.getProjection().project(t);return this._prjToPoint(i,e)},pointToCoordinate:function(t,e){var i=this._pointToPrj(t,e);return this.getProjection().unproject(i)},coordinateToViewPoint:function(t){return this._prjToViewPoint(this.getProjection().project(t))},viewPointToCoordinate:function(t){return this.getProjection().unproject(this._viewPointToPrj(t))},coordinateToContainerPoint:function(t){var e=this.getProjection().project(t);return this._prjToContainerPoint(e)},containerPointToCoordinate:function(t){var e=this._containerPointToPrj(t);return this.getProjection().unproject(e)},containerPointToViewPoint:function(t){return t.substract(this.offsetPlatform())},viewPointToContainerPoint:function(t){return t.add(this.offsetPlatform())},viewToExtent:function(t){var i=this.getProjection();if(!i)return null;var n=this._getResolution();if(e.Util.isNil(n))return null;var r=this._getViewExtent().getCenter(),o=this._getPrjCenter(),s=t.getMin(),a=t.getMax(),h=r.substract(s),l=r.substract(a),u=i.unproject(new e.Coordinate(o.x-h.x*n,o.y+h.y*n)),c=i.unproject(new e.Coordinate(o.x-l.x*n,o.y+l.y*n));return new e.Extent(u,c)},containerToExtent:function(t){var i=new e.PointExtent(this.containerPointToViewPoint(t.getMin()),this.containerPointToViewPoint(t.getMax()));return this.viewToExtent(i)},checkSize:function(){function t(){var t=i._getContainerDomSize(),n=i.height,r=i.width;if(t.width!==r||t.height!==n){i._updateMapSize(t);var o=new e.Point((r-t.width)/2,(n-t.height)/2);i._offsetCenterByPixel(o),i._fireEvent("resize")}}this._resizeTimeout&&clearTimeout(this._resizeTimeout);var i=this;return this._resizeTimeout=setTimeout(function(){t(),setTimeout(function(){t()},1)},100),this},distanceToPixel:function(t,i){var n=this.getProjection();if(!n)return null;var r=this.getCenter(),o=n.locate(r,t,i),s=this._getResolution(),a=t?(n.project(new e.Coordinate(o.x,r.y)).x-n.project(r).x)/s:0,h=i?(n.project(new e.Coordinate(r.x,o.y)).y-n.project(r).y)/s:0;return new e.Size(Math.abs(a),Math.abs(h))},pixelToDistance:function(t,i){var n=this.getProjection();if(!n)return null;var r=this.getCenter(),o=this._getPrjCenter(),s=this._getResolution(),a=new e.Coordinate(o.x+t*s,o.y+i*s),h=n.unproject(a);return n.measureLength(h,r)},locate:function(t,i,n){return this.getProjection().locate(new e.Coordinate(t),i,n)},getPanel:function(){return this._getRenderer().getPanel()},_isBusy:function(){return this._zooming},_trySetCursor:function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},_setPriorityCursor:function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},_setCursorToPanel:function(t){var e=this.getPanel();e&&e.style&&(e.style.cursor=t)},_getViewExtent:function(){var t=this.getSize(),i=this.offsetPlatform(),n=new e.Point(0,0),r=new e.Point(t.width,t.height);return new e.PointExtent(n.substract(i),r.substract(i))},_setPrjCenterAndMove:function(t){var e=this._getPixelDistance(t);this._setPrjCenter(t),this.offsetPlatform(e)},_removeLayer:function(t,i){if(t&&i){var n=e.Util.indexOfArray(t,i);if(n>-1){i.splice(n,1);for(var r=0,o=i.length;o>r;r++)i[r].setZIndex&&i[r].setZIndex(r)}}},_sortLayersByZIndex:function(t){t.sort(function(t,e){return t.getZIndex()-e.getZIndex()})},_onMoveStart:function(){this._originCenter=this.getCenter(),this._enablePanAnimation=!1,this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart")},_onMoving:function(){this._fireEvent("moving")},_onMoveEnd:function(){this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend"),this._verifyExtent(this.getCenter())||this.panTo(this._originCenter)},_getPixelDistance:function(t){var i=this._getPrjCenter(),n=this._prjToContainerPoint(i),r=this._prjToContainerPoint(t),o=new e.Point(-r.x+n.x,n.y-r.y);return o},_fireEvent:function(t,e){this.fire("_"+t,e),this.fire(t,e)},_Load:function(){this._resetMapStatus(),this._registerDomEvents(),this._loadAllLayers(),this._loaded=!0,this._callOnLoadHooks(),this._fireEvent("load")},_initRenderer:function(){var t=this.options.renderer,i=e.Map.getRendererClass(t);this._renderer=new i(this)},_getRenderer:function(){return this._renderer},_loadAllLayers:function(){function t(t){t&&t.load()}this._baseLayer&&this._baseLayer.load(),this._eachLayer(t,this.getLayers())},_getLayers:function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],n=0;n<e.length;n++)t&&!t.call(this,e[n])||i.push(e[n]);return i},_eachLayer:function(t){if(!(arguments.length<2)){var i=Array.prototype.slice.call(arguments,1);i&&!e.Util.isArray(i)&&(i=[i]);for(var n=[],r=0,o=i.length;o>r;r++)n=n.concat(i[r]);for(var s=0,a=n.length;a>s;s++)t.call(t,n[s])}},_resetMapStatus:function(){var t=this.getMaxZoom(),e=this.getMinZoom(),i=this._view.getMaxZoom(),n=this._view.getMinZoom();(!t||-1===t||t>i)&&this.setMaxZoom(i),(!e||-1===e||n>e)&&this.setMinZoom(n),t=this.getMaxZoom(),e=this.getMinZoom(),e>t&&this.setMaxZoom(e),(!this._zoomLevel||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var r=this.getProjection();this._prjCenter=r.project(this._center)},_getContainerDomSize:function(){if(!this._containerDOM)return null;var t,i,n=this._containerDOM;if(e.Util.isNil(n.width)||e.Util.isNil(n.height)){if(e.Util.isNil(n.clientWidth)||e.Util.isNil(n.clientHeight))throw new Error("can not get size of container");t=parseInt(n.clientWidth,0),i=parseInt(n.clientHeight,0)}else t=n.width,i=n.height,e.Browser.retina&&n[e.renderer.tilelayer.Canvas.prototype.propertyOfTileId]&&(t/=2,i/=2);return new e.Size(t,i)},_updateMapSize:function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this},_getPrjCenter:function(){return this._prjCenter},_setPrjCenter:function(t){this._prjCenter=t},_verifyExtent:function(t){if(!t)return!1;var i=this.getMaxExtent();return i?i.contains(new e.Coordinate(t)):!0},_offsetCenterByPixel:function(t){var i=this.width/2-t.x,n=this.height/2-t.y,r=this._containerPointToPrj(new e.Point(i,n));return this._setPrjCenter(r),r},offsetPlatform:function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},_resetMapViewPoint:function(){this._mapViewPoint=new e.Point(0,0)},_getResolution:function(t){return e.Util.isNil(t)&&(t=this.getZoom()),this._view.getResolution(t)},_getResolutions:function(){return this._view.getResolutions()},_prjToPoint:function(t,e){return e=void 0===e?this.getZoom():e,this._view.getTransformation().transform(t,this._getResolution(e))},_pointToPrj:function(t,e){return e=void 0===e?this.getZoom():e,this._view.getTransformation().untransform(t,this._getResolution(e))},_containerPointToPrj:function(t){var i=this._prjToPoint(this._getPrjCenter()),n=new e.Point(i.x+t.x-this.width/2,i.y+t.y-this.height/2);return this._pointToPrj(n)},_viewPointToPrj:function(t){return this._containerPointToPrj(this.viewPointToContainerPoint(t))},_prjToContainerPoint:function(t){var i=this._prjToPoint(this._getPrjCenter()),n=this._prjToPoint(t);return new e.Point(this.width/2+n.x-i.x,this.height/2+n.y-i.y)},_prjToViewPoint:function(t){var e=this._prjToContainerPoint(t);return this._containerPointToViewPoint(e)},_containerPointToViewPoint:function(t){if(!t)return null;var e=this.offsetPlatform();return t._substract(e)}}),e.Map.prototype._callOnLoadHooks=function(){for(var t=e.Map.prototype,i=0,n=t._onLoadHooks.length;n>i;i++)t._onLoadHooks[i].call(this)},e.Map.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(i),this},e.Util.extend(e.Map,e.Renderable),e.Map.include({panTo:function(t,i){if(!t)return this;var n=this;t=new e.Coordinate(t);var r=this.coordinateToViewPoint(t),o=this.offsetPlatform();return this._panBy(r.substract(o),i,function(){var e=n.getProjection().project(t);n._setPrjCenterAndMove(e)})},panBy:function(t,e){return this._panBy(t,e)},_panBy:function(t,i,n){return t?(t=new e.Point(t).multi(-1),this._onMoveStart(),i||(i={}),"undefined"==typeof i.animation||i.animation?this._panAnimation(t,i.duration,n):(this.offsetPlatform(t),this._offsetCenterByPixel(t),this._onMoving(),n&&n(),this._onMoveEnd()),this):this},_panAnimation:function(t,e,i){this._getRenderer().panAnimation(t,e,i)}}),e.Map.include({_zoom:function(t,i,n){this._originZoomLevel=this.getZoom(),t=this._checkZoomLevel(t),this._onZoomStart(t);var r;i&&(i=new e.Point(this.width/2,this.height/2),r=this._getZoomCenterOffset(t,i,n)),this._onZoomEnd(t,r)},_zoomAnimation:function(t,i,n){this.options.enableZoom&&(e.Util.isNil(n)&&(n=1),e.Util.isNil(this._originZoomLevel)&&(this._originZoomLevel=this.getZoom()),t=this._checkZoomLevel(t),this._originZoomLevel!==t&&(this._onZoomStart(t),i||(i=new e.Point(this.width/2,this.height/2)),this._startZoomAnimation(n,i,t)))},_startZoomAnimation:function(t,i,n){var r=this,o=this._getResolutions(),s=o[this._originZoomLevel]/o[n],a=this._getZoomCenterOffset(n,i,t);0===a.x&&0===a.y&&(i=new e.Point(this.width/2,this.height/2));var h=this.options.zoomAnimationDuration*Math.abs(s-t)/Math.abs(s-1);this._getRenderer().onZoomStart({startScale:t,endScale:s,origin:i,duration:h},function(){r._onZoomEnd(n,a)})},_onZoomStart:function(t){this._zooming=!0,this._enablePanAnimation=!1,this._fireEvent("zoomstart",{from:this._originZoomLevel,to:t})},_onZoomEnd:function(t,e){this._zoomLevel=t,e&&this._offsetCenterByPixel(e._multi(-1));var i=this._originZoomLevel;this._originZoomLevel=t,this._getRenderer().onZoomEnd(),this._zooming=!1,this._fireEvent("zoomend",{from:i,to:t})},_checkZoomLevel:function(t){var e=this.getMaxZoom(),i=this.getMinZoom();return i>t&&(t=i),t>e&&(t=e),t},_getZoomCenterOffset:function(t,i,n){e.Util.isNil(n)&&(n=1);var r,o,s=this._getResolutions();t<this._originZoomLevel?(r=s[t+1]/s[t],o=new e.Point(-(i.x-this.width/2)*(n-r),-(i.y-this.height/2)*(n-r))):(r=s[t-1]/s[t],o=new e.Point((i.x-this.width/2)*(r-n),(i.y-this.height/2)*(r-n)));var a=this.containerPointToCoordinate(new e.Point(this.width/2+o.x,this.height/2+o.y));return this._verifyExtent(a)?o:new e.Point(0,0)},_getZoomMillisecs:function(){return 600}}),e.Map.include({computeLength:function(t,i){if(!this.getProjection())return null;var n=new e.Coordinate(t),r=new e.Coordinate(i);return n.equals(r)?0:this.getProjection().measureLength(n,r)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,i){if(!t)return this;var n=t.layers;if(!e.Util.isArrayHasData(n))return this;var r,o,s=[];for(r=0,o=n.length;o>r;r++)e.Util.isString(n[r])?s.push(this.getLayer(n[r])):s.push(n[r]);var a=this.coordinateToViewPoint(t.coordinate)._round(),h=i,l=t.filter,u=[],c=!1;for(r=s.length-1;r>=0&&!c;r--){var d=s[r];if(d&&d.getMap()&&(t.includeInternals||!(d.getId().indexOf(e.internalLayerPrefix)>=0)))for(var f=s[r].getGeometries(),m=f.length-1;m>=0;m--){var _=f[m];if(_&&_.isVisible()){var g=_._getPainter()?_._getPainter().getViewExtent():null;if(g&&g.contains(a)&&_._containsPoint(a)&&(!l||l&&l(_))&&(u.push(_),t.count&&u.length>=t.count)){c=!0;break}}}}return h.call(this,u),this}}),e.Map.include({_registerDomEvents:function(t){var i="mousedown mouseup mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend ",n=this._panels.mapWrapper||this._containerDOM;t?e.DomUtil.removeDomEvent(n,i,this._handleDOMEvent,this):e.DomUtil.addDomEvent(n,i,this._handleDOMEvent,this)},_handleDOMEvent:function(t){if(!this._ignoreEvent(t)){var e=t.type;this._fireDOMEvent(this,t,e)}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;var e=t.srcElement||t.target;if(e)for(;e&&e!==this._containerDOM;){if("maptalks-control"===e.className)return!0;e=e.parentNode}return!1},_parseEvent:function(t,i){var n={domEvent:t};if("keypress"!==i){var r=t.touches?t.touches[0]:t;if(r){var o=e.DomUtil.getEventContainerPoint(r,this._containerDOM);n.coordinate=this.containerPointToCoordinate(o),n.containerPoint=o,n.viewPoint=this.containerPointToViewPoint(o)}}return n},_fireDOMEvent:function(t,i,n){var r=this._parseEvent(i,n);if("contextmenu"===n&&e.DomUtil.preventDefault(i),"mousedown"===n||"click"===n){var o=i.button;2===o&&(n="contextmenu")}this._fireEvent(n,r)}}),e.Map.include({requestFullScreen:function(){return this._fireEvent("fullscreenstart"),this._requestFullScreen(this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(this._containerDOM),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullScreen)t.requestFullScreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45),i=window.open(location.href,"_blank",e);null!==i&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{var t="fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes",e=window.open(location.href,"_blank",t);null!==e&&(window.opener=null,window.close())}}}),e.Layer.fromJSON=function(t){if(!t)return null;var i=t.type;if("vector"===i?i=t.type="VectorLayer":"dynamic"===i?i=t.type="DynamicLayer":"tile"===i&&(i=t.type="TileLayer"),"undefined"==typeof e[i]||!e[i]._fromJSON)throw new Error("unsupported layer type:"+i);return e[i]._fromJSON(t)},e.Map.include({PROFILE_VERSION:"1.0",toJSON:function(t){t||(t={});var i={version:this.PROFILE_VERSION,extent:this.getExtent().toJSON()};i.options=this.config(),i.options.center=this.getCenter(),i.options.zoom=this.getZoom();var n=this.getBaseLayer();(e.Util.isNil(t.baseLayer)||t.baseLayer)&&n&&(i.baseLayer=n.toJSON(t.baseLayer));var r={};t.clipExtent&&(t.clipExtent===!0?r.clipExtent=this.getExtent():r.clipExtent=t.clipExtent);var o,s,a,h,l=[];if(e.Util.isNil(t.layers)||t.layers&&!e.Util.isArray(t.layers)){for(a=this.getLayers(),o=0,s=a.length;s>o;o++)h=e.Util.extend({},e.Util.isObject(t.layers)?t.layers:{},r),l.push(a[o].toJSON(h));i.layers=l}else if(e.Util.isArrayHasData(t.layers)){for(a=t.layers,o=0;o<a.length;o++){var u=a[o],c=this.getLayer(u.id);h=e.Util.extend({},u.options,r),l.push(c.toJSON(h))}i.layers=l}else i.layers=[];return i}}),e.Map.fromJSON=function(t,i,n){if(!t||!i)return null;n||(n={});var r=new e.Map(t,i.options);if(e.Util.isNil(n.baseLayer)||n.baseLayer){var o=e.Layer.fromJSON(i.baseLayer);o&&r.setBaseLayer(o)}if(e.Util.isNil(n.layers)||n.layers){for(var s=[],a=i.layers,h=0;h<a.length;h++){var l=e.Layer.fromJSON(a[h]);s.push(l)}r.addLayer(s)}return r},e.Map.mergeOptions({draggable:!0}),e.Map.Drag=e.Handler.extend({addHooks:function(){var t=this.target;t&&(this.dom=t._panels.mapWrapper||t._containerDOM,this._dragHandler=new e.Handler.Drag(this.dom),t.on(this._dragHandler.START.join(" "),this._onMouseDown,this),this._dragHandler.on("dragstart",this._onDragStart,this),this._dragHandler.on("dragging",this._onDragging,this),this._dragHandler.on("dragend",this._onDragEnd,this),this._dragHandler.enable())},removeHooks:function(){var t=this.target;t.off(this._dragHandler.START.join(" "),this._onMouseDown,this),this._dragHandler.disable(),delete this._dragHandler},_ignore:function(t){return t&&t.domEvent?this.target._ignoreEvent(t.domEvent):!1},_onMouseDown:function(t){this._ignore(t)||this.target._panAnimating&&(this.target._enablePanAnimation=!1)},_onDragStart:function(t){if(!this._ignore(t)){var e=this.target;this.startDragTime=(new Date).getTime();var i=e.offsetPlatform();this.startLeft=i.x,this.startTop=i.y,this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY,e._onMoveStart()}},_onDragging:function(t){if(!this._ignore(t)&&(e.DomUtil.preventDefault(t.domEvent),void 0!==this.startLeft)){var i=this.target,n=t.mousePos.x,r=t.mousePos.y,o=this.startLeft+n-this.startX,s=this.startTop+r-this.startY,a=i.offsetPlatform(),h=new e.Point(o,s)._substract(a);i.offsetPlatform(h),i._offsetCenterByPixel(h),i._onMoving()}},_onDragEnd:function(t){if(!this._ignore(t)&&(e.DomUtil.preventDefault(t.domEvent),void 0!==this.startLeft)){var i=this.target,n=(new Date).getTime()-this.startDragTime,r=i.offsetPlatform(),o=r.x-this.startLeft,s=r.y-this.startTop;if(delete this.startLeft,delete this.startTop,delete this.preX,delete this.preY,delete this.startX,delete this.startY,280>n&&Math.abs(s)+Math.abs(o)>5){var a=new e.Point(o*Math.ceil(500/n),s*Math.ceil(500/n)).multi(.5);n=5*n*(Math.abs(a.x)+Math.abs(a.y))/600,i._panAnimation(a._multi(2/3),n)}else i._onMoveEnd()}}}),e.Map.addInitHook("addHandler","draggable",e.Map.Drag),e.Map.mergeOptions({autoBorderPanning:!1}),e.Map.AutoBorderPanning=e.Handler.extend({threshold:10,step:4,addHooks:function(){this._dom=this.target._containerDOM,e.DomUtil.on(this._dom,"mousemove",this._onMouseMove,this),e.DomUtil.on(this._dom,"mouseout",this._onMouseOut,this)},removeHooks:function(){this._cancelPan(),e.DomUtil.off(this._dom,"mousemove",this._onMouseMove,this),e.DomUtil.off(this._dom,"mouseout",this._onMouseOut,this)},_onMouseMove:function(t){var i=this.target._parseEvent(t),n=i.containerPoint,r=this.target.getSize(),o=[n.x,r.width-n.x,n.y,r.height-n.y],s=Math.min.apply(Math,o),a=Math.abs(s);if(0===a||a>this.threshold)return void this._cancelPan();var h=this.step,l=new e.Point(0,0);o[0]===s?l.x=-h:o[1]===s&&(l.x=h),o[2]===s?l.y=-h:o[3]===s&&(l.y=h),this._stepOffset=l,this._pan()},_onMouseOut:function(){this._cancelPan()},_cancelPan:function(){delete this._stepOffset,this._animationId&&(e.Util.cancelAnimFrame(this._animationId),delete this._animationId)},_pan:function(){this._stepOffset&&(this.target.panBy(this._stepOffset,{animation:!1}),this._animationId=e.Util.requestAnimFrame(e.Util.bind(this._pan,this)))}}),e.Map.addInitHook("addHandler","autoBorderPanning",e.Map.AutoBorderPanning),e.Map.mergeOptions({doubleClickZoom:!0}),e.Map.DoubleClickZoom=e.Handler.extend({addHooks:function(){this.target.on("_dblclick",this._onDoubleClick,this)},removeHooks:function(){this.target.off("_dblclick",this._onDoubleClick,this)},_onDoubleClick:function(t){var e=this.target;if(e.options.doubleClickZoom){var i=e.getZoom(),n=t.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;e._zoomAnimation(n,t.containerPoint)}}}),e.Map.addInitHook("addHandler","doubleClickZoom",e.Map.DoubleClickZoom),e.Map.mergeOptions({scrollWheelZoom:!0}),e.Map.ScrollWheelZoom=e.Handler.extend({addHooks:function(){e.DomUtil.addDomEvent(this.target._containerDOM,"mousewheel",this._onWheelScroll,this)},removeHooks:function(){e.DomUtil.removeDomEvent(this.target._containerDOM,"mousewheel",this._onWheelScroll)},_onWheelScroll:function(t){var i=this.target,n=i._containerDOM;if(e.DomUtil.preventDefault(t),e.DomUtil.stopPropagation(t),i._zooming)return!1;var r=0;r+=(t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1,t.detail&&(r*=-1);var o=e.DomUtil.getEventContainerPoint(t,n);return this._wheelExecutor&&clearTimeout(this._wheelExecutor),this._wheelExecutor=setTimeout(function(){i._zoomAnimation(i.getZoom()+r,o)},40),!1}}),e.Map.addInitHook("addHandler","scrollWheelZoom",e.Map.ScrollWheelZoom),e.Map.mergeOptions({touchZoom:!0,touchZoomOrigin:"center"}),e.Map.TouchZoom=e.Handler.extend({addHooks:function(){e.DomUtil.addDomEvent(this.target._containerDOM,"touchstart",this._onTouchStart,this)},removeHooks:function(){e.DomUtil.removeDomEvent(this.target._containerDOM,"touchstart",this._onTouchStart)},_onTouchStart:function(t){var i=this.target;if(t.touches&&2===t.touches.length&&!i._zooming){var n=i._containerDOM,r=e.DomUtil.getEventContainerPoint(t.touches[0],n),o=e.DomUtil.getEventContainerPoint(t.touches[1],n);if(this._startDist=r.distanceTo(o),this._startZoom=i.getZoom(),"pinch"===i.options.touchZoomOrigin)this._preOrigin=r.add(o)._multi(.5);else{var s=i.getSize();this._preOrigin=new e.Point(s.width/2,s.height/2)}i._zooming=!0,e.DomUtil.addDomEvent(document,"touchmove",this._onTouchMove,this).addDomEvent(document,"touchend",this._onTouchEnd,this),e.DomUtil.preventDefault(t),i._fireEvent("touchzoomstart")}},_onTouchMove:function(t){var i=this.target;if(t.touches&&2===t.touches.length&&i._zooming){var n,r=i._containerDOM,o=e.DomUtil.getEventContainerPoint(t.touches[0],r),s=e.DomUtil.getEventContainerPoint(t.touches[1],r),a=o.distanceTo(s)/this._startDist;if("pinch"===i.options.touchZoomOrigin)n=o.add(s)._multi(.5);else{var h=i.getSize();n=new e.Point(h.width/2,h.height/2)}var l=this._preOrigin.substract(n);i.offsetPlatform(l),i._offsetCenterByPixel(l),this._preOrigin=n,this._scale=a;var u=i._getRenderer(),c=u.getZoomMatrix(a,n,e.Browser.retina);u.transform(c),e.DomUtil.preventDefault(t)}},_onTouchEnd:function(){var t=this.target;if(!t._zooming)return void(t._zooming=!1);t._zooming=!1,e.DomUtil.off(document,"touchmove",this._onTouchMove,this).off(document,"touchend",this._onTouchEnd,this);var i=this._scale,n=t.getZoomForScale(i);-1===n&&(n=t.getZoom()),t._fireEvent("touchzoomend"),t._zoomAnimation(n,this._preOrigin,this._scale)}}),e.Map.addInitHook("addHandler","touchZoom",e.Map.TouchZoom),e.Map.mergeOptions({geometryEvents:!0}),e.Map.GeometryEvents=e.Handler.extend({EVENTS:"mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",addHooks:function(){var t=this.target,i=t._panels.canvasContainer;i&&e.DomUtil.on(i,this.EVENTS,this._identifyGeometryEvents,this)},removeHooks:function(){var t=this.target,i=t._panels.canvasContainer;i&&e.DomUtil.off(i,this.EVENTS,this._identifyGeometryEvents,this)},_identifyGeometryEvents:function(t){function i(i){var r;if("mousemove"===a){var o={};if(e.Util.isArrayHasData(i))for(r=i.length-1;r>=0;r--)o[i[r]._getInternalId()]=i[r],
i[r]._onEvent(t),i[r]._onMouseOver(t);n._setPriorityCursor(u);var s=f._prevMouseOverTargets;if(f._prevMouseOverTargets=i,e.Util.isArrayHasData(s))for(r=s.length-1;r>=0;r--){var h=s[r],l=s[r]._getInternalId();if(i&&i.length>0){var c=!0;o[l]&&(c=!1),c&&h._onMouseOut(t)}else h._onMouseOut(t)}}else{if(!i||0===i.length)return;i[i.length-1]._onEvent(t)}}var n=this.target,r=n._getLayers(function(t){return t instanceof e.VectorLayer});if(!n._isBusy()&&r&&0!==r.length){for(var o=[],s=0;s<r.length;s++)r[s].options.geometryEvents&&o.push(r[s]);if(0!==o.length){var a=t.type,h=e.DomUtil.getEventContainerPoint(t,n._containerDOM),l=n.containerPointToCoordinate(h),u=null,c={includeInternals:!0,filter:function(e){var i=e._getEventTypeToFire(t);if("mousemove"===a){if(!u&&e.options.cursor&&(u=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover"))return!1}else if(!e.listens(i))return!1;return!0},count:1,coordinate:l,layers:o},d=e.Util.bind(i,this),f=this;this._queryIdentifyTimeout&&e.Util.cancelAnimFrame(this._queryIdentifyTimeout),"mousemove"===a||"touchmove"===a?this._queryIdentifyTimeout=e.Util.requestAnimFrame(function(){n.identify(c,d)}):n.identify(c,d)}}}}),e.Map.addInitHook("addHandler","geometryEvents",e.Map.GeometryEvents),e.renderer={},e.renderer.Canvas=e.Class.extend({isCanvasRender:function(){return!0},render:function(){if(this._prepareRender(),this.getMap()){if(!this._layer.isVisible())return void this._complete();if(this.checkResources){var t=this,i=arguments,n=this.checkResources.apply(this,i);e.Util.isArrayHasData(n)?this._loadResources(n).then(function(){t._layer&&t.draw.apply(t,i)}):this.draw.apply(this,i)}else this.draw.apply(this,arguments)}},remove:function(){this._onRemove&&this._onRemove(),delete this._canvas,delete this._context,delete this._viewExtent,delete this._resources,e.renderer.Canvas.prototype._requestMapToRender.call(this),delete this._layer},getMap:function(){return this._layer?this._layer.getMap():null},getLayer:function(){return this._layer},getCanvasImage:function(){if(!this._canvas)return null;if(this._layer.isEmpty&&this._layer.isEmpty()||!this._viewExtent)return null;if(this.isBlank&&this.isBlank())return null;var t=this._viewExtent.getSize(),e=this._viewExtent.getMin();return{image:this._canvas,layer:this._layer,point:this.getMap().viewPointToContainerPoint(e),size:t}},isLoaded:function(){return!!this._loaded},show:function(){var t=this._layer.getMask();t&&t._onZoomEnd(),this.render()},hide:function(){this._clearCanvas(),this._requestMapToRender()},setZIndex:function(){this._requestMapToRender()},getRenderZoom:function(){return this._renderZoom},hitDetect:function(t){if(!this._context||this._layer.isEmpty&&this._layer.isEmpty()||this._errorThrown)return!1;var e=this.getMap()._getViewExtent(),i=e.getSize(),n=e.getMin(),r=t.substract(n);if(r.x<0||r.x>i.width||r.y<0||r.y>i.height)return!1;try{var o=this._context.getImageData(r.x,r.y,1,1).data;if(o[3]>0)return!0}catch(s){return this._errorThrown||(console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",s),this._errorThrown=!0),!1}return!1},_loadResources:function(t){this._resources||(this._resources=new e.renderer.Canvas.Resources);var i=this._resources,n=[];if(e.Util.isArrayHasData(t))for(var r,o={},s=t.length-1;s>=0;s--)r=t[s],r&&!o[r.join("-")]&&(o[r.join("-")]=1,i.isResourceLoaded(r)||n.push(new e.Promise(this._promiseResource(r))));return e.Promise.all(n)},_promiseResource:function(t){var i=this,n=this._resources,r=this._layer.options.crossOrigin;return function(o){if(n.isResourceLoaded(t))return void o({});var s=new Image;r&&(s.crossOrigin=r),e.Util.isSVG(t[0])&&!e.node&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),s.onload=function(){i._cacheResource(t,this),o({})},s.onabort=function(e){console.warn("image loading aborted: "+t[0]),e&&console.warn(e),o({})},s.onerror=function(i){i&&!e.Browser.phantomjs&&console.warn(i),n.markErrorResource(t),o({})},e.Util.loadImage(s,t)}},_cacheResource:function(t,i){if(this._layer){var n=t[1],r=t[2];if(this._layer.options.cacheSvgOnCanvas&&1===e.Util.isSVG(t[0])&&(e.Browser.edge||e.Browser.ie)){e.Util.isNil(n)&&(n=i.width||this._layer.options.defaultIconSize[0]),e.Util.isNil(r)&&(r=i.height||this._layer.options.defaultIconSize[1]);var o=e.Canvas.createCanvas(n,r);e.Canvas.image(o.getContext("2d"),i,0,0,n,r),i=o}this._resources.addResource(t,i)}},_prepareRender:function(){this._renderZoom=this.getMap().getZoom(),this._viewExtent=this.getMap()._getViewExtent(),this._loaded=!1},_requestMapToRender:function(){this.getMap()&&(this._context&&this._layer.fire("renderend",{context:this._context}),this.getMap()._getRenderer().render())},_fireLoadedEvent:function(){this._loaded=!0,this._layer&&this._layer.fire("layerload")},_complete:function(){this._requestMapToRender(),this._fireLoadedEvent()},_createCanvas:function(){if(!this._canvas){var t=this.getMap(),i=t.getSize(),n=e.Browser.retina?2:1;this._canvas=e.Canvas.createCanvas(n*i.width,n*i.height,t.CanvasClass),this._context=this._canvas.getContext("2d"),e.Browser.retina&&this._context.scale(2,2),e.Canvas.setDefaultCanvasSetting(this._context)}},_resizeCanvas:function(t){if(this._canvas){var i;if(t)i=t;else{var n=this.getMap();i=n.getSize()}var r=e.Browser.retina?2:1;this._canvas.width>=r*i.width&&this._canvas.height>=r*i.height||(this._canvas.height=r*i.height,this._canvas.width=r*i.width,e.Browser.retina&&this._context.scale(2,2))}},_clearCanvas:function(){this._canvas&&e.Canvas.clearRect(this._context,0,0,this._canvas.width,this._canvas.height)},_prepareCanvas:function(){this._clipped&&(this._context.restore(),this._clipped=!1),this._canvas?this._clearCanvas():this._createCanvas();var t=this.getLayer().getMask();if(!t)return null;var e=t._getPainter().getViewExtent();return e.intersects(this._viewExtent)?(this._context.save(),t._getPainter().paint(),this._context.clip(),this._clipped=!0,this._layer.fire("renderstart",{context:this._context}),e):e},getPaintContext:function(){return this._context?[this._context,this._resources]:null},_getEvents:function(){return{_zoomend:this._onZoomEnd,_resize:this._onResize,_moveend:this._onMoveEnd}},_onZoomEnd:function(){this.render()},_onMoveEnd:function(){this.render()},_onResize:function(){this._resizeCanvas(),this.render()}}),e.renderer.Canvas.Resources=function(){this._resources={},this._errors={}},e.Util.extend(e.renderer.Canvas.Resources.prototype,{addResource:function(t,e){this._resources[t[0]]={image:e,width:+t[1],height:+t[2]}},isResourceLoaded:function(t){if(this._errors[this._getImgUrl(t)])return!0;var e=this._resources[this._getImgUrl(t)];return e?!(+t[1]>e.width||+t[2]>e.height):!1},getImage:function(t){return!this.isResourceLoaded(t)||this._errors[this._getImgUrl(t)]?null:this._resources[this._getImgUrl(t)].image},markErrorResource:function(t){this._errors[this._getImgUrl(t)]=1},_getImgUrl:function(t){return e.Util.isArray(t)?t[0]:t}}),e.renderer.map={},e.renderer.map.Renderer=e.Class.extend({getZoomMatrix:function(t,i,n){var r=this.map.containerPointToViewPoint(i),o={container:(new e.Matrix).translate(i.x,i.y).scaleU(t).translate(-i.x,-i.y),view:(new e.Matrix).translate(r.x,r.y).scaleU(t).translate(-r.x,-r.y)};return n&&(i=i.multi(2),o.retina=(new e.Matrix).translate(i.x,i.y).scaleU(t).translate(-i.x,-i.y)),o.scale={x:t,y:t},o},panAnimation:function(t,i,n){t=new e.Point(t);var r=this.map;if(r.options.panAnimation){var o;o=i?i:r.options.panAnimationDuration,r._enablePanAnimation=!0,r._panAnimating=!0;var s=null,a=e.Animation.animate({distance:t},{easing:"out",speed:o},function(t){if(!r._enablePanAnimation)return a.finish(),r._panAnimating=!1,void r._onMoveEnd();if("running"===a.playState&&t.styles.distance){var e=t.styles.distance._round();s||(s=e);var i=e.substract(s);r.offsetPlatform(i),r._offsetCenterByPixel(i),s=e,r._onMoving()}else"finished"===a.playState&&(r._panAnimating=!1,n&&n(),r._onMoveEnd())});a.play()}else r._onMoveEnd()},offsetPlatform:function(t){if(!this.map._panels.mapPlatform)return this;var i=this.map._panels.mapPlatform;return e.DomUtil.offsetDom(i,this.map.offsetPlatform().add(t)._round()),this},resetContainer:function(){this.map._resetMapViewPoint(),this.map._panels.mapPlatform&&(e.DomUtil.offsetDom(this.map._panels.mapPlatform,new e.Point(0,0)),this._resetCanvasContainer())},_resetCanvasContainer:function(){var t=this.map.offsetPlatform(),i=t.multi(-1)._round();this.map._panels.canvasContainer._pos=i,e.DomUtil.offsetDom(this.map._panels.canvasContainer,i)},_getCanvasContainerPos:function(){return this.map._panels&&this.map._panels.canvasContainer?this.map._panels.canvasContainer._pos:null},onZoomEnd:function(){this.resetContainer()}}),e.renderer.map.Canvas=e.renderer.map.Renderer.extend({initialize:function(t){this.map=t,this._isCanvasContainer=!!t._containerDOM.getContext,this._registerEvents()},isCanvasRender:function(){return!0},render:function(){this.map._fireEvent("renderstart",{context:this._context}),this._canvas||this._createCanvas();var t=this.map.getZoom(),e=this._getAllLayerToTransform();this._updateCanvasSize()||this._clearCanvas();var i=this._canvas.width,n=this._canvas.height;this._drawBackground();for(var r=0,o=e.length;o>r;r++)if(e[r].isVisible()&&e[r].isCanvasRender()){var s=e[r]._getRenderer();if(s&&s.getRenderZoom()===t){var a=this._getLayerImage(e[r]);a&&a.image&&this._drawLayerCanvasImage(e[r],a,i,n)}}this.map._fireEvent("renderend",{context:this._context})},onZoomStart:function(t,i){if(e.Browser.ielt9)return void i.call(this);var n=this.map;if(this._clearCanvas(),!n.options.zoomAnimation)return void i.call(this);var r=n.getBaseLayer(),o=this._getLayerImage(r);o&&this._storeBackground(o);var s,a=n.options.layerZoomAnimation?null:[r];1===t.startScale&&this._beforeTransform(),this._context&&this._context.save();var h=e.Animation.animate({scale:[t.startScale,t.endScale]},{easing:"out",speed:t.duration},e.Util.bind(function(r){s=this.getZoomMatrix(r.styles.scale,t.origin,e.Browser.retina),"finished"===h.playState?(this._afterTransform(s),this._context&&this._context.restore(),i.call(this)):"running"===h.playState&&(this.transform(s,a),n._fireEvent("zooming",{matrix:s}))},this)).play()},transform:function(t,i){var n=this._canvas.width,r=this._canvas.height,o=i||this._getAllLayerToTransform();this._clearCanvas();var s=!e.Browser.mobile&&this.map.options.layerTransforming;s||(this._context.save(),this._applyTransform(t));for(var a=0,h=o.length;h>a;a++)if(o[a].isVisible()){var l=o[a]._getRenderer();if(l){var u=!1;l.transform&&(u=l.transform(t)),s&&!u&&(this._context.save(),this._applyTransform(t));var c=this._getLayerImage(o[a]);c&&c.image&&this._drawLayerCanvasImage(o[a],c,n,r),s&&!u&&this._context.restore()}}s||this._context.restore()},updateMapSize:function(t){if(t&&!this._isCanvasContainer){var e=t.width,i=t.height,n=this.map._panels;n.mapWrapper.style.width=e+"px",n.mapWrapper.style.height=i+"px",n.mapPlatform.style.width=e+"px",n.mapPlatform.style.height=i+"px",n.canvasContainer.style.width=e+"px",n.canvasContainer.style.height=i+"px",n.control.style.width=e+"px",n.control.style.height=i+"px",this._updateCanvasSize()}},getPanel:function(){return this._isCanvasContainer?this.map._containerDOM:this.map._panels.mapWrapper},toDataURL:function(t){return this._canvas.toDataURL(t)},_getLayerImage:function(t){return t&&t._getRenderer()&&t._getRenderer().getCanvasImage?t._getRenderer().getCanvasImage():null},_beforeTransform:function(){var t=this.map;if(t.options.layerZoomAnimation)this.render();else{var e=t.getBaseLayer(),i=this._getLayerImage(e);if(i){var n=this._canvas.width,r=this._canvas.height;this._drawLayerCanvasImage(e,i,n,r)}}},_afterTransform:function(t){delete this._transMatrix,this._clearCanvas(),this._applyTransform(t),this._drawBackground()},_applyTransform:function(t){t=e.Browser.retina?t.retina:t.container,t.applyToContext(this._context)},_getCountOfGeosToDraw:function(){for(var t,i=this._getAllLayerToTransform(),n=0,r=i.length-1;r>=0;r--)i[r]instanceof e.VectorLayer&&i[r].isVisible()&&!i[r].isEmpty()&&(t=i[r]._getRenderer()._geosToDraw,t&&(n+=i[r]._getRenderer()._geosToDraw.length));return n},initContainer:function(){function t(t,n,r,o){var s=e.DomUtil.createEl("div",n);return r&&(s.style.cssText=r),i[t]=s,o||(s.onselectstart=function(){return!1},s.ondragstart=function(){return!1},s.setAttribute("unselectable","on")),s}var i=this.map._panels,n=this.map._containerDOM;if(!this._isCanvasContainer){n.innerHTML="";var r=t("control","maptalks-control",null,!0),o=t("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),s=t("mapPlatform","maptalks-platform","position:absolute;top:0px;left:0px;",!0),a=t("ui","maptalks-ui","position:absolute;top:0px;left:0px;border:none;",!0),h=t("layer","maptalks-layer","position:absolute;left:0px;top:0px;"),l=t("canvasContainer","maptalks-layer-canvas","position:absolute;top:0px;left:0px;border:none;");s.style.zIndex=300,l.style.zIndex=100,a.style.zIndex=300,r.style.zIndex=400,n.appendChild(o),s.appendChild(a),s.appendChild(l),s.appendChild(h),o.appendChild(s),o.appendChild(r),this.resetContainer();var u=this.map._getContainerDomSize();this.updateMapSize(u)}},_drawLayerCanvasImage:function(t,i,n,r){if(t&&i&&0!==n&&0!==r){var o=i.point.multi(e.Browser.retina?2:1),s=i.image;if(!(o.x+s.width<=0||o.y+s.height<=0)){var a=this._getCanvasContainerPos();if(a){var h=this.map.offsetPlatform().multi(-1)._substract(a);e.Browser.retina&&h._multi(2),o=o.add(h)}var l=t.options.opacity;if(e.Util.isNumber(l)||(l=1),!(0>=l)){var u=i.opacity;if(e.Util.isNumber(u)||(u=1),!(0>=u)){var c=this._context.globalAlpha;if(1>l&&(this._context.globalAlpha*=l),1>u&&(this._context.globalAlpha*=u),e.node){var d=s.getContext("2d");d.getSvg&&(s=d)}this._context.drawImage(s,e.Util.round(o.x),e.Util.round(o.y)),this._context.globalAlpha=c}}}}},_storeBackground:function(t){if(t){var i=this.map;this._canvasBg=e.DomUtil.copyCanvas(t.image),this._canvasBgRes=i._getResolution(),this._canvasBgCoord=i.containerPointToCoordinate(t.point)}},_drawBackground:function(){var t=this.map;if(this._canvasBg){var i=this._canvasBgRes/t._getResolution(),n=t.coordinateToContainerPoint(this._canvasBgCoord)._multi(e.Browser.retina?2:1);e.Canvas.image(this._context,this._canvasBg,n.x,n.y,this._canvasBg.width*i,this._canvasBg.height*i)}},_getAllLayerToTransform:function(){return this.map._getLayers()},_clearCanvas:function(){this._canvas&&e.Canvas.clearRect(this._context,0,0,this._canvas.width,this._canvas.height)},_updateCanvasSize:function(){if(!this._canvas||this._isCanvasContainer)return!1;var t=this.map,i=t.getSize(),n=this._canvas,r=e.Browser.retina?2:1;return i.width*r===n.width&&i.height*r===n.height?!1:(n.height=r*i.height,n.width=r*i.width,n.style&&(n.style.width=i.width+"px",n.style.height=i.height+"px"),!0)},_createCanvas:function(){this._isCanvasContainer?this._canvas=this.map._containerDOM:(this._canvas=e.DomUtil.createEl("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this._canvas)),this._context=this._canvas.getContext("2d")},_onResize:function(){delete this._canvasBg,this.map.checkSize()},_registerEvents:function(){var t=this.map;t.on("_baselayerchangestart",function(){delete this._canvasBg},this),t.on("_baselayerload",function(){var e=t.getBaseLayer();t.options.zoomBackground&&!e.getMask()||delete this._canvasBg},this),t.on("_zoomstart",function(){delete this._canvasBg,this._clearCanvas()},this),"undefined"!=typeof window&&e.DomUtil.on(window,"resize",this._onResize,this),!e.Browser.mobile&&e.Browser.canvas&&(this._onMapMouseMove=function(i){t._isBusy()||t._moving||!t.options.hitDetect||(this._hitDetectTimeout&&e.Util.cancelAnimFrame(this._hitDetectTimeout),this._hitDetectTimeout=e.Util.requestAnimFrame(function(){for(var e,n=i.viewPoint,r=t._getLayers(),o=!1,s=r.length-1;s>=0;s--){var a=r[s];if(a._getRenderer()&&a._getRenderer().hitDetect&&"default"!==a.options.cursor&&a._getRenderer().hitDetect(n)){e=a.options.cursor,o=!0;break}}o?t._trySetCursor(e):t._trySetCursor("default")}))},t.on("_mousemove",this._onMapMouseMove,this)),this._isCanvasContainer?t.on("_moving",function(){this.render()},this):t.on("_moveend",function(){this._resetCanvasContainer(),this.render()},this)}}),e.Map.registerRenderer("canvas",e.renderer.map.Canvas),e.TileLayer.TileCache=function(t){this._queue=[],this._cache={},t||(t=128),this.capacity=t},e.Util.extend(e.TileLayer.TileCache.prototype,{add:function(t,e){this._cache[t]=e,this._queue.push(t),this._expireCache()},get:function(t){return this._cache[t]},remove:function(t){delete this._cache[t]},_expireCache:function(){this._expTimeout&&clearTimeout(this._expTimeout);var t=this;this._expTimeout=setTimeout(function(){var e=t._queue.length;if(e>t.capacity)for(var i=t._queue.splice(0,e-t.capacity),n=i.length-1;n>=0;n--)delete t._cache[i[n]]},1e3)}}),e.renderer.tilelayer={},e.renderer.tilelayer.Canvas=e.renderer.Canvas.extend({propertyOfPointOnTile:"--maptalks-tile-point",propertyOfTileId:"--maptalks-tile-id",propertyOfTileZoom:"--maptalks-tile-zoom",initialize:function(t){this._layer=t,this._mapRender=t.getMap()._getRenderer(),this._tileCache=new e.TileLayer.TileCache,this._tileQueue={}},clear:function(){this._clearCanvas(),this._requestMapToRender()},clearExecutors:function(){clearTimeout(this._loadQueueTimeout)},draw:function(){var t=this._layer,i=t._getTiles();if(!i)return void this._complete();this._tileRended||(this._tileRended={});var n=this._tileRended;this._tileRended={};var r=i.tiles,o=this._tileCache,s=t.getTileSize();this._viewExtent=i.fullExtent,this._canvas||this._createCanvas(),this._resizeCanvas(i.fullExtent.getSize());var a=this._prepareCanvas();if(a&&!a.intersects(this._viewExtent))return void this._complete();this._totalTileToLoad=this._tileToLoadCounter=0;for(var h,l,u,c,d=r.length-1;d>=0;d--)h=r[d],l=r[d].id,u=n[l]||o.get(l),c=new e.PointExtent(h.viewPoint,h.viewPoint.add(s.toPoint())),this._viewExtent.intersects(c)&&(this._totalTileToLoad++,u?(this._drawTile(h.viewPoint,u),this._tileRended[l]=u):(this._tileToLoadCounter++,this._tileQueue[l+"@"+h.viewPoint.toString()]=h));0===this._tileToLoadCounter?this._complete():(this._tileToLoadCounter<this._totalTileToLoad&&this._requestMapToRender(),this._scheduleLoadTileQueue())},getCanvasImage:function(){if(this._renderZoom!==this.getMap().getZoom()||!this._canvas)return null;var t=null;this._gradualLoading&&this._totalTileToLoad&&this._layer.options.gradualLoading&&(t=(this._totalTileToLoad-this._tileToLoadCounter)/this._totalTileToLoad*1.5,t>1&&(t=1));var e=this._viewExtent.getSize(),i=this._viewExtent.getMin();return{image:this._canvas,layer:this._layer,point:this.getMap().viewPointToContainerPoint(i),size:e,opacity:t}},_scheduleLoadTileQueue:function(){this._loadQueueTimeout&&e.Util.cancelAnimFrame(this._loadQueueTimeout);var t=this;this._loadQueueTimeout=e.Util.requestAnimFrame(function(){t._loadTileQueue()})},_loadTileQueue:function(){function t(){e.node||(o._tileCache.add(this[o.propertyOfTileId],this),o._tileRended[this[o.propertyOfTileId]]=this),o._drawTileAndRequest(this)}function i(){o._clearTileRectAndRequest(this)}var n,r,o=this;for(var s in this._tileQueue)this._tileQueue.hasOwnProperty(s)&&(n=s.split("@")[0],r=this._tileQueue[s],delete this._tileQueue[s],this._tileCache[n]?this._drawTileAndRequest(this._tileCache[n]):this._loadTile(n,r,t,i))},_loadTile:function(t,i,n,r){var o=this._layer.options.crossOrigin,s=this._layer.getTileSize(),a=new Image;a.width=s.width,a.height=s.height,a[this.propertyOfTileId]=t,a[this.propertyOfPointOnTile]=i.viewPoint,a[this.propertyOfTileZoom]=i.zoom,a.onload=n,a.onabort=r,a.onerror=r,o&&(a.crossOrigin=o),e.Util.loadImage(a,[i.url])},_drawTile:function(t,i){if(t){var n=this._layer.getTileSize(),r=this._viewExtent.getMin();if(e.Canvas.image(this._context,i,t.x-r.x,t.y-r.y,n.width,n.height),this._layer.options.debug){var o=t.substract(r);this._context.save(),this._context.strokeStyle="rgb(0,0,0)",this._context.fillStyle="rgb(0,0,0)",this._context.strokeWidth=10,this._context.font="15px monospace",e.Canvas.rectangle(this._context,o,n,1,0);var s=i[this.propertyOfTileId].split("__");e.Canvas.fillText(this._context,"x:"+s[1]+",y:"+s[0]+",z:"+s[2],o.add(10,20),"rgb(0,0,0)"),this._context.restore()}i=null}},_drawTileAndRequest:function(t){if(this.getMap()){var i=this.getMap().getZoom();if(i===t[this.propertyOfTileZoom]){this._tileToLoadCounter--;var n=t[this.propertyOfPointOnTile];if(this._drawTile(n,t),!e.node){var r=this._layer.getTileSize(),o=this.getMap()._getViewExtent();o.intersects(new e.PointExtent(n,n.add(r.width,r.height)))&&this._requestMapToRender()}0===this._tileToLoadCounter&&this._onTileLoadComplete()}}},_onTileLoadComplete:function(){e.node&&this._requestMapToRender(),this._fireLoadedEvent()},_clearTileRectAndRequest:function(t){if(this.getMap()){var i=this.getMap().getZoom();i===t[this.propertyOfTileZoom]&&(e.node||this._requestMapToRender(),this._tileToLoadCounter--,0===this._tileToLoadCounter&&this._onTileLoadComplete())}},_requestMapToRender:function(){if(e.node)return void(this.getMap()&&!this.getMap()._isBusy()&&this._mapRender.render());this._mapRenderRequest&&e.Util.cancelAnimFrame(this._mapRenderRequest);var t=this;this._mapRenderRequest=e.Util.requestAnimFrame(function(){t.getMap()&&!t.getMap()._isBusy()&&t._mapRender.render()})},_onMoveEnd:function(){this._gradualLoading=!1,this.render()},_onZoomEnd:function(){this._gradualLoading=!0,this.render()},_onResize:function(){this._resizeCanvas(),this.render()},_onRemove:function(){delete this._tileCache,delete this._tileQueue,delete this._mapRender}}),e.TileLayer.registerRenderer("canvas",e.renderer.tilelayer.Canvas),e.renderer.tilelayer.Dom=e.Class.extend({initialize:function(t){this._layer=t,this._tiles={},this._fadeAnimated=!0},getMap:function(){return this._layer.getMap()},show:function(){this._container&&(this.render(),this._container.style.display="")},hide:function(){this._container&&(this._container.style.display="none",this.clear())},remove:function(){this._removeLayerContainer()},clear:function(){this._removeAllTiles(),this._clearLayerContainer()},setZIndex:function(t){this._zIndex=t,this._container&&(this._container.style.zIndex=t)},isCanvasRender:function(){return!1},render:function(){var t=this._layer;this._container||this._createLayerContainer();var e=t._getTiles();if(e){var i=e.tiles,n=[];if(this._tiles)for(var r in this._tiles)this._tiles[r].current=!1;for(var o,s=i.length-1;s>=0;s--)o=i[s],this._tiles[o.id]?this._tiles[o.id].current=!0:(o.current=!0,n.push(o));if(n.length>0){var a=document.createDocumentFragment();for(s=0;s<n.length;s++)a.appendChild(this._loadTile(n[s]));this._getTileContainer().appendChild(a)}}},transform:function(t){if(!this._canTransform())return!1;var i=this.getMap().getZoom();return this._levelContainers[i]&&e.DomUtil.setTransform(this._levelContainers[i],t.view),!1},_loadTile:function(t){return this._tiles[t.id]=t,this._createTile(t,e.Util.bind(this._tileReady,this))},_createTile:function(t,i){var n=this._layer.getTileSize(),r=e.DomUtil.createEl("img");return t.el=r,e.DomUtil.on(r,"load",e.Util.bind(this._tileOnLoad,this,i,t)),e.DomUtil.on(r,"error",e.Util.bind(this._tileOnError,this,i,t)),this._layer.options.crossOrigin&&(t.crossOrigin=this._layer.options.crossOrigin),r.style.position="absolute",r.style.left=Math.floor(t.viewPoint.x)+"px",r.style.top=Math.floor(t.viewPoint.y)+"px",r.alt="",r.width=n.width,r.height=n.height,e.DomUtil.setOpacity(r,0),r.src=t.url,r},_tileReady:function(t,i){if(t&&this._layer.fire("tileerror",{error:t,tile:i}),i.loaded=e.Util.now(),this._fadeAnimated?(e.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=e.Util.requestAnimFrame(e.Util.bind(this._updateOpacity,this))):(e.DomUtil.setOpacity(i.el,1),i.active=!0,this._pruneTiles()),this._layer.fire("tileload",{tile:i}),this._noTilesToLoad())if(this._layer.fire("layerload"),e.Browser.ielt9)e.Util.requestAnimFrame(this._pruneTiles,this);else{this._pruneTimeout&&clearTimeout(this._pruneTimeout);var n=this.getMap()?this.getMap().options.zoomAnimationDuration:250,r=this.getMap()?!this.getMap().options.zoomBackground:!0;this._pruneTimeout=setTimeout(e.Util.bind(this._pruneTiles,this,r),n+100)}},_tileOnLoad:function(t,i){e.Browser.ielt9?setTimeout(e.Util.bind(t,this,null,i),0):t.call(this,null,i)},_tileOnError:function(t,e){var i=this._layer.options.errorTileUrl;i?e.el.src=i:e.el.style.display="none",t.call(this,"error",e)},_updateOpacity:function(){if(this.getMap()&&!e.Browser.ielt9){e.DomUtil.setOpacity(this._container,this._layer.options.opacity);var t,i,n=e.Util.now(),r=!1;for(var o in this._tiles)t=this._tiles[o],t.current&&t.loaded&&(i=Math.min(1,(n-t.loaded)/200),e.DomUtil.setOpacity(t.el,i),!r&&1>i&&(r=!0));r&&(e.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=e.Util.requestAnimFrame(e.Util.bind(this._updateOpacity,this)))}},_noTilesToLoad:function(){for(var t in this._tiles)if(!this._tiles[t].loaded)return!1;return!0},_pruneTiles:function(t){var i=this.getMap();if(i){var n,r=i.getZoom();if(!this._layer.isVisible())return void this._removeAllTiles();for(n in this._tiles)this._tiles[n].zoom!==r||this._tiles[n].current||this._removeTile(n);if(t){for(n in this._tiles)this._tiles[n].zoom!==r&&this._removeTile(n);for(var o in this._levelContainers)+o!==r&&(e.DomUtil.removeDomNode(this._levelContainers[o]),this._removeTilesAtZoom(o),delete this._levelContainers[o])}}},_removeTile:function(t){var i=this._tiles[t];i&&(e.DomUtil.removeDomNode(i.el),delete this._tiles[t],this._layer.fire("tileunload",{tile:i}))},_removeTilesAtZoom:function(t){for(var e in this._tiles)+this._tiles[e].zoom===+t&&this._removeTile(e)},_removeAllTiles:function(){for(var t in this._tiles)this._removeTile(t)},_getTileContainer:function(){this._levelContainers||(this._levelContainers={});var t=this.getMap().getZoom();if(!this._levelContainers[t]){var i=this._levelContainers[t]=e.DomUtil.createEl("div","maptalks-tilelayer-level");i.style.cssText="position:absolute;left:0px;top:0px;",i.style.willChange="transform",this._container.appendChild(i)}return this._levelContainers[t]},_createLayerContainer:function(){var t=this._container=e.DomUtil.createEl("div","maptalks-tilelayer");t.style.cssText="position:absolute;left:0px;top:0px;",this._zIndex&&(t.style.zIndex=this._zIndex),this.getMap()._panels.layer.appendChild(t)},_clearLayerContainer:function(){this._container&&(this._container.innerHTML=""),delete this._levelContainers},_removeLayerContainer:function(){this._container&&e.DomUtil.removeDomNode(this._container),delete this._levelContainers},_getEvents:function(){var t={_zoomstart:this._onZoomStart,_zoomend:this._onZoomEnd,"_moveend _resize":this.render,_movestart:this._onMoveStart};if(!this._onMapMoving&&this._layer.options.renderWhenPanning){var i=this._layer.options.renderSpanWhenPanning;e.Util.isNumber(i)&&i>=0&&(i>0?this._onMapMoving=e.Util.throttle(function(){this.render()},i,this):this._onMapMoving=function(){this.render()})}return this._onMapMoving&&(t._moving=this._onMapMoving),t},_canTransform:function(){return e.Browser.any3d||e.Browser.ie9},_onMoveStart:function(){},_onZoomStart:function(){this._fadeAnimated=!0,this._pruneTiles(!0),this._zoomStartPos=this.getMap().offsetPlatform(),this._canTransform()||(this._container.style.display="none")},_onZoomEnd:function(t){this._pruneTimeout&&clearTimeout(this._pruneTimeout),this.render(),this._levelContainers&&(this._canTransform()?this._levelContainers[t.from]&&this._zoomStartPos&&(this._levelContainers[t.from].style.left=this._zoomStartPos.x+"px",this._levelContainers[t.from].style.top=this._zoomStartPos.y+"px"):(this._levelContainers[t.from]&&(this._levelContainers[t.from].style.display="none"),this._container.style.display=""))}}),e.TileLayer.registerRenderer("dom",e.renderer.tilelayer.Dom),e.renderer.canvastilelayer={},e.renderer.canvastilelayer.Canvas=e.renderer.tilelayer.Canvas.extend({_loadTile:function(t,i,n,r){var o=this._layer.getTileSize(),s=this._canvas.constructor,a=this.getMap(),h=e.Browser.retina?2:1,l=e.Canvas.createCanvas(o.width*h,o.height*h,s);l[this.propertyOfTileId]=t,l[this.propertyOfPointOnTile]=i.viewPoint,l[this.propertyOfTileZoom]=i.zoom,this._layer.drawTile(l,{url:i.url,viewPoint:i.viewPoint,zoom:i.zoom,extent:a.viewToExtent(new e.PointExtent(i.viewPoint,i.viewPoint.add(o.toPoint())))},function(t){return t?void r.call(l):void n.call(l)})}}),e.CanvasTileLayer.registerRenderer("canvas",e.renderer.canvastilelayer.Canvas),e.renderer.vectorlayer={},e.renderer.vectorlayer.Canvas=e.renderer.Canvas.extend({initialize:function(t){this._layer=t,this._painted=!1},draw:function(){var t=this;return this._clearTimeout(),this._layer.isEmpty()?void this._complete():void(this._layer.options.drawImmediate?this._drawImmediate():this._renderTimeout=e.Util.requestAnimFrame(function(){t._drawImmediate()}))},transform:function(t){return e.Browser.mobile||!this.getMap().options.layerTransforming||this._layer.options.drawOnce||this._layer.getMask()?!1:!this._hasPointSymbolizer||this.getMap()._getRenderer()._getCountOfGeosToDraw()>this._layer.options.thresholdOfTransforming?!1:(this._drawGeos(t),!0)},checkResources:function(t){function i(t){if(n=t._getExternalResources(),e.Util.isArrayHasData(n))if(o._resources)for(r=0;r<n.length;r++)o._resources.isResourceLoaded(n[r])||s.push(n[r]);else s=s.concat(n)}if(this._painted||t||(t=this._layer._geoCache),!t)return null;var n,r,o=this,s=[];if(e.Util.isArrayHasData(t))for(var a=t.length-1;a>=0;a--)i(t[a]);else for(var h in t)t.hasOwnProperty(h)&&i(t[h]);return s},isBlank:function(){return this._isBlank},show:function(){this._layer.forEach(function(t){t._onZoomEnd()}),e.renderer.Canvas.prototype.show.apply(this,arguments)},_drawGeos:function(t){var i=this.getMap();if(i){var n=this._layer;if(n.isEmpty())return this._resources=new e.renderer.Canvas.Resources,void this._fireLoadedEvent();if(!n.isVisible())return void this._fireLoadedEvent();this._prepareToDraw();var r=this._viewExtent,o=this._prepareCanvas();if(o){if(!o.intersects(r))return void this._fireLoadedEvent();r=r.intersection(o)}this._displayExtent=r,this._forEachGeo(this._checkGeo,this);for(var s=0,a=this._geosToDraw.length;a>s;s++)this._geosToDraw[s]._getPainter().paint(t)}},_prepareToDraw:function(){this._isBlank=!0,this._painted=!0,this._hasPointSymbolizer=!1,this._geosToDraw=[]},_checkGeo:function(t){if(t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),i=e.getViewExtent();i&&i.intersects(this._displayExtent)&&(this._isBlank=!1,e.hasPointSymbolizer()&&(this._hasPointSymbolizer=!0),this._geosToDraw.push(t))}},_forEachGeo:function(t,e){this._layer.forEach(t,e)},_drawImmediate:function(){if(this._clearTimeout(),this.getMap()){var t=this.getMap();if(!this._layer.isVisible()||this._layer.isEmpty())return this._clearCanvas(),void this._complete();var e=this.getMap().getZoom();if(this._layer.options.drawOnce){if(this._canvasCache||(this._canvasCache={}),this._viewExtent)return void this._complete();if(this._canvasCache[e]){this._canvas=this._canvasCache[e].canvas;var i=t._prjToPoint(t._getPrjCenter());return this._viewExtent=this._canvasCache[e].viewExtent.add(this._canvasCache[e].center.substract(i)),void this._complete()}delete this._canvas}this._drawGeos(),this._layer.options.drawOnce&&(this._canvasCache[e]||(this._canvasCache[e]={canvas:this._canvas,viewExtent:this._viewExtent,center:t._prjToPoint(t._getPrjCenter())})),this._complete()}},_onZoomEnd:function(){delete this._viewExtent,this._layer.isVisible()&&this._layer.forEach(function(t){t._onZoomEnd()}),this._painted?(this._prepareRender(),this._drawImmediate()):this.render()},_onMoveEnd:function(){this._painted?(this._prepareRender(),this._drawImmediate()):this.render()},_onResize:function(){this._resizeCanvas(),this._painted?(delete this._canvasCache,delete this._viewExtent,this._prepareRender(),this._drawImmediate()):this.render()},_onRemove:function(){delete this._canvasCache},_clearTimeout:function(){
this._renderTimeout&&e.Util.cancelAnimFrame(this._renderTimeout)}}),e.VectorLayer.registerRenderer("canvas",e.renderer.vectorlayer.Canvas),e.GeoJSONLayer&&e.GeoJSONLayer.registerRenderer("canvas",e.renderer.vectorlayer.Canvas),e.symbolizer={},e.Symbolizer=e.Class.extend({getMap:function(){return this.geometry.getMap()}}),e.Symbolizer.resourceProperties=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],e.Symbolizer.resourceSizeProperties=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],e.Symbolizer.colorProperties=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],e.Symbolizer.DEFAULT_STROKE_COLOR="#000",e.Symbolizer.DEFAULT_FILL_COLOR="rgba(255,255,255,0)",e.Symbolizer.DEFAULT_TEXT_COLOR="#000",e.Symbolizer.testColor=function(t){return t&&e.Util.isString(t)?e.Util.indexOfArray(t,e.Symbolizer.colorProperties)>=0:!1},e.symbolizer.CanvasSymbolizer=e.Symbolizer.extend({_prepareContext:function(t){if(!(this instanceof e.symbolizer.VectorPathMarkerSymbolizer)){var i=this.symbol;e.Util.isNumber(i.opacity)?t.globalAlpha!==i.opacity&&(t.globalAlpha=i.opacity):1!==t.globalAlpha&&(t.globalAlpha=1)}var n=this.geometry.options.shadowBlur;e.Util.isNumber(n)&&n>0?(t.shadowBlur=n,t.shadowColor=this.geometry.options.shadowColor):(t.shadowBlur=null,t.shadowColor=null)},refresh:function(){},remove:function(){},setZIndex:function(){},show:function(){},hide:function(){},_defineStyle:function(t){var i=this,n=function(){return[i.getMap().getZoom(),i.geometry.getProperties()]};return e.Util.loadFunctionTypes(t,n)}}),e.symbolizer.StrokeAndFillSymbolizer=e.symbolizer.CanvasSymbolizer.extend({defaultSymbol:{lineColor:"#000000",lineWidth:1,lineOpacity:1,lineDasharray:[],lineCap:"butt",lineJoin:"round",polygonFill:null,polygonOpacity:0},initialize:function(t,e){this.symbol=t,this.geometry=e,this.style=this._defineStyle(this.translate())},symbolize:function(t,i){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity){var r=this._getRenderResources();this._prepareContext(t),e.Util.isGradient(n.lineColor)&&(n.lineGradientExtent=this.geometry._getPainter().getContainerExtent()._expand(n.lineWidth)._round()),e.Util.isGradient(n.polygonFill)&&(n.polygonGradientExtent=this.geometry._getPainter().getContainerExtent()._round()),e.Canvas.prepareCanvas(t,n,i),r.fn.apply(this,[t].concat(r.context).concat([n.lineOpacity,n.polygonOpacity,n.lineDasharray])),t.setLineDash&&e.Util.isArrayHasData(n.lineDasharray)&&t.setLineDash([])}},getViewExtent:function(){var t=this.getMap(),i=this.geometry._getPrjExtent();if(!i)return null;this._extMin&&this._extMax||(this._extMin=new e.Coordinate(0,0),this._extMax=new e.Coordinate(0,0)),this._extMin.x=i.xmin,this._extMin.y=i.ymin,this._extMax.x=i.xmax,this._extMax.y=i.ymax;var n=t._prjToViewPoint(this._extMin),r=t._prjToViewPoint(this._extMax);return this._pxExtent?(n.x<r.x?(this._pxExtent.xmin=n.x,this._pxExtent.xmax=r.x):(this._pxExtent.xmax=n.x,this._pxExtent.xmin=r.x),n.y<r.y?(this._pxExtent.ymin=n.y,this._pxExtent.ymax=r.y):(this._pxExtent.ymax=n.y,this._pxExtent.ymin=r.y)):this._pxExtent=new e.PointExtent(n,r),this._pxExtent._expand(this.style.lineWidth/2)},_getRenderResources:function(){return this.geometry._getPainter()._getRenderResources()},translate:function(){var t=this.symbol,i=this.defaultSymbol,n={};return e.Util.extend(n,i,t),0===n.lineWidth&&(n.lineOpacity=0),n}}),e.symbolizer.StrokeAndFillSymbolizer.test=function(t){if(!t)return!1;for(var e in t)if(e.indexOf("polygon")>=0||e.indexOf("line")>=0)return!0;return!1},e.symbolizer.PointSymbolizer=e.symbolizer.CanvasSymbolizer.extend({getViewExtent:function(){for(var t=new e.PointExtent,i=this.getMarkerExtent(),n=i.getMin(),r=i.getMax(),o=this._getRenderPoints()[0],s=o.length-1;s>=0;s--){var a=o[s];t=t.combine(new e.PointExtent(a.add(n),a.add(r)))}return t},_getRenderPoints:function(){return this.geometry._getPainter()._getRenderPoints(this.getPlacement())},_getRenderContainerPoints:function(){var t=this._getRenderPoints()[0],i=this.geometry._getPainter().getTransformMatrix(),n=i?i.container:null,r=i?i.scale:null,o=this.getDxDy(),s=this.geometry.getLayer()._getRenderer()._viewExtent.getMin();n&&(o=new e.Point(o.x/r.x,o.y/r.y));var a=e.Util.mapArrayRecursively(t,function(t){return t.substract(s)._add(o)});return n?n.applyToArray(a):a},_getRotations:function(){return this._getRenderPoints()[1]}}),e.symbolizer.ImageMarkerSymbolizer=e.symbolizer.PointSymbolizer.extend({initialize:function(t,e){this.symbol=t,this.geometry=e,this.style=this._defineStyle(this.translate())},symbolize:function(t,i){var n=this.style;if(0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var r=this._getRenderContainerPoints();if(e.Util.isArrayHasData(r)){var o=this._getImage(i);if(!o)return void(e.Browser.phantomjs||console.warn("no img found for "+(this.style.markerFile||this._url[0])));this._prepareContext(t);var s=n.markerWidth,a=n.markerHeight;if(!e.Util.isNumber(s)||!e.Util.isNumber(a)){s=o.width,a=o.height,n.markerWidth=s,n.markerHeight=a;var h=[n.markerFile,n.markerWidth,n.markerHeight];i.isResourceLoaded(h)||i.addResource(h,o),this.geometry._getPainter()._removeCache()}var l;!(this instanceof e.symbolizer.VectorPathMarkerSymbolizer)&&e.Util.isNumber(n.markerOpacity)&&n.markerOpacity<1&&(l=t.globalAlpha,t.globalAlpha*=n.markerOpacity);for(var u=0,c=r.length;c>u;u++)e.Canvas.image(t,o,r[u].x-s/2,r[u].y-a,s,a);void 0!==l&&(t.globalAlpha=l)}}},_getImage:function(t){var e=t?t.getImage([this.style.markerFile,this.style.markerWidth,this.style.markerHeight]):null;return e},getPlacement:function(){return this.symbol.markerPlacement},getDxDy:function(){var t=this.style,i=t.markerDx,n=t.markerDy;return new e.Point(i,n)},getMarkerExtent:function(){var t=this.style.markerWidth,i=this.style.markerHeight,n=this.getDxDy(),r=new e.PointExtent(n.add(-t/2,0),n.add(t/2,-i));return r},translate:function(){var t=this.symbol;return{markerFile:t.markerFile,markerWidth:e.Util.getValueOrDefault(t.markerWidth,null),markerHeight:e.Util.getValueOrDefault(t.markerHeight,null),markerOpacity:e.Util.getValueOrDefault(t.markerOpacity,1),markerDx:e.Util.getValueOrDefault(t.markerDx,0),markerDy:e.Util.getValueOrDefault(t.markerDy,0)}}}),e.symbolizer.ImageMarkerSymbolizer.test=function(t){return t?!e.Util.isNil(t.markerFile):!1},e.symbolizer.VectorMarkerSymbolizer=e.symbolizer.PointSymbolizer.extend({defaultSymbol:{markerType:"ellipse",markerFill:"#0000ff",markerFillOpacity:1,markerLineColor:"#000000",markerLineWidth:1,markerLineOpacity:1,markerLineDasharray:[],markerWidth:10,markerHeight:10,markerDx:0,markerDy:0},initialize:function(t,e){this.symbol=t,this.geometry=e;var i=this.translate();this.style=this._defineStyle(i),this.strokeAndFill=this._defineStyle(this.translateLineAndFill(i))},symbolize:function(t,i){var n=this.style;if(0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var r=this._getRenderContainerPoints();if(e.Util.isArrayHasData(r)){var o=this.strokeAndFill;this._prepareContext(t),e.Util.isGradient(o.lineColor)&&(o.lineGradientExtent=this.geometry._getPainter().getContainerExtent()._expand(o.lineWidth)._round()),e.Util.isGradient(o.polygonFill)&&(o.polygonGradientExtent=this.geometry._getPainter().getContainerExtent()._round()),e.Canvas.prepareCanvas(t,o,i),this._drawMarkers(t,r)}}},_drawMarkers:function(t,i){for(var n,r,o,s,a=this.style,h=this.strokeAndFill,l=a.markerType.toLowerCase(),u=e.symbolizer.VectorMarkerSymbolizer._getVectorPoints(l,a.markerWidth,a.markerHeight),c=h.lineOpacity,d=h.polygonOpacity,f=a.markerWidth,m=a.markerHeight,_=i.length-1;_>=0;_--)if(r=i[_],"ellipse"===l||"circle"===l)e.Canvas.ellipse(t,r,f/2,m/2,c,d);else if("cross"===l||"x"===l){for(n=u.length-1;n>=0;n--)u[n]._add(r);e.Canvas.path(t,u.slice(0,2),c),e.Canvas.path(t,u.slice(2,4),c)}else if("diamond"===l||"bar"===l||"square"===l||"triangle"===l){for("bar"===l&&(r=r.add(0,-a.markerLineWidth/2)),n=u.length-1;n>=0;n--)u[n]._add(r);e.Canvas.polygon(t,u,c,d)}else if("pin"===l){for(r=r.add(0,-a.markerLineWidth/2),n=u.length-1;n>=0;n--)u[n]._add(r);o=t.lineCap,t.lineCap="round",e.Canvas.bezierCurveAndFill(t,u,c,d),t.lineCap=o}else{if("pie"!==l)throw new Error("unsupported markerType: "+l);r=r.add(0,-a.markerLineWidth/2),s=180*Math.atan(f/2/m)/Math.PI,o=t.lineCap,t.lineCap="round",e.Canvas.sector(t,r,m,[90-s,90+s],c,d),t.lineCap=o}},getPlacement:function(){return this.symbol.markerPlacement},getDxDy:function(){var t=this.style,i=t.markerDx,n=t.markerDy;return new e.Point(i,n)},getMarkerExtent:function(){var t,i=this.getDxDy(),n=this.style,r=n.markerType.toLowerCase(),o=n.markerWidth,s=n.markerHeight;return t="bar"===r||"pie"===r||"pin"===r?new e.PointExtent(i.add(-o/2,-s),i.add(o/2,0)):new e.PointExtent(i.add(-o/2,-s/2),i.add(o/2,s/2)),this.style.markerLineWidth&&(t=t.expand(this.style.markerLineWidth/2)),t},translate:function(){var t=this.symbol,i=this.defaultSymbol,n=e.Util.extend({},i,t);return e.Util.isNumber(t.markerOpacity)&&(n.markerFillOpacity*=t.markerOpacity,n.markerLineOpacity*=t.markerOpacity),n},translateLineAndFill:function(t){var e={lineColor:t.markerLineColor||t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill||t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}}),e.symbolizer.VectorMarkerSymbolizer.test=function(t){return t?!(!e.Util.isNil(t.markerFile)||e.Util.isNil(t.markerType)||"path"===t.markerType):!1},e.symbolizer.VectorMarkerSymbolizer.translateToSVGStyles=function(t){var i={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return"butt"===i.stroke["stroke-linecap"]&&e.Browser.vml&&(i.stroke["stroke-linecap"]="flat"),0===i.stroke["stroke-width"]&&(i.stroke["stroke-opacity"]=0),i},e.symbolizer.VectorMarkerSymbolizer._getVectorPoints=function(t,i,n){var r,o,s,a,h=Math.round(n/2),l=Math.round(i/2),u=0,c=0;if("triangle"===t)return r=new e.Point(u,c-h),o=new e.Point(u-l,c+h),s=new e.Point(u+l,c+h),[r,o,s];if("cross"===t)return r=new e.Point(u-l,c),o=new e.Point(u+l,c),s=new e.Point(u,c-h),a=new e.Point(u,c+h),[r,o,s,a];if("diamond"===t)return r=new e.Point(u-l,c),o=new e.Point(u,c-h),s=new e.Point(u+l,c),a=new e.Point(u,c+h),[r,o,s,a];if("square"===t)return r=new e.Point(u-l,c+h),o=new e.Point(u+l,c+h),s=new e.Point(u+l,c-h),a=new e.Point(u-l,c-h),[r,o,s,a];if("x"===t)return r=new e.Point(u-l,c+h),o=new e.Point(u+l,c-h),s=new e.Point(u+l,c+h),a=new e.Point(u-l,c-h),[r,o,s,a];if("bar"===t)return r=new e.Point(u-l,c-n),o=new e.Point(u+l,c-n),s=new e.Point(u+l,c),a=new e.Point(u-l,c),[r,o,s,a];if("pin"===t){var d=n*Math.atan(l/h);return r=new e.Point(u,c),o=new e.Point(u-d,c-n),s=new e.Point(u+d,c-n),a=new e.Point(u,c),[r,o,s,a]}return null},e.symbolizer.VectorPathMarkerSymbolizer=e.symbolizer.ImageMarkerSymbolizer.extend({initialize:function(t,i){this.symbol=t,this.geometry=i,this._url=[e.Geometry._getMarkerPathURL(t),t.markerWidth,t.markerHeight],this.style=this._defineStyle(this.translate()),e.Util.isNil(this.style.markerWidth)&&(this.style.markerWidth=80),e.Util.isNil(this.style.markerHeight)&&(this.style.markerHeight=80)},_getImage:function(t){return t?t.getImage(this._url):null}}),e.symbolizer.VectorPathMarkerSymbolizer.test=function(t){return t?!(!e.Util.isNil(t.markerFile)||"path"!==t.markerType):!1},e.symbolizer.TextMarkerSymbolizer=e.symbolizer.PointSymbolizer.extend({defaultSymbol:{textFaceName:"monospace",textSize:10,textFont:null,textFill:"#000",textOpacity:1,textHaloFill:"#ffffff",textHaloRadius:0,textWrapWidth:null,textWrapBefore:!1,textWrapCharacter:null,textLineSpacing:0,textDx:0,textDy:0,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textAlign:"center"},initialize:function(t,i){this.symbol=t,this.geometry=i;var n=this.translate();this.style=this._defineStyle(n),this.strokeAndFill=this._defineStyle(this.translateLineAndFill(n));var r=e.StringUtil.replaceVariable(this.style.textName,this.geometry.getProperties());this._descText(r)},symbolize:function(t,i){if(0!==this.style.textSize&&0!==this.style.textOpacity){var n=this._getRenderContainerPoints();if(e.Util.isArrayHasData(n)){var r=this._getRotations(),o=this.style,s=this.strokeAndFill,a=e.StringUtil.replaceVariable(this.style.textName,this.geometry.getProperties());this._descText(a),this._prepareContext(t),e.Canvas.prepareCanvas(t,s,i),e.Canvas.prepareCanvasFont(t,o);for(var h,l=0,u=n.length;u>l;l++)h=n[l],r&&!e.Util.isNil(r[l])&&(t.save(),t.translate(h.x,h.y),t.rotate(r[l]),h=new e.Point(0,0)),e.Canvas.text(t,a,h,o,this.textDesc),r&&!e.Util.isNil(r[l])&&t.restore()}}},getPlacement:function(){return this.symbol.textPlacement},getDxDy:function(){var t=this.style,i=t.textDx,n=t.textDy;return new e.Point(i,n)},getMarkerExtent:function(){var t=this.getDxDy(),i=this.style,n=this.textDesc.size,r=e.StringUtil.getAlignPoint(n,i.textHorizontalAlignment,i.textVerticalAlignment),o=r.x,s=r.y;return new e.PointExtent(t.add(o,s),t.add(o+n.width,s+n.height))},translate:function(){var t=this.symbol,i=this.defaultSymbol,n=e.Util.extend({},i,t);return n.textName=t.textName,n},translateLineAndFill:function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},_descText:function(t){this.textDesc=this._loadFromCache(t,this.style),this.textDesc||(this.textDesc=e.StringUtil.splitTextToRow(t,this.style),this._storeToCache(t,this.style,this.textDesc))},_storeToCache:function(t,i,n){e.node||(this.geometry.___text_symbol_cache||(this.geometry.___text_symbol_cache={}),this.geometry.___text_symbol_cache[this._genCacheKey(i)]=n)},_loadFromCache:function(t,e){return this.geometry.___text_symbol_cache?this.geometry.___text_symbol_cache[this._genCacheKey(t,e)]:null},_genCacheKey:function(t,e){var i=[t];for(var n in e)e.hasOwnProperty(n)&&n.length>4&&"text"===n.substring(0,4)&&i.push(n+"="+e[n]);return i.join("-")}}),e.symbolizer.TextMarkerSymbolizer.test=function(t){return t?!e.Util.isNil(t.textName):!1},e.symbolizer.TextMarkerSymbolizer.getFont=function(t){return t.textFont?t.textFont:t.textSize+"px "+('"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"')},e.symbolizer.DebugSymbolizer=e.symbolizer.PointSymbolizer.extend({styles:{lineColor:"#000",lineOpacity:1,lineWidth:1},initialize:function(t,e){this.symbol=t,this.geometry=e},getPlacement:function(){return"center"},getDxDy:function(){return new e.Point(0,0)},symbolize:function(t){var i=this.geometry,n=i.getLayer();if(i.options.debug||n.options.debug){var r=this.getMap();if(!r._zooming){e.Canvas.prepareCanvas(t,this.styles);var o=this.styles.lineOpacity,s=i._getPainter().getViewExtent(),a=s.getSize(),h=r.viewPointToContainerPoint(s.getMin());e.Canvas.rectangle(t,h,a,o,0);for(var l=this._getRenderContainerPoints(),u=this.geometry.getId(),c=e.symbolizer.VectorMarkerSymbolizer._getVectorPoints("cross",10,10),d=0;d<l.length;d++){var f=l[d];e.Util.isNil(u)||e.Canvas.fillText(t,u,f.add(8,-4),"rgba(0,0,0,1)");for(var m=[],_=0;_<c.length;_++)m.push(c[_].add(f));e.Canvas.path(t,m.slice(0,2),o),e.Canvas.path(t,m.slice(2,4),o)}}}}});var n={};if(n.Center={_getRenderPoints:function(){return[[this._getCenterViewPoint()],null]}},e.Marker.include(n.Center),e.Ellipse.include(n.Center,{_getRenderSize:function(){var t=this.getWidth(),e=this.getHeight(),i=this.getMap();return i.distanceToPixel(t/2,e/2)}}),e.Circle.include(n.Center,{_getRenderSize:function(){var t=this.getRadius(),e=this.getMap();return e.distanceToPixel(t,t)}}),e.Sector.include(n.Center,{_getRenderSize:function(){var t=this.getRadius(),e=this.getMap();return e.distanceToPixel(t,t)}}),e.Rectangle.include({_getRenderPoints:function(t){if("point"===t){for(var e=this.getShell(),i=[],n=0,r=e.length;r>n;n++)i.push(this.getMap().coordinateToViewPoint(e[n]));return[i,null]}var o=this.getMap()._prjToViewPoint(this._getPrjCoordinates());return[[o],null]},_getRenderSize:function(){var t=this.getWidth(),e=this.getHeight(),i=this.getMap();return i.distanceToPixel(t,e)}}),n.Poly={_getRenderPoints:function(t){var i,n=this.getMap(),r=null;if("point"===t)i=this._prjToViewPoint(this._getPrjCoordinates());else if("line"===t){i=[],r=[];var o=this._prjToViewPoint(this._getPrjCoordinates());this instanceof e.Polygon&&o.length>0&&!o[0].equals(o[o.length-1])&&o.push(o[0]);for(var s=1,a=o.length;a>s;s++)i.push(o[s].add(o[s-1])._multi(.5)),r.push(e.Util.computeDegree(o[s-1],o[s]))}else{var h=this.getCenter(),l=this._getProjection().project(h);i=[n._prjToViewPoint(l)]}return[i,r]}},e.Polyline.include(n.Poly),e.Polygon.include(n.Poly),e.Browser.canvas){var r={_getRenderCanvasResources:function(){var t=this.getMap(),i=this._getPrjCoordinates(),n=t._prjToViewPoint(i),r=this._getRenderSize();return{fn:e.Canvas.ellipse,context:[n,r.width,r.height]}}};e.Ellipse.include(r),e.Circle.include(r),e.Rectangle.include({_getRenderCanvasResources:function(){var t=this.getMap(),i=t._prjToViewPoint(this._getPrjCoordinates()),n=this._getRenderSize();return{fn:e.Canvas.rectangle,context:[i,n]}}}),e.Sector.include({_getRenderCanvasResources:function(){var t=this.getMap(),i=this._getPrjCoordinates(),n=t._prjToViewPoint(i),r=this._getRenderSize();return{fn:e.Canvas.sector,context:[n,r.width,[this.getStartAngle(),this.getEndAngle()]]}}}),e.Polyline.include({_arrow:function(t,i,n,r,o){if("classic"===o){var s=this._getInternalSymbol().lineWidth;s||(s=3),s/=2;var a=3*s,h=4*s,l=h/2,u=a/2,c=new e.Point(0,-l),d=new e.Point(e.Util.round(-u),e.Util.round(l)),f=new e.Point(e.Util.round(u),e.Util.round(l)),m=[c,d,f],_=Math.atan2(n.x-i.x,i.y-n.y),g=(new e.Matrix).translate(n.x,n.y).rotate(_),p=g.applyToArray(m);e.Canvas.polygon(t,p,r,r)}},_getRenderCanvasResources:function(){var t=this._getPrjCoordinates(),i=this._prjToViewPoint(t),n=this,r=function(t,i,r,o,s){if(e.Canvas.path(t,i,r,null,s),t.setLineDash&&e.Util.isArrayHasData(s)&&t.setLineDash([]),n.options.arrowStyle&&i.length>=2){var a=n.options.arrowPlacement;if("vertex-first"!==a&&"vertex-firstlast"!==a||n._arrow(t,i[1],i[0],r,n.options.arrowStyle),"vertex-last"!==a&&"vertex-firstlast"!==a||n._arrow(t,i[i.length-2],i[i.length-1],r,n.options.arrowStyle),"point"===a)for(var h=0,l=i.length-1;l>h;h++)n._arrow(t,i[h],i[h+1],r,n.options.arrowStyle)}};return{fn:r,context:[i]}}}),e.Polygon.include({_getRenderCanvasResources:function(){var t=this._getPrjCoordinates(),i=this._prjToViewPoint(t),n=this._getPrjHoles(),r=[];if(e.Util.isArrayHasData(n))for(var o=0;o<n.length;o++){var s=this._prjToViewPoint(n[o]);r.push(s)}var a={fn:e.Canvas.polygon,context:[[i].concat(r)]};return a}})}e.Painter=e.Class.extend({initialize:function(t){this.geometry=t,this.symbolizers=this._createSymbolizers()},getMap:function(){return this.geometry.getMap()},_createSymbolizers:function(){var t=this._getSymbol(),i=[],n=e.Painter.registerSymbolizers,r=t;e.Util.isArray(t)||(r=[t]);for(var o=0;o<r.length;o++)for(var s=r[o],a=n.length-1;a>=0;a--)if(n[a].test(s)){var h=new n[a](s,this.geometry);i.push(h),h instanceof e.symbolizer.PointSymbolizer&&(this._hasPointSymbolizer=!0)}if(0===i.length)throw new Error("no symbolizers can be created to draw, check the validity of the symbol.");return this._debugSymbolizer=new e.symbolizer.DebugSymbolizer(s,this.geometry),i},hasPointSymbolizer:function(){return this._hasPointSymbolizer},getTransformMatrix:function(){return this._matrix?this._matrix:null},_getRenderPoints:function(t){return this._renderPoints||(this._renderPoints={}),t||(t="default"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},_getRenderResources:function(){this._rendResources||(this._rendResources=this.geometry._getRenderCanvasResources());var t,i=this.getTransformMatrix(),n=i?i.container:null,r=i?i.scale:null,o=this.geometry.getLayer()._getRenderer()._viewExtent.getMin(),s=this._rendResources.context,a=[],h=s[0];e.Util.isArray(h)?t=e.Util.mapArrayRecursively(h,function(t){var e=t.substract(o);return n?n.applyToPointInstance(e):e}):h instanceof e.Point&&(t=h.substract(o),n&&(t=n.applyToPointInstance(t))),a.push(t);for(var l=1,u=s.length;u>l;l++)n&&(e.Util.isNumber(s[l])||s[l]instanceof e.Size)?e.Util.isNumber(s[l])?a.push(r.x*s[l]):a.push(new e.Size(s[l].width*r.x,s[l].height*r.y)):a.push(s[l]);var c={fn:this._rendResources.fn,context:a};return c},_getSymbol:function(){return this.geometry._getInternalSymbol()},paint:function(t){var e=this.geometry.getLayer()._getRenderer().getPaintContext();if(e&&this.symbolizers){this._matrix=t;for(var i=e.concat([this]),n=this.symbolizers.length-1;n>=0;n--){var r=this.symbolizers[n];r.symbolize.apply(r,i)}this._painted=!0,this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,i)}},_eachSymbolizer:function(t,e){if(this.symbolizers){e||(e=this);for(var i=this.symbolizers.length-1;i>=0;i--)t.apply(e,[this.symbolizers[i]])}},getViewExtent:function(){if(!this._viewExtent&&this.symbolizers){for(var t=new e.PointExtent,i=this.symbolizers.length-1,n=i;n>=0;n--)t._combine(this.symbolizers[n].getViewExtent());t._round(),this._viewExtent=t}return this._viewExtent},getContainerExtent:function(){var t=this.geometry.getLayer()._getRenderer()._viewExtent.getMin(),i=this.getViewExtent(),n=this.getTransformMatrix(),r=n?n.container:null,o=i.add(t._multi(-1));return r&&(o=new e.PointExtent(r.applyToPointInstance(o.getMin()),r.applyToPointInstance(o.getMax()))),o},setZIndex:function(t){this._eachSymbolizer(function(e){e.setZIndex(t)})},show:function(){if(this._painted)this._removeCache(),this._refreshSymbolizers(),this._eachSymbolizer(function(t){t.show()});else{var t=this.geometry.getLayer();t.isCanvasRender()||this.paint()}this._requestToRender()},hide:function(){this._eachSymbolizer(function(t){t.hide()}),this._requestToRender()},onZoomEnd:function(){this._removeCache(),this._refreshSymbolizers()},repaint:function(){this._removeCache(),this._refreshSymbolizers(),this.geometry.isVisible()&&this._requestToRender()},_refreshSymbolizers:function(){this._eachSymbolizer(function(t){t.refresh()})},_requestToRender:function(){var t=this.geometry,i=t.getMap();if(i&&!i._isBusy()){var n=t.getLayer(),r=n._getRenderer();r&&n instanceof e.VectorLayer&&n.isCanvasRender()&&r.render([t])}},refreshSymbol:function(){if(this._removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers(),this.getMap()&&this.geometry.isVisible()){var t=this.geometry.getLayer();t.isCanvasRender()?this._requestToRender():this.paint()}},remove:function(){this._removeCache(),this._removeSymbolizers()},_removeSymbolizers:function(){this._eachSymbolizer(function(t){t.remove()}),delete this.symbolizers},_removeCache:function(){delete this._renderPoints,delete this._rendResources,delete this._viewExtent}}),e.Painter.registerSymbolizers=[e.symbolizer.StrokeAndFillSymbolizer,e.symbolizer.ImageMarkerSymbolizer,e.symbolizer.VectorMarkerSymbolizer,e.symbolizer.VectorPathMarkerSymbolizer,e.symbolizer.TextMarkerSymbolizer],e.CollectionPainter=e.Class.extend({initialize:function(t){this.geometry=t},_eachPainter:function(t){for(var e,i=this.geometry.getGeometries(),n=0,r=i.length;r>n&&(e=i[n]._getPainter(),!e||!e||t.call(this,e)!==!1);n++);},paint:function(t){this.geometry&&this._eachPainter(function(e){e.paint(t)})},getViewExtent:function(){var t=new e.PointExtent;return this._eachPainter(function(e){t=t.combine(e.getViewExtent())}),t},remove:function(){var t=arguments;this._eachPainter(function(e){e.remove.apply(e,t)})},setZIndex:function(){var t=arguments;this._eachPainter(function(e){e.setZIndex.apply(e,t)})},show:function(){var t=arguments;this._eachPainter(function(e){e.show.apply(e,t)})},hide:function(){var t=arguments;this._eachPainter(function(e){e.hide.apply(e,t)})},onZoomEnd:function(){var t=arguments;this._eachPainter(function(e){e.onZoomEnd.apply(e,t)})},repaint:function(){var t=arguments;this._eachPainter(function(e){e.repaint.apply(e,t)})},refreshSymbol:function(){var t=arguments;this._eachPainter(function(e){e.refreshSymbol.apply(e,t)})},hasPointSymbolizer:function(){var t=!1;return this._eachPainter(function(e){return e.hasPointSymbolizer()?(t=!0,!1):!0}),t}}),e.ui={},e.ui.UIComponent=e.Class.extend({includes:[e.Eventable],options:{eventsToStop:"mousedown dblclick",dx:0,dy:0,autoPan:!1,single:!0},initialize:function(t){e.Util.setOptions(this,t)},addTo:function(t){return this._owner=t,this},getMap:function(){return this._owner instanceof e.Map?this._owner:this._owner.getMap()},show:function(t){if(!t)throw new Error("UI's show coordinate is invalid");this.fire("showstart"),this.__uiDOM||this._switchEvents("on"),this._coordinate=t,this._removePrevDOM();var i=this.__uiDOM=this._createDOM();if(!i)return this.fire("showend"),this;var n=this.getMap(),r=this._getUIContainer();this._measureSize(i),this._singleton()&&(n[this._uiDomKey()]=i);var o=this._getPosition();return i.style.position="absolute",i.style.left=o.x+"px",i.style.top=o.y+"px",i.style.display="",r.appendChild(i),this.options.eventsToStop&&e.DomUtil.on(i,this.options.eventsToStop,e.DomUtil.stopPropagation),this.options.autoPan&&this._autoPan(),this.fire("showend"),this},hide:function(){return this._getDOM()?(this._getDOM().style.display="none",this.fire("hide"),this):this},isVisible:function(){return this._getDOM()&&"none"!==this._getDOM().style.display},remove:function(){return this.hide(),this._switchEvents("off"),delete this._owner,delete this._map,!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),this.fire("remove"),this},getSize:function(){return this._size?this._size.copy():null},getOwner:function(){return this._owner},_getPosition:function(){var t=this.getMap().coordinateToViewPoint(this._coordinate)._add(this.options.dx,this.options.dy);if(this._getDomOffset){var e=this._getDomOffset();e&&t._add(e)}return t},_getDOM:function(){return this.__uiDOM},_autoPan:function(){var t=this.getMap(),i=this._getDOM(),n=new e.Point(parseInt(i.style.left),parseInt(i.style.top)),r=t.getSize(),o=r.width,s=r.height,a=t.viewPointToContainerPoint(n),h=parseInt(i.clientWidth),l=parseInt(i.clientHeight),u=0,c=0;a.x<0?u=-(a.x-h/2):a.x+h-35>o&&(u=o-(a.x+3*h/2)),a.y<0?c=-a.y+50:a.y>s&&(c=s-a.y-l-30),0===c&&0===u||t._panAnimation(new e.Point(u,c),600)},_measureSize:function(t){var i=this._getUIContainer();return t.style.position="absolute",t.style.left="-99999px",t.style.top="-99999px",t.style.display="",i.appendChild(t),this._size=new e.Size(t.clientWidth,t.clientHeight),t.style.display="none",this._size},_removePrevDOM:function(){if(this._onDOMRemove&&this._onDOMRemove(),this._singleton()){var t=this.getMap(),i=this._uiDomKey();t[i]&&(e.DomUtil.removeDomNode(t[i]),delete t[i]),delete this.__uiDOM}else this.__uiDOM&&(e.DomUtil.removeDomNode(this.__uiDOM),delete this.__uiDOM)},_uiDomKey:function(){return"__ui_"+this._getClassName()},_singleton:function(){return this.options.single},_getUIContainer:function(){return this.getMap()._panels.ui},_getClassName:function(){for(var t in e.ui)if(e.ui.hasOwnProperty(t)){if("UIComponent"===t)continue;if(this instanceof e.ui[t])return t}return null},_switchEvents:function(t){var i=this._getDefaultEvents();if(this._getEvents&&e.Util.extend(i,this._getEvents()),i){var n=this.getMap();for(var r in i)i.hasOwnProperty(r)&&n[t](r,i[r],this)}},_getDefaultEvents:function(){return{zooming:this._onZooming,zoomend:this._onZoomEnd}},_onZooming:function(t){if(this.isVisible()&&this._getDOM()){var e=this._getDOM(),i=this.getMap().coordinateToViewPoint(this._coordinate),n=t.matrix.view,r=n.applyToPointInstance(i)._add(this.options.dx,this.options.dy);if(this._getDomOffset){var o=this._getDomOffset();o&&r._add(o)}e.style.left=r.x+"px",e.style.top=r.y+"px"}},_onZoomEnd:function(){if(this.isVisible()&&this._getDOM()){var t=this._getDOM(),e=this._getPosition();t.style.left=e.x+"px",t.style.top=e.y+"px"}}}),e.ui.UIMarker=e.ui.UIComponent.extend({includes:[e.Handlerable],options:{draggable:!1,single:!1,content:null},initialize:function(t,i){this._markerCoord=new e.Coordinate(t),e.Util.setOptions(this,i)},setCoordinates:function(t){return this._markerCoord=t,this.isVisible()&&this.show(),this},getCoordinates:function(){return this._markerCoord},setContent:function(t){return this.options.content=t,this.isVisible()&&this.show(),this},getContent:function(){return this.options.content},show:function(t){return e.ui.UIComponent.prototype.show.call(this,t||this._markerCoord)},_getDomOffset:function(){var t=this.getSize();return new e.Point(-t.width/2,-t.height/2)},_createDOM:function(){var t;return e.Util.isString(this.options.content)?(t=e.DomUtil.createEl("div"),t.innerHTML=this.options.content):t=this.options.content,this._registerDOMEvents(t),t},_onDOMRemove:function(){var t=this._getDOM();this._removeDOMEvents(t)},_domEvents:"mousedown mouseup mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend ",_registerDOMEvents:function(t){e.DomUtil.on(t,this._domEvents,this._onDomEvents,this)},_onDomEvents:function(t){var e=this.getMap()._parseEvent(t,t.type);this.fire(t.type,e)},_removeDOMEvents:function(t){e.DomUtil.off(t,this._domEvents,this._onDomEvents,this)}}),e.ui.UIMarker.Drag=e.Handler.extend({START:e.Browser.touch?["touchstart","mousedown"]:["mousedown"],addHooks:function(){this.target.on(this.START.join(" "),this._startDrag,this)},removeHooks:function(){this.target.off(this.START.join(" "),this._startDrag,this)},_startDrag:function(t){var e=t.domEvent;e.touches&&e.touches.length>1||this.isDragging()||(this.target.on("click",this._endDrag,this),this._preCoordDragged=t.coordinate,this._prepareMap(),this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},_prepareMap:function(){var t=this.target.getMap();this._mapDraggable=t.options.draggable,t.config({draggable:!1})},_prepareDragHandler:function(){var t=this.target.getMap();this._dragHandler=new e.Handler.Drag(t._panels.mapWrapper||t._containerDOM),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},_dragging:function(t){var e=this.target,i=e.getMap(),n=i._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._moved)return this._moved=!0,void(this._isDragging=!0);var o=n.coordinate;this._preCoordDragged||(this._preCoordDragged=o);var s=o.substract(this._preCoordDragged);this._preCoordDragged=o,this.target.setCoordinates(this.target.getCoordinates().add(s)),n.dragOffset=s,e.fire("dragging",n)}},_endDrag:function(t){var i=this.target,n=i.getMap();if(this._dragHandler&&(i.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),n){var r;n&&(r=n._parseEvent(t.domEvent)),delete this._preCoordDragged,e.Util.isNil(this._mapDraggable)&&(this._mapDraggable=!0),n.config({draggable:this._mapDraggable}),delete this._mapDraggable,this._isDragging=!1,i.fire("dragend",r)}},isDragging:function(){return!!this._isDragging}}),e.ui.UIMarker.addInitHook("addHandler","draggable",e.ui.UIMarker.Drag),e.ui.UIMarker.include({isDragging:function(){return this.draggable?this.draggable.isDragging():!1}}),e.ui.InfoWindow=e.ui.UIComponent.extend({options:{autoPan:!0,width:300,minHeight:120,custom:!1,title:null,content:null},setContent:function(t){return this.options.content=t,this.isVisible()&&this.show(this._coordinate),this},getContent:function(){return this.options.content},setTitle:function(t){return this.options.title=t,this.isVisible()&&this.show(this._coordinate),this},getTitle:function(){return this.options.title},_createDOM:function(){var t;if(this.options.custom)return e.Util.isString(this.options.content)?(t=e.DomUtil.createEl("div"),t.innerHTML=this.options.content,
t):this.options.content;t=e.DomUtil.createEl("div"),t.className="maptalks-msgBox",t.style.width=this._getWindowWidth()+"px";var i='<em class="maptalks-ico"></em>';return this.options.title&&(i+="<h2>"+this.options.title+"</h2>"),i+='<a href="javascript:void(0);" onclick="this.parentNode.style.display=\'none\';return false;"  class="maptalks-close"></a><div class="maptalks-msgContent">'+this.options.content+"</div>",t.innerHTML=i,t},_getDomOffset:function(){var t=this.getSize(),i=new e.Point(-t.width/2,-t.height)._add(-4,-12);if(this.getOwner()instanceof e.Marker){var n=this.getOwner().getSize();n&&i._add(0,-n.height)}return i},_getWindowWidth:function(){var t=300,e=this.options.width;return e||(e=t),e}}),function(){var t={eventsToStop:"mousedown dblclick click",autoPan:!1,width:160,custom:!1,items:[]};e.ui.Menu=e.ui.UIComponent.extend({options:t,setItems:function(t){return this.options.items=t,this},getItems:function(){return this.options.items},_createDOM:function(){if(this.options.custom){if(e.Util.isString(this.options.items)){var t=e.DomUtil.createEl("div");return t.innerHTML=this.options.items,t}return this.options.items}var i=e.DomUtil.createEl("div");e.DomUtil.addClass(i,"maptalks-menu"),i.style.width=this._getMenuWidth()+"px";var n=e.DomUtil.createEl("em");e.DomUtil.addClass(n,"maptalks-ico");var r=this._createMenuItemDom();return i.appendChild(n),i.appendChild(r),i},_getDomOffset:function(){return new e.Point(-17,10)},_createMenuItemDom:function(){function t(t){return function(){var e=this._callback({target:i,owner:i._owner,index:t});e!==!1&&i.hide()}}var i=this,n=e.DomUtil.createEl("ul");e.DomUtil.addClass(n,"maptalks-menu-items");for(var r,o,s=this.getItems(),a=0,h=s.length;h>a;a++)r=s[a],"-"===r||"_"===r?(o=e.DomUtil.createEl("li"),e.DomUtil.addClass(o,"maptalks-menu-splitter")):(o=e.DomUtil.createEl("li"),o.innerHTML=r.item,o._callback=r.click,e.DomUtil.on(o,"click",t(a))),n.appendChild(o);return n},_getMenuWidth:function(){var t=160,e=this.options.width;return e||(e=t),e},_getEvents:function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this.hide}}}),e.ui.Menu.Mixin={setMenu:function(i){return this._menuOptions=i,this._menu?e.Util.setOptions(this._menu,e.Util.extend(t,i)):this.on("contextmenu",this._defaultOpenMenu,this),this},openMenu:function(t){var i=this instanceof e.Map?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&i&&(this._bindMenu(this._menuOptions),this._menu.show(t)),this},setMenuItems:function(t){return this._menuOptions&&(e.Util.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t),this._menu&&(e.Util.isArray(t)&&this._menu.config("custom",!1),this._menu.setItems(t)),this},getMenuItems:function(){return this._menu?this._menu.getItems():null},closeMenu:function(){return this._menu&&this._menu.hide(),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this},_bindMenu:function(t){return this._menu=new e.ui.Menu(t),this._menu.addTo(this),this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){this.listens("contextmenu")>1||this.openMenu(t.coordinate)}}}(),e.ui.Toolbox=e.ui.UIComponent.extend({options:{autoPan:!1,style:"maptalks-toolbox",vertical:!1,items:[]},initialize:function(t){e.Util.setOptions(this,t)},setItems:function(t){return this.options.items=t,this},getItems:function(){return this.options.items},getSize:function(){return this._size?this._size.copy():null},_prepareDOM:function(){var t=this._map._panels.toolboxContainer;t.innerHTML="";var i=this._dom=this._createDOM();return e.DomUtil.on(i,"mousedown dblclick",e.DomUtil.stopPropagation),i.style.position="absolute",i.style.left="-99999px",i.style.top="-99999px",t.appendChild(i),this._size=new e.Size(i.clientWidth+6,i.clientHeight),i.style.display="none",this._map._toolbox={target:this},i},_createDOM:function(){var t=e.DomUtil.createEl("div");this.options.style&&e.DomUtil.addClass(t,this.options.style);var i=this.options.items;if(i&&i.length>0){for(var n=0,r=0,o=0,s=i.length;s>o;o++){var a=i[o];if(!a.hidden){a.vertical=e.Util.getValueOrDefault(a.vertical,this.options.vertical);var h=new e.ui.Toolbox.Button(a).getDom();t.appendChild(h),n+=e.Util.getValueOrDefault(a.width,0)+2,r+=e.Util.getValueOrDefault(a.height,0)+2}}this.options.vertical?t.style.height=r+"px":t.style.width=n+"px"}return t},_createMenuItemDom:function(){function t(t){return function(e){var n=this._callback({target:i,index:t});n!==!1&&i.hide()}}var i=this,n=e.DomUtil.createEl("ul");e.DomUtil.addClass(n,"maptalks-menu-items");for(var r=this.getItems(),o=0,s=r.length;s>o;o++){var a,h=r[o];"-"===h||"_"===h?(a=e.DomUtil.createEl("li"),e.DomUtil.addClass(a,"maptalks-menu-splitter")):(a=e.DomUtil.createEl("li"),a.innerHTML=h.item,a._callback=h.click,e.DomUtil.on(a,"click",t(o))),n.appendChild(a)}return n},_getDOM:function(){return this._dom},_getWidth:function(){var t=160,e=this.options.width;return e||(e=t),e},_registerEvents:function(){this._map.on("_zoomstart _zoomend _movestart",this.hide,this)},_removeEvents:function(){this._map.off("_zoomstart _zoomend _movestart",this.hide,this)},_getAnchor:function(t){t||(t=this._target.getCenter());var i=this._map.coordinateToViewPoint(t);return i.add(new e.Point(-17,10))}}),e.ui.Toolbox.Button=e.Class.extend({options:{hidden:!1,icon:"",text:"",click:null,mouseover:null,mouseout:null,children:[]},initialize:function(t){t&&(this._dom=this._createDom(t))},_createDom:function(t){return this._createMenuDom(t)},_createMenuDom:function(t,i){var n=e.DomUtil.createEl("span");i&&(n=e.DomUtil.createEl(i));var r=e.Util.getValueOrDefault(t.width,16),o=e.Util.getValueOrDefault(t.height,16),s=e.Util.getValueOrDefault(t.vertical,!1),a="inline-block";return s&&(a="block"),n.style.cssText="text-align:center;display:-moz-inline-box;display:"+a+";width:"+r+"px;height:"+o+"px;",e.DomUtil.on(n,"click dblclick contextmenu",e.DomUtil.stopPropagation),e.DomUtil.addClass(n,"maptalks-toolbox-button"),n.appendChild(this._createIconDom(t)),t.click&&e.DomUtil.on(n,"click",t.click,this),t.mouseover&&e.DomUtil.on(n,"mouseover",t.mouseover,this),t.mouseout&&e.DomUtil.on(n,"mouseout",t.mouseout,this),n=this._createDropMenu(n,t,i)},_createDropMenu:function(t,i,n){function r(i,n,r){"click"===n?(e.DomUtil.on(t,"click",function(){e.DomUtil.setStyle(i,"display: "+s)},this),e.DomUtil.on(i,"mouseover",function(){e.DomUtil.setStyle(i,"display: "+s)},this)):e.DomUtil.on(t,"mouseover",function(){e.DomUtil.setStyle(i,"display: "+s)},this),e.DomUtil.on(i,"mouseout",function(){e.DomUtil.setStyle(i,"display: none")},this),e.DomUtil.on(t,"mouseout",function(){e.DomUtil.setStyle(i,"display: none")},this)}var o=e.Util.getValueOrDefault(i.vertical,!1),s="block";if(i.children&&i.children.length>0){var a="display: none; position: absolute;",h=e.Util.getValueOrDefault(i.width,20),l=e.Util.getValueOrDefault(i.height,20);a+=o?"left:"+h+"px":"top:"+l+"px";var u=e.DomUtil.createElOn("ul",a),c=i.trigger;r(u,c,n);var d=i.children;if(d&&d.length>0)for(var f=0,m=d.length;m>f;f++){var _=d[f];_.vertical=!e.Util.getValueOrDefault(_.vertical,i.vertical),u.appendChild(this._createMenuDom(_,"li"))}t.appendChild(u)}return t},_createIconDom:function(t){var i=e.DomUtil.createEl("span"),n=t.icon,r=t.item,o=t.title,s=t.html;if(n){var a=e.Util.getValueOrDefault(t.iconWidth,t.width),h=e.Util.getValueOrDefault(t.iconHeight,t.height),l=e.DomUtil.createEl("img");return l.src=n,l.border=0,l.width=a,l.height=h,o&&(l.title=o),i.appendChild(l),r&&(s?"string"==typeof r?i.innerText=r:i.appendChild(r):i.innerText=r),i}e.DomUtil.createEl("span");return r&&("string"==typeof r?i.innerText=r:i.appendChild(r)),s&&i.appendChild(r),i},getDom:function(){return this._dom}}),e.Map.include(e.ui.Menu.Mixin),e.Geometry.include(e.ui.Menu.Mixin),e.Geometry.include({setInfoWindow:function(t){return this._infoWinOptions=e.Util.extend({},t),this._infoWindow?e.Util.setOptions(this._infoWindow,t):this.getMap()&&this._bindInfoWindow(this._infoWinOptions),this},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(this._infoWinOptions),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(t){return this._infoWindow=new e.ui.InfoWindow(t),this._infoWindow.addTo(this),this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),e.control={},e.Control=e.Class.extend({includes:[e.Eventable],statics:{top_left:{top:"20",left:"20"},top_right:{top:"40",right:"60"},bottom_left:{bottom:"20",left:"60"},bottom_right:{bottom:"20",right:"60"}},options:{},initialize:function(t){e.Util.setOptions(this,t)},addTo:function(t){this.remove(),this._map=t;var i=t._panels.control;this.__ctrlContainer=e.DomUtil.createEl("div"),e.DomUtil.setStyle(this.__ctrlContainer,"position:absolute"),e.DomUtil.addStyle(this.__ctrlContainer,"z-index",i.style.zIndex);var n=this.buildOn(t);return n&&(this._updatePosition(),this.__ctrlContainer.appendChild(n),i.appendChild(this.__ctrlContainer)),this.fire("add"),this},getMap:function(){return this._map},getPosition:function(){return e.Util.extend({},this.options.position)},setPosition:function(t){return this.options.position=e.Util.extend({},t),this._updatePosition(),this},getContainerPoint:function(){var t,i,n=this.options.position,r=this._map.getSize();return e.Util.isNil(n.top)?e.Util.isNil(n.bottom)||(t=r.height-n.bottom):t=n.top,e.Util.isNil(n.left)?e.Util.isNil(n.right)||(i=r.width-n.right):i=n.left,new e.Point(t,i)},getContainer:function(){return this.__ctrlContainer},show:function(){return this.__ctrlContainer.style.display="",this},hide:function(){return this.__ctrlContainer.style.display="none",this},isVisible:function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},remove:function(){return this._map?(e.DomUtil.removeDomNode(this.__ctrlContainer),this._onRemove&&this._onRemove(this._map),delete this._map,delete this.__ctrlContainer,this.fire("remove"),this):this},_updatePosition:function(){var t=this.options.position;for(var i in t)t.hasOwnProperty(i)&&(t[i]=parseInt(t[i]),this.__ctrlContainer.style[i]=t[i]+"px");this.fire("positionupdate",{position:e.Util.extend({},this.options.position)})}}),e.Map.include({addControl:function(t){return this._containerDOM.getContext?this:(t.addTo(this),this)},removeControl:function(t){return t.remove(),this}}),e.control.Zoom=e.Control.extend({options:{position:e.Control.top_left,slider:!0,zoomLevel:!0},buildOn:function(t){this._map=t;var i=this.options,n=e.DomUtil.createEl("div","maptalks-zoom");if(i.zoomLevel){var r=e.DomUtil.createEl("span","maptalks-zoom-zoomlevel");n.appendChild(r),this._levelDOM=r}var o=e.DomUtil.createEl("div","maptalks-zoom-slider"),s=e.DomUtil.createEl("a","maptalks-zoom-zoomin");if(s.href="javascript:;",s.innerHTML="+",o.appendChild(s),this._zoomInButton=s,i.slider){var a=e.DomUtil.createEl("div","maptalks-zoom-slider-box"),h=e.DomUtil.createEl("div","maptalks-zoom-slider-ruler"),l=e.DomUtil.createEl("span","maptalks-zoom-slider-reading"),u=e.DomUtil.createEl("span","maptalks-zoom-slider-dot");h.appendChild(l),h.appendChild(u),a.appendChild(h),o.appendChild(a),this._sliderBox=a,this._sliderRuler=h,this._sliderReading=l,this._sliderDot=u}var c=e.DomUtil.createEl("a","maptalks-zoom-zoomout");return c.href="javascript:;",c.innerHTML="-",o.appendChild(c),this._zoomOutButton=c,n.appendChild(o),t.on("_zoomend _zoomstart _viewchange",this._update,this),this._update(),this._registerDomEvents(),n},_update:function(){var t=this._map;if(this._sliderBox){var e=10,i=(t.getMaxZoom()-t.getMinZoom())*e;this._sliderBox.style.height=i+6+"px",this._sliderRuler.style.height=i+"px";var n=(t.getZoom()-t.getMinZoom())*e;this._sliderReading.style.height=n+"px",this._sliderDot.style.bottom=n+"px"}this._levelDOM&&(this._levelDOM.innerHTML=t.getZoom())},_registerDomEvents:function(){var t=this._map;this._zoomInButton&&e.DomUtil.on(this._zoomInButton,"click",t.zoomIn,t),this._zoomOutButton&&e.DomUtil.on(this._zoomOutButton,"click",t.zoomOut,t)},_onRemove:function(){var t=this.getMap();t.off("_zoomend _zoomstart",this._onZoomEnd,this)}}),e.Map.mergeOptions({zoomControl:!1}),e.Map.addOnLoadHook(function(){this.options.zoomControl&&(this.zoomControl=new e.control.Zoom(this.options.zoomControl),this.addControl(this.zoomControl))}),e.control.Attribution=e.Control.extend({options:{position:{bottom:"0",right:"0"},defaultContent:'<a href="http://www.maptalks.org" target="_blank" style="text-decoration:none;cursor: pointer;color: #6490C4; ">Powered By Maptalks</a>'},statics:{"maptalks-control-attribution-bg":"display: inline-block; background-color: #FAF7F5; opacity: 0.8;"},buildOn:function(){return this._attributionContainer=e.DomUtil.createEl("div"),e.DomUtil.setStyle(this._attributionContainer,e.control.Attribution["maptalks-control-attribution-bg"]),this._update(),this._attributionContainer},setContent:function(t){return this.options.content=t,this._update(),this},_update:function(){this._map&&(this._attributionContainer.innerHTML=this.options.content)}}),e.Map.mergeOptions({attributionControl:!1}),e.Map.addOnLoadHook(function(){this.options.attributionControl&&(this.attributionControl=new e.control.Attribution(this.options.attributionControl),this.addControl(this.attributionControl))}),e.control.Nav=e.Control.extend({options:{position:e.Control.top_left},buildOn:function(){return null}}),e.Map.mergeOptions({navControl:!1}),e.Map.addOnLoadHook(function(){this.options.navControl&&(this.navControl=new e.control.Nav(this.options.navControl),this.addControl(this.navControl))}),e.control.Scale=e.Control.extend({options:{position:e.Control.bottom_left,maxWidth:100,metric:!0,imperial:!1},statics:{"maptalks-control-scale":"border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 2px 5px 1px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);"},buildOn:function(t){return this._map=t,this._scaleContainer=e.DomUtil.createEl("div"),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},_onRemove:function(){var t=this.getMap();t.off("zoomend",this._update,this)},_addScales:function(){this.options.metric&&(this._mScale=e.DomUtil.createElOn("div",e.control.Scale["maptalks-control-scale"],this._scaleContainer)),this.options.imperial&&(this._iScale=e.DomUtil.createElOn("div",e.control.Scale["maptalks-control-scale"],this._scaleContainer))},_update:function(){var t=this._map,e=t.pixelToDistance(this.options.maxWidth,0);this._updateScales(e)},_updateScales:function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},_updateMetric:function(t){var e=this._getRoundNum(t),i=1e3>e?e+" m":e/1e3+" km";this._updateScale(this._mScale,i,e/t)},_updateImperial:function(t){var e,i,n,r=3.2808399*t;r>5280?(e=r/5280,i=this._getRoundNum(e),this._updateScale(this._iScale,i+" mile",i/e)):(n=this._getRoundNum(r),this._updateScale(this._iScale,n+" feet",n/r))},_updateScale:function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,e*i}}),e.Map.mergeOptions({scaleControl:!1}),e.Map.addOnLoadHook(function(){this.options.scaleControl&&(this.scaleControl=new e.control.Scale(this.options.scaleControl),this.addControl(this.scaleControl))}),e.control.Panel=e.Control.extend({options:{position:{top:"0",right:"0"},draggable:!0,custom:!1,content:"",closeButton:!0},buildOn:function(){var t;if(this.options.custom)e.Util.isString(this.options.content)?(t=e.DomUtil.createEl("div"),t.innerHTML=this.options.content):t=this.options.content;else{if(t=e.DomUtil.createEl("div","maptalks-panel"),this.options.closeButton){var i=e.DomUtil.createEl("a","maptalks-close");i.href="javascript:;",i.onclick=function(){t.style.display="none"},t.appendChild(i)}var n=e.DomUtil.createEl("div","maptalks-panel-content");n.innerHTML=this.options.content,t.appendChild(n)}return this.draggable=new e.Handler.Drag(t),this.draggable.on("dragstart",this._onDragStart,this),this.draggable.on("dragging",this._onDragging,this),this.draggable.on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},_onDragStart:function(t){this._startPos=t.mousePos,this._startPosition=e.Util.extend({},this.options.position)},_onDragging:function(t){var i=t.mousePos,n=i.substract(this._startPos),r=this._startPosition,o=this.options.position;e.Util.isNil(o.top)||(o.top=r.top+n.y),e.Util.isNil(o.bottom)||(o.bottom=r.bottom-n.y),e.Util.isNil(o.left)||(o.left=r.left+n.x),e.Util.isNil(o.right)||(o.right=r.right-n.x),this._updatePosition()},_onDragEnd:function(){delete this._startPos,delete this._startPosition},_getConnectPoints:function(){var t=this._map,i=this.getContainerPoint(),n=this.getContainer(),r=n.clientWidth,o=n.clientHeight,s=[t.containerPointToCoordinate(i.add(new e.Point(Math.round(r/2),0))),t.containerPointToCoordinate(i.add(new e.Point(r,Math.round(o/2)))),t.containerPointToCoordinate(i.add(new e.Point(Math.round(r/2),o))),t.containerPointToCoordinate(i.add(new e.Point(0,Math.round(o/2))))];return s}}),e.control.Toolbar=e.Control.extend({options:{vertical:!1,position:e.Control.top_right,items:{}},buildOn:function(t){function i(t,i,n,r){var s=o._getItems()[i];return function(o){return e.DomUtil.stopPropagation(o),t({target:s,index:i,childIndex:n,dom:r})}}this._map=t;var n=e.DomUtil.createEl("div"),r=e.DomUtil.createEl("ul","maptalks-toolbar-hx");n.appendChild(r),this.options.vertical?e.DomUtil.addClass(n,"maptalks-toolbar-vertical"):e.DomUtil.addClass(n,"maptalks-toolbar-horizonal");var o=this,s=this.options.items;if(e.Util.isArrayHasData(s))for(var a=0,h=s.length;h>a;a++){var l=s[a],u=e.DomUtil.createEl("li");if(u.innerHTML=l.item,u.style.cursor="pointer",l.click&&e.DomUtil.on(u,"click",i(l.click,a,null,u)),e.Util.isArrayHasData(l.children)){var c=this._createDropMenu(a);u.appendChild(c),u._menu=c,e.DomUtil.on(u,"mouseover",function(){this._menu.style.display=""}),e.DomUtil.on(u,"mouseout",function(){this._menu.style.display="none"})}r.appendChild(u)}return n},_createDropMenu:function(t){function i(t,i,r){var o=n._getItems()[i].children[r];return function(n){return e.DomUtil.stopPropagation(n),t({target:o,index:i,childIndex:r})}}var n=this,r=e.DomUtil.createEl("div","maptalks-dropMenu");r.style.display="none",r.appendChild(e.DomUtil.createEl("em","maptalks-ico"));var o=e.DomUtil.createEl("ul");r.appendChild(o);var s,a,h=this._getItems()[t].children,l=0;for(s=0,a=h.length;a>s;s++){var u=e.StringUtil.stringLength(h[s].item,"12px");u.width>l&&(l=u.width)}for(s=0,a=h.length;a>s;s++){var c=h[s],d=e.DomUtil.createEl("li");d.innerHTML='<a href="javascript:;">'+c.item+"</a>",d.style.cursor="pointer",d.style.width=l+30+"px",e.DomUtil.on(d.childNodes[0],"click",i(c.click,t,s)),o.appendChild(d)}return r},_getItems:function(){return this.options.items}}),e.GeoUtils={distanceToSegment:function(t,e,i){var n=t.x,r=t.y,o=e.x,s=e.y,a=i.x,h=i.y,l=(a-o)*(n-o)+(h-s)*(r-s);if(0>=l)return Math.sqrt((n-o)*(n-o)+(r-s)*(r-s));var u=(a-o)*(a-o)+(h-s)*(h-s);if(l>=u)return Math.sqrt((n-a)*(n-a)+(r-h)*(r-h));var c=l/u,d=o+(a-o)*c,f=s+(h-s)*c;return Math.sqrt((n-d)*(n-d)+(r-f)*(r-f))},pointInsidePolygon:function(t,e){var i,n,r,o,s=e.length,a=!1;for(i=0,n=s-1;s>i;n=i++)r=e[i],o=e[n],r.y>t.y!=o.y>t.y&&t.x<(o.x-r.x)*(t.y-r.y)/(o.y-r.y)+r.x&&(a=!a);return a},computeLength:function(t,e){for(var i=0,n=0,r=t.length;r-1>n;n++)i+=e.measureLength(t[n],t[n+1]);return i},computeArea:function(t,e){return e.measureArea(t)}},e.Simplify={getSqDist:function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},getSqSegDist:function(t,e,i){var n=e.x,r=e.y,o=i.x-n,s=i.y-r;if(0!==o||0!==s){var a=((t.x-n)*o+(t.y-r)*s)/(o*o+s*s);a>1?(n=i.x,r=i.y):a>0&&(n+=o*a,r+=s*a)}return o=t.x-n,s=t.y-r,o*o+s*s},simplifyRadialDist:function(t,e){for(var i,n=t[0],r=[n],o=1,s=t.length;s>o;o++)i=t[o],this.getSqDist(i,n)>e&&(r.push(i),n=i);return n!==i&&r.push(i),r},simplifyDPStep:function(t,e,i,n,r){for(var o,s=n,a=e+1;i>a;a++){var h=this.getSqSegDist(t[a],t[e],t[i]);h>s&&(o=a,s=h)}s>n&&(o-e>1&&this.simplifyDPStep(t,e,o,n,r),r.push(t[o]),i-o>1&&this.simplifyDPStep(t,o,i,n,r))},simplifyDouglasPeucker:function(t,e){var i=t.length-1,n=[t[0]];return this.simplifyDPStep(t,0,i,e,n),n.push(t[i]),n},simplify:function(t,e,i){if(t.length<=2)return t;var n=void 0!==e?e*e:1;return t=i?t:this.simplifyRadialDist(t,n),t=this.simplifyDouglasPeucker(t,n)}},e.node?exports=module.exports=e:"function"==typeof define&&define.amd&&define(e),"undefined"!=typeof window&&t(e)}();